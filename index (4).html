<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stand With Tennessee</title>
    <meta name="description" content="Stand With Tennessee is a hub for supporting, learning, and taking action to support Tennesseans impacted by ICE and federal enforcement.">
    <style>
        /* ============================================
           CSS VARIABLES - THEME SYSTEM
           ============================================ */
        :root {
            /* ===== SITE THEME TOKENS ===== */
            /* Brand Colors */
            --theme-primary: #1a1a1a;
            --theme-secondary: #ffffff;
            --theme-accent: #c8102e;
            --theme-background: #ffffff;
            --theme-surface: #f5f5f5;
            --theme-text: #333333;
            --theme-text-muted: #666666;
            --theme-border: #e5e5e5;
            --theme-link: #c8102e;
            --theme-link-hover: #a00d24;

            /* Color Palette (user-defined) */
            --palette-1: #1a1a1a;
            --palette-2: #ffffff;
            --palette-3: #c8102e;
            --palette-4: #f5f5f5;
            --palette-5: #333333;

            /* Typography */
            --font-heading: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', monospace;

            --text-base-size: 16px;
            --text-scale-ratio: 1.25;

            --text-xs: calc(var(--text-base-size) / var(--text-scale-ratio) / var(--text-scale-ratio));
            --text-sm: calc(var(--text-base-size) / var(--text-scale-ratio));
            --text-md: var(--text-base-size);
            --text-lg: calc(var(--text-base-size) * var(--text-scale-ratio));
            --text-xl: calc(var(--text-base-size) * var(--text-scale-ratio) * var(--text-scale-ratio));
            --text-2xl: calc(var(--text-base-size) * var(--text-scale-ratio) * var(--text-scale-ratio) * var(--text-scale-ratio));
            --text-3xl: calc(var(--text-base-size) * var(--text-scale-ratio) * var(--text-scale-ratio) * var(--text-scale-ratio) * var(--text-scale-ratio));

            --line-height-tight: 1.2;
            --line-height-normal: 1.6;
            --line-height-relaxed: 1.8;

            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Spacing */
            --space-unit: 8px;
            --space-xs: calc(var(--space-unit) * 0.5);
            --space-sm: var(--space-unit);
            --space-md: calc(var(--space-unit) * 2);
            --space-lg: calc(var(--space-unit) * 3);
            --space-xl: calc(var(--space-unit) * 4);
            --space-2xl: calc(var(--space-unit) * 6);
            --space-3xl: calc(var(--space-unit) * 8);

            --section-padding: 4vw;
            --content-max-width: 1200px;
            --content-narrow-width: 800px;

            /* Buttons */
            --btn-padding-x: 1.5rem;
            --btn-padding-y: 0.75rem;
            --btn-border-radius: 0px;
            --btn-border-width: 2px;
            --btn-font-weight: 600;
            --btn-font-size: var(--text-md);
            --btn-text-transform: none;
            --btn-letter-spacing: 0;

            --btn-primary-bg: var(--theme-primary);
            --btn-primary-text: var(--theme-secondary);
            --btn-primary-border: var(--theme-primary);
            --btn-primary-hover-bg: transparent;
            --btn-primary-hover-text: var(--theme-primary);
            --btn-primary-hover-border: var(--theme-primary);

            --btn-secondary-bg: transparent;
            --btn-secondary-text: var(--theme-primary);
            --btn-secondary-border: var(--theme-primary);
            --btn-secondary-hover-bg: var(--theme-primary);
            --btn-secondary-hover-text: var(--theme-secondary);
            --btn-secondary-hover-border: var(--theme-primary);

            /* Header */
            --header-bg: var(--theme-secondary);
            --header-text: var(--theme-primary);
            --header-height: 72px;
            --header-padding: var(--section-padding);
            --header-position: fixed;
            --header-border: 1px solid var(--theme-border);
            --header-shadow: none;

            --nav-gap: 2rem;
            --nav-font-size: var(--text-md);
            --nav-font-weight: 500;
            --nav-link-color: var(--theme-primary);
            --nav-link-hover: var(--theme-accent);

            /* Footer */
            --footer-bg: var(--theme-accent);
            --footer-text: var(--theme-secondary);
            --footer-padding: 3rem var(--section-padding);
            --footer-link-color: inherit;

            /* Sections */
            --section-padding-y: 4rem;
            --section-light-bg: #f5f5f5;
            --section-dark-bg: var(--theme-primary);
            --section-dark-text: var(--theme-secondary);

            /* Effects */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);

            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-full: 9999px;

            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;

            /* ===== LEGACY MAPPINGS ===== */
            --primary-color: var(--theme-primary);
            --secondary-color: var(--theme-secondary);
            --accent-color: var(--theme-accent);
            --text-color: var(--theme-text);
            --border-color: var(--theme-border);

            /* Admin colors (not theme-able) */
            --navy: #1C2541;
            --navy-light: #2d3a5c;
            --orange: #FF8200;
            --gold: #FFC72C;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --green: #10b981;
            --red: #ef4444;
            --blue: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
        }

        /* ============================================
           PUBLIC SITE STYLES
           ============================================ */
        #public-site {
            display: block;
        }

        #public-site.hidden {
            display: none;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--header-bg);
            padding: 1rem var(--section-padding);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: var(--header-border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--header-text);
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: var(--nav-gap);
            align-items: center;
        }

        .nav a {
            color: var(--nav-link-color);
            text-decoration: none;
            font-weight: var(--nav-font-weight);
        }

        .section {
            padding: 4rem var(--section-padding);
        }

        .section-hero {
            padding-top: 120px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .section-dark {
            background: var(--section-dark-bg);
            color: var(--section-dark-text);
        }

        .section-light {
            background: var(--section-light-bg);
        }

        .public-btn {
            display: inline-block;
            padding: var(--btn-padding-y) var(--btn-padding-x);
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            text-decoration: none;
            border: var(--btn-border-width) solid var(--btn-primary-border);
            border-radius: var(--btn-border-radius);
            font-weight: var(--btn-font-weight);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .public-btn:hover {
            background: var(--btn-primary-hover-bg);
            color: var(--btn-primary-hover-text);
            border-color: var(--btn-primary-hover-border);
        }

        h1 { font-size: 2.5rem; margin-bottom: 1.5rem; max-width: 900px; }
        h2 { font-size: 2rem; margin-bottom: 1rem; }
        p { margin-bottom: 1rem; max-width: 800px; }

        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Accordion */
        .accordion { border-top: 1px solid currentColor; }
        .accordion-item { border-bottom: 1px solid currentColor; }
        .accordion-header {
            padding: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .accordion-icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .accordion-item.active .accordion-icon {
            transform: rotate(45deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content-inner { padding-bottom: 1.5rem; }
        .accordion-content ul { list-style: disc; margin-left: 1.5rem; }
        .accordion-content li { margin-bottom: 0.75rem; }
        .accordion-content a { color: inherit; font-weight: 600; }

        .footer {
            background: var(--footer-bg);
            color: var(--footer-text);
            padding: var(--footer-padding);
            text-align: center;
        }
        .footer a { color: var(--footer-link-color); }

        /* ============================================
           ADMIN DASHBOARD STYLES
           ============================================ */
        #admin-dashboard {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            background: var(--gray-100);
        }

        #admin-dashboard.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--navy);
            color: white;
            padding: 20px 0;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--navy-light);
            margin-bottom: 20px;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 4px;
        }

        .sidebar-header span {
            font-size: 12px;
            color: var(--gray-400);
        }

        .nav-section {
            padding: 0 12px;
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            padding: 0 8px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--gray-300);
            transition: all 0.15s;
        }

        .nav-item:hover {
            background: var(--navy-light);
            color: white;
        }

        .nav-item.active {
            background: var(--orange);
            color: white;
        }

        .nav-item .icon { width: 18px; text-align: center; }

        .nav-item .badge {
            margin-left: auto;
            background: var(--red);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .topbar h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
        }

        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--orange);
            color: white;
        }

        .btn-primary:hover { background: #e67400; }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover { background: var(--gray-50); }

        .btn-sm { padding: 6px 12px; font-size: 13px; }

        .btn-approve { background: var(--green); color: white; }
        .btn-reject { background: var(--red); color: white; }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            margin-bottom: 16px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h3 { font-size: 16px; font-weight: 600; }

        .card-body { padding: 20px; }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-grid.single { grid-template-columns: 1fr; }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width { grid-column: 1 / -1; }

        .form-group label {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-group label .required { color: var(--red); }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.15s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 130, 0, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group .hint {
            font-size: 12px;
            color: var(--gray-500);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--gray-100);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .checkbox-item:hover { background: var(--gray-200); }
        .checkbox-item.selected { background: var(--navy); color: white; }
        .checkbox-item input { display: none; }

        /* Table */
        .table-wrapper { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            background: var(--gray-50);
        }

        td { font-size: 14px; }

        tr:hover td { background: var(--gray-50); }

        /* Status badges */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-verified { background: #d1fae5; color: #065f46; }
        .status-verified .status-dot { background: var(--green); }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-pending .status-dot { background: #f59e0b; }

        .status-draft { background: var(--gray-200); color: var(--gray-600); }
        .status-draft .status-dot { background: var(--gray-400); }

        .status-active { background: #d1fae5; color: #065f46; }
        .status-active .status-dot { background: var(--green); }

        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-rejected .status-dot { background: var(--red); }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            padding: 20px;
        }

        .stat-card .label {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 600;
            color: var(--navy);
        }

        /* Alert box */
        .alert {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
        }

        .alert-icon { font-size: 20px; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 4px; }
        .alert-text { font-size: 14px; color: var(--gray-600); }

        /* Review queue */
        .review-item {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .review-item-header {
            padding: 16px 20px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-200);
        }

        .review-item-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
            color: var(--gray-500);
        }

        .review-item-body { padding: 20px; }

        .review-item-data {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 8px 16px;
            font-size: 14px;
        }

        .review-item-data dt { color: var(--gray-500); font-weight: 500; }
        .review-item-data dd { color: var(--gray-800); }

        .review-item-actions {
            padding: 16px 20px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
        }

        /* Hidden admin sections */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Filters bar */
        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11000;
        }

        .modal-overlay.hidden { display: none; }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 { font-size: 18px; font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-400);
        }

        .modal-body { padding: 24px; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .section-divider {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 16px 0 12px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
            margin-top: 12px;
        }

        /* Loading/Empty states */
        .loading, .empty {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
        }

        /* Login Modal */
        .login-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }

        .login-backdrop.active { display: block; }

        .login-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            z-index: 10001;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .login-modal.active { display: block; }
        .login-modal h3 { margin-bottom: 1rem; }
        .login-modal input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Preview Modal */
        .preview-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 12000;
            display: none;
        }

        .preview-modal-overlay.active {
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            background: var(--navy);
            color: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .preview-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .preview-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .preview-badge {
            background: var(--orange);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .preview-toggle-group {
            display: flex;
            background: var(--navy-light);
            border-radius: 6px;
            padding: 2px;
        }

        .preview-toggle-btn {
            padding: 6px 16px;
            border: none;
            background: transparent;
            color: var(--gray-300);
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .preview-toggle-btn.active {
            background: var(--orange);
            color: white;
        }

        .preview-toggle-btn:hover:not(.active) {
            color: white;
        }

        .preview-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0 8px;
        }

        .preview-close-btn:hover {
            color: var(--gold);
        }

        .preview-iframe-container {
            flex: 1;
            background: white;
            overflow: hidden;
            position: relative;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .preview-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, var(--orange), var(--gold));
            color: var(--navy);
            text-align: center;
            padding: 8px;
            font-weight: 600;
            font-size: 13px;
            z-index: 100;
        }

        .preview-draft-badge {
            display: inline-block;
            background: var(--orange);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* ============================================
           WYSIWYG EDIT MODE STYLES
           ============================================ */

        /* Edit mode toolbar - floating at top */
        .edit-toolbar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--navy) 0%, #2d3a5c 100%);
            color: white;
            padding: 12px 24px;
            z-index: 9999;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            align-items: center;
            justify-content: space-between;
        }

        .edit-toolbar.active {
            display: flex;
        }

        .edit-toolbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .edit-toolbar-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--gold);
        }

        .edit-toolbar-status {
            font-size: 12px;
            color: var(--gray-300);
            padding: 4px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }

        .edit-toolbar-actions {
            display: flex;
            gap: 8px;
        }

        .edit-toolbar .btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Shift header down when edit mode is active */
        body.edit-mode .header {
            top: 52px;
        }

        body.edit-mode .section-hero {
            padding-top: 172px;
        }

        /* Editable elements highlighting */
        body.edit-mode [data-editable] {
            outline: 2px dashed transparent;
            outline-offset: 4px;
            transition: all 0.15s ease;
            cursor: text;
            position: relative;
        }

        body.edit-mode [data-editable]:hover {
            outline-color: var(--orange);
            background: rgba(255, 130, 0, 0.08);
        }

        body.edit-mode [data-editable]:focus {
            outline-color: var(--orange);
            outline-style: solid;
            background: rgba(255, 130, 0, 0.12);
        }

        body.edit-mode [data-editable][data-editable-attr]:hover::after {
            content: 'Click to edit link';
            position: absolute;
            top: -24px;
            left: 0;
            background: var(--navy);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Editable item cards (orgs/campaigns) */
        body.edit-mode .editable-item {
            position: relative;
            padding-right: 100px;
        }

        body.edit-mode .editable-item:hover {
            background: rgba(255, 130, 0, 0.08);
        }

        .item-edit-btn {
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--orange);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .item-edit-btn:hover {
            background: #e67400;
        }

        body.edit-mode .item-edit-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Add new item buttons */
        .add-item-btn {
            display: none;
            margin-top: 16px;
            padding: 12px 20px;
            background: transparent;
            border: 2px dashed var(--gray-400);
            color: var(--gray-500);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
            width: 100%;
            text-align: center;
        }

        .add-item-btn:hover {
            border-color: var(--orange);
            color: var(--orange);
            background: rgba(255, 130, 0, 0.05);
        }

        body.edit-mode .add-item-btn {
            display: block;
        }

        /* Section edit mode styling */
        body.edit-mode .section {
            position: relative;
        }

        body.edit-mode .section::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 1px dashed rgba(255, 130, 0, 0.3);
            border-radius: 8px;
            pointer-events: none;
        }

        /* Edit mode side panel */
        .edit-panel {
            display: none;
            position: fixed;
            right: 0;
            top: 52px;
            bottom: 0;
            width: 320px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 9998;
            overflow-y: auto;
        }

        .edit-panel.active {
            display: block;
        }

        .edit-panel-header {
            padding: 16px 20px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .edit-panel-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .edit-panel-body {
            padding: 20px;
        }

        .edit-panel-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .edit-panel-nav-btn {
            padding: 8px 14px;
            background: var(--gray-100);
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .edit-panel-nav-btn:hover {
            background: var(--gray-200);
        }

        .edit-panel-nav-btn.active {
            background: var(--navy);
            color: white;
        }

        .edit-panel-section {
            display: none;
        }

        .edit-panel-section.active {
            display: block;
        }

        /* Shift main content when panel is open */
        body.edit-mode.panel-open #public-site {
            margin-right: 320px;
            transition: margin-right 0.2s ease;
        }

        /* Quick edit popup for links */
        .link-edit-popup {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 12px;
            z-index: 10000;
            min-width: 280px;
        }

        .link-edit-popup.active {
            display: block;
        }

        .link-edit-popup input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .link-edit-popup-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Draft/Preview badges in edit mode */
        .edit-badge {
            display: none;
            background: var(--orange);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        body.edit-mode .edit-badge {
            display: inline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav { display: none; }
            h1 { font-size: 1.75rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .sidebar { width: 200px; }
            .edit-panel { width: 100%; }
            body.edit-mode.panel-open #public-site { margin-right: 0; }
        }

        /* ============================================
           CONTENT EDITOR STYLES (integrated)
           ============================================ */
        #content-editor-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 15000;
            background: var(--gray-100);
        }

        #content-editor-view.active {
            display: flex;
        }

        /* Main Layout */
        .ce-editor-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Preview Panel (Left Side) */
        .ce-preview-panel {
            flex: 1;
            background: white;
            border-right: 1px solid var(--gray-300);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .ce-preview-header {
            padding: 12px 16px;
            background: var(--navy);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .ce-preview-header h2 {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .ce-preview-controls {
            display: flex;
            gap: 8px;
        }

        .ce-preview-controls button {
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .ce-preview-controls button:hover {
            background: rgba(255,255,255,0.1);
        }

        .ce-preview-controls button.active {
            background: var(--orange);
            border-color: var(--orange);
        }

        .ce-preview-frame {
            flex: 1;
            overflow: auto;
            background: var(--gray-200);
            padding: 24px;
        }

        .ce-preview-content {
            transform-origin: top left;
            min-height: 100%;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Preview header styles */
        .ce-preview-content .preview-header {
            position: sticky;
            top: 0;
            background: var(--header-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: var(--header-border);
        }

        .ce-preview-content .preview-header .logo {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--header-text);
            text-decoration: none;
        }

        .ce-preview-content .preview-header .nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .ce-preview-content .preview-header .nav a {
            color: var(--header-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .ce-preview-content .preview-header .nav .public-btn {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            padding: 0.5rem 1rem;
            border-radius: var(--btn-border-radius);
            font-size: 0.85rem;
        }

        /* CMS Panel (Right Side) */
        .ce-cms-panel {
            width: 480px;
            background: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-left: 1px solid var(--gray-200);
        }

        .ce-cms-header {
            padding: 16px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ce-cms-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .ce-cms-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .ce-cms-tab {
            padding: 12px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .ce-cms-tab:hover {
            color: var(--gray-800);
        }

        .ce-cms-tab.active {
            color: var(--orange);
            border-bottom-color: var(--orange);
            background: white;
        }

        .ce-cms-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .ce-cms-section {
            display: none;
        }

        .ce-cms-section.active {
            display: block;
        }

        /* Content Type Cards */
        .ce-content-type-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ce-content-type-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ce-content-type-card:hover {
            border-color: var(--orange);
            background: white;
        }

        .ce-content-type-card.active {
            border-color: var(--orange);
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 130, 0, 0.1);
        }

        .ce-content-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ce-content-type-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-800);
        }

        .ce-content-type-count {
            font-size: 12px;
            color: var(--gray-500);
            background: var(--gray-200);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .ce-content-type-desc {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Data Table for Content Editor */
        .ce-data-table-container {
            margin-top: 16px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }

        .ce-data-table-header {
            padding: 12px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ce-data-table-title {
            font-weight: 600;
            font-size: 14px;
        }

        .ce-data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ce-data-table th,
        .ce-data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            font-size: 13px;
        }

        .ce-data-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-600);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ce-data-table tr:hover td {
            background: var(--gray-50);
        }

        .ce-data-table tr:last-child td {
            border-bottom: none;
        }

        .ce-table-actions {
            display: flex;
            gap: 4px;
        }

        .ce-table-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            color: var(--gray-500);
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .ce-table-btn:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .ce-table-btn.edit:hover { color: var(--blue); }
        .ce-table-btn.delete:hover { color: var(--red); }

        /* Status badges for CE */
        .ce-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .ce-status-badge.published { background: #d1fae5; color: #065f46; }
        .ce-status-badge.draft { background: var(--gray-200); color: var(--gray-600); }
        .ce-status-badge.verified { background: #d1fae5; color: #065f46; }
        .ce-status-badge.pending { background: #fef3c7; color: #92400e; }
        .ce-status-badge.active { background: #d1fae5; color: #065f46; }

        /* Block Editor */
        .ce-block-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ce-block-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.15s;
        }

        .ce-block-item:hover {
            border-color: var(--gray-300);
        }

        .ce-block-item.dragging {
            opacity: 0.5;
            border-color: var(--orange);
        }

        .ce-block-item.drag-over {
            border-color: var(--orange);
            box-shadow: 0 0 0 2px rgba(255, 130, 0, 0.2);
        }

        .ce-block-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            cursor: move;
        }

        .ce-block-drag-handle {
            color: var(--gray-400);
            margin-right: 10px;
            cursor: move;
        }

        .ce-block-type-icon {
            width: 24px;
            height: 24px;
            background: var(--gray-200);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
        }

        .ce-block-type-name {
            font-weight: 500;
            font-size: 13px;
            flex: 1;
        }

        .ce-block-actions {
            display: flex;
            gap: 4px;
        }

        .ce-block-content {
            padding: 12px;
        }

        /* Form elements for CE */
        .ce-form-group {
            margin-bottom: 16px;
        }

        .ce-form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .ce-form-group input,
        .ce-form-group select,
        .ce-form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
        }

        .ce-form-group input:focus,
        .ce-form-group select:focus,
        .ce-form-group textarea:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 130, 0, 0.1);
        }

        .ce-form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .ce-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Section Editor (inline) */
        .ce-section-editor {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-top: 16px;
        }

        .ce-section-editor-header {
            padding: 12px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ce-section-editor-header h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .ce-section-editor-body {
            padding: 16px;
        }

        /* Empty state for CE */
        .ce-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }

        .ce-empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .ce-empty-state h3 {
            font-size: 16px;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .ce-empty-state p {
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* Preview site styles (embedded in CE) */
        .ce-preview-site {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .ce-preview-site .section {
            padding: 4rem 4vw;
        }

        .ce-preview-site .section-hero {
            padding-top: 80px;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .ce-preview-site .section-dark {
            background: var(--section-dark-bg);
            color: var(--section-dark-text);
        }

        .ce-preview-site .section-light {
            background: var(--section-light-bg);
        }

        .ce-preview-site .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .ce-preview-site h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .ce-preview-site h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .ce-preview-site p {
            margin-bottom: 1rem;
            max-width: 800px;
        }

        .ce-preview-site .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .ce-preview-site .public-btn {
            display: inline-block;
            padding: var(--btn-padding-y) var(--btn-padding-x);
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            text-decoration: none;
            border: var(--btn-border-width) solid var(--btn-primary-border);
            border-radius: var(--btn-border-radius);
            font-weight: var(--btn-font-weight);
        }

        .ce-preview-site .section-dark .public-btn {
            background: var(--theme-secondary);
            color: var(--theme-primary);
            border-color: var(--theme-secondary);
        }

        .ce-preview-site .accordion {
            border-top: 1px solid currentColor;
        }

        .ce-preview-site .accordion-item {
            border-bottom: 1px solid currentColor;
        }

        .ce-preview-site .accordion-header {
            padding: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ce-preview-site .accordion-content {
            padding-bottom: 1rem;
        }

        .ce-preview-site .accordion-content ul {
            list-style: disc;
            margin-left: 1.5rem;
        }

        .ce-preview-site .accordion-content li {
            margin-bottom: 0.5rem;
        }

        .ce-preview-site .accordion-content a {
            color: inherit;
            font-weight: 600;
        }

        /* Editable highlight in preview */
        .ce-preview-site [data-block-id] {
            position: relative;
            transition: outline 0.15s;
        }

        .ce-preview-site [data-block-id]:hover {
            outline: 2px dashed var(--orange);
            outline-offset: 4px;
        }

        .ce-preview-site [data-block-id].selected {
            outline: 2px solid var(--orange);
            outline-offset: 4px;
        }

        /* Add block buttons */
        .ce-add-block-area {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ce-add-block-area:hover {
            border-color: var(--orange);
            background: rgba(255, 130, 0, 0.05);
        }

        .ce-add-block-menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .ce-add-block-option {
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
        }

        .ce-add-block-option:hover {
            border-color: var(--orange);
            background: var(--gray-50);
        }

        .ce-add-block-option-name {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .ce-add-block-option-desc {
            font-size: 11px;
            color: var(--gray-500);
        }

        /* Notification toast for CE */
        .ce-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--gray-800);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 20000;
            opacity: 0;
            transition: all 0.3s;
        }

        .ce-toast.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .ce-toast.success { background: var(--green); }
        .ce-toast.error { background: var(--red); }

        /* ============================================
           STYLE MANAGER STYLES
           ============================================ */

        /* Style Manager Panel */
        .sm-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sm-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: white;
            flex-shrink: 0;
        }

        .sm-header h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .sm-header p {
            font-size: 11px;
            opacity: 0.7;
            margin: 0;
        }

        .sm-save-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .sm-save-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
        }

        .sm-save-indicator.unsaved .dot {
            background: var(--orange);
        }

        .sm-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        /* Accordion Sections */
        .sm-accordion {
            border-bottom: 1px solid var(--gray-200);
        }

        .sm-accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            background: var(--gray-50);
            border: none;
            width: 100%;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            transition: background 0.15s;
        }

        .sm-accordion-header:hover {
            background: var(--gray-100);
        }

        .sm-accordion-header .icon {
            font-size: 10px;
            transition: transform 0.2s;
            color: var(--gray-400);
        }

        .sm-accordion.open .sm-accordion-header .icon {
            transform: rotate(90deg);
        }

        .sm-accordion-header .title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sm-accordion-header .emoji {
            font-size: 14px;
        }

        .sm-accordion-body {
            display: none;
            padding: 16px;
            background: white;
        }

        .sm-accordion.open .sm-accordion-body {
            display: block;
        }

        /* Form Controls */
        .sm-form-group {
            margin-bottom: 16px;
        }

        .sm-form-group:last-child {
            margin-bottom: 0;
        }

        .sm-form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 6px;
        }

        .sm-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .sm-form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        /* Color Input */
        .sm-color-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: white;
        }

        .sm-color-input input[type="color"] {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
            background: none;
        }

        .sm-color-input input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .sm-color-input input[type="color"]::-webkit-color-swatch {
            border: 1px solid var(--gray-300);
            border-radius: 4px;
        }

        .sm-color-input input[type="text"] {
            flex: 1;
            border: none;
            font-size: 12px;
            font-family: var(--font-mono);
            text-transform: uppercase;
            background: none;
            padding: 0;
        }

        .sm-color-input input[type="text"]:focus {
            outline: none;
        }

        /* Color Palette */
        .sm-color-palette {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sm-color-swatch {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
        }

        .sm-color-swatch:hover {
            transform: scale(1.1);
        }

        .sm-color-swatch.active {
            border-color: var(--navy);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--navy);
        }

        .sm-color-swatch .edit-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--gray-700);
            color: white;
            font-size: 10px;
            border: 2px solid white;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .sm-color-swatch:hover .edit-btn {
            display: flex;
        }

        /* Text/Number Input */
        .sm-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.15s;
        }

        .sm-input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 130, 0, 0.1);
        }

        .sm-input-with-unit {
            display: flex;
            align-items: stretch;
        }

        .sm-input-with-unit input {
            flex: 1;
            border-radius: 6px 0 0 6px;
            border-right: none;
        }

        .sm-input-with-unit .unit {
            padding: 0 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 0 6px 6px 0;
            font-size: 12px;
            color: var(--gray-500);
            display: flex;
            align-items: center;
        }

        /* Select */
        .sm-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .sm-select:focus {
            outline: none;
            border-color: var(--orange);
        }

        /* Range Slider */
        .sm-range-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sm-range {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--gray-200);
        }

        .sm-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--orange);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .sm-range-value {
            min-width: 48px;
            text-align: right;
            font-size: 12px;
            color: var(--gray-600);
            font-family: var(--font-mono);
        }

        /* Button Shape Selector */
        .sm-shape-selector {
            display: flex;
            gap: 8px;
        }

        .sm-shape-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .sm-shape-option:hover {
            border-color: var(--gray-300);
        }

        .sm-shape-option.active {
            border-color: var(--orange);
            background: rgba(255, 130, 0, 0.05);
        }

        .sm-shape-option .preview {
            width: 100%;
            height: 32px;
            background: var(--gray-300);
            margin-bottom: 6px;
        }

        .sm-shape-option .preview.square { border-radius: 0; }
        .sm-shape-option .preview.rounded { border-radius: 6px; }
        .sm-shape-option .preview.pill { border-radius: 16px; }

        .sm-shape-option .label {
            font-size: 10px;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        /* Font Selector */
        .sm-font-preview {
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-top: 8px;
            background: var(--gray-50);
        }

        .sm-font-preview .sample {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .sm-font-preview .details {
            font-size: 11px;
            color: var(--gray-500);
        }

        /* Spacing Visual */
        .sm-spacing-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .sm-spacing-box {
            width: 80px;
            height: 60px;
            background: var(--gray-300);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--gray-600);
        }

        /* Toggle Switch */
        .sm-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .sm-toggle-label {
            font-size: 13px;
            color: var(--gray-700);
        }

        .sm-toggle-switch {
            width: 40px;
            height: 22px;
            background: var(--gray-300);
            border-radius: 11px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sm-toggle-switch.active {
            background: var(--green);
        }

        .sm-toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .sm-toggle-switch.active::after {
            transform: translateX(18px);
        }

        /* Section Divider */
        .sm-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 16px 0;
        }

        .sm-section-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        /* Theme Presets */
        .sm-preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .sm-preset-card {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .sm-preset-card:hover {
            border-color: var(--gray-300);
        }

        .sm-preset-card.active {
            border-color: var(--orange);
        }

        .sm-preset-preview {
            height: 40px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            overflow: hidden;
        }

        .sm-preset-preview > div {
            flex: 1;
        }

        .sm-preset-name {
            font-size: 10px;
            text-align: center;
            color: var(--gray-600);
        }

        /* Responsive Preview Buttons */
        .sm-preview-devices {
            display: flex;
            gap: 4px;
            background: var(--gray-100);
            padding: 4px;
            border-radius: 6px;
        }

        .sm-device-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: var(--gray-500);
            transition: all 0.15s;
        }

        .sm-device-btn:hover {
            background: var(--gray-200);
        }

        .sm-device-btn.active {
            background: white;
            color: var(--gray-800);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* CE Modal */
        .ce-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }

        .ce-modal-backdrop.active {
            display: flex;
        }

        .ce-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ce-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ce-modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .ce-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-400);
            padding: 0;
            line-height: 1;
        }

        .ce-modal-close:hover {
            color: var(--gray-600);
        }

        .ce-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .ce-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Color Picker Modal */
        .color-picker-modal {
            background: white;
            border-radius: 12px;
            width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .color-picker-modal .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .color-picker-modal .modal-header h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            color: var(--gray-800);
        }

        .color-picker-modal .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-400);
            padding: 0;
            line-height: 1;
        }

        .color-picker-modal .modal-close:hover {
            color: var(--gray-600);
        }

        .color-picker-modal .modal-body {
            padding: 20px;
        }

        .color-picker-preview {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--gray-200);
        }

        .color-picker-native {
            width: 100%;
            height: 48px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .color-picker-native::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker-native::-webkit-color-swatch {
            border: 1px solid var(--gray-300);
            border-radius: 8px;
        }

        .color-picker-hex-input {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .color-picker-hex-input input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 14px;
            text-transform: uppercase;
        }

        .color-picker-hex-input input:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }

        .color-picker-presets {
            margin-bottom: 16px;
        }

        .color-picker-presets-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .color-picker-presets-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
        }

        .color-preset {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .color-preset:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .color-picker-modal .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .color-picker-modal .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .color-picker-modal .btn-secondary {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .color-picker-modal .btn-secondary:hover {
            background: var(--gray-50);
        }

        .color-picker-modal .btn-primary {
            background: var(--navy);
            border: 1px solid var(--navy);
            color: white;
        }

        .color-picker-modal .btn-primary:hover {
            background: var(--gray-800);
        }

        /* Rich Text Editor for CE */
        .ce-rich-text-editor {
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            overflow: hidden;
        }

        .ce-rich-text-toolbar {
            display: flex;
            gap: 2px;
            padding: 8px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            flex-wrap: wrap;
        }

        .ce-rich-text-btn {
            padding: 6px 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .ce-rich-text-btn:hover {
            background: var(--gray-200);
        }

        .ce-rich-text-btn.active {
            background: var(--gray-300);
            color: var(--gray-800);
        }

        .ce-rich-text-content {
            min-height: 120px;
            padding: 12px;
            outline: none;
        }

        .ce-rich-text-content:focus {
            background: var(--gray-50);
        }

        @media (max-width: 768px) {
            .ce-cms-panel { width: 100%; }
            .ce-editor-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- ============================================
         WYSIWYG EDIT MODE TOOLBAR
         ============================================ -->
    <div class="edit-toolbar" id="edit-toolbar">
        <div class="edit-toolbar-left">
            <span class="edit-toolbar-title">Edit Mode</span>
            <span class="edit-toolbar-status" id="edit-status">Click any text to edit</span>
        </div>
        <div class="edit-toolbar-actions">
            <button class="btn btn-secondary" onclick="toggleEditPanel()">
                <span id="panel-toggle-text">Open Panel</span>
            </button>
            <button class="btn btn-secondary" onclick="openContentEditor()">Content Editor</button>
            <button class="btn btn-secondary" onclick="openDataManager()">Manage Data</button>
            <button class="btn btn-primary" onclick="saveAllChanges()">Save Changes</button>
            <button class="btn btn-secondary" onclick="exitEditMode()">Exit</button>
        </div>
    </div>

    <!-- Edit Mode Side Panel -->
    <div class="edit-panel" id="edit-panel">
        <div class="edit-panel-header">
            <h3>Quick Actions</h3>
        </div>
        <div class="edit-panel-body">
            <div class="edit-panel-nav">
                <button class="edit-panel-nav-btn active" onclick="showPanelSection('add')">Add New</button>
                <button class="edit-panel-nav-btn" onclick="showPanelSection('all')">All Items</button>
                <button class="edit-panel-nav-btn" onclick="showPanelSection('drafts')">Drafts</button>
            </div>

            <div id="panel-add" class="edit-panel-section active">
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 12px;" onclick="openModal('org-modal')">
                    + Add Organization
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 12px;" onclick="openModal('campaign-modal')">
                    + Add Campaign
                </button>
            </div>

            <div id="panel-all" class="edit-panel-section">
                <h4 style="font-size: 13px; color: var(--gray-600); margin-bottom: 12px;">Organizations</h4>
                <div id="panel-orgs-list"></div>
                <h4 style="font-size: 13px; color: var(--gray-600); margin: 16px 0 12px;">Campaigns</h4>
                <div id="panel-campaigns-list"></div>
            </div>

            <div id="panel-drafts" class="edit-panel-section">
                <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 12px;">Items not yet published:</p>
                <div id="panel-drafts-list"></div>
            </div>
        </div>
    </div>

    <!-- Link Edit Popup -->
    <div class="link-edit-popup" id="link-edit-popup">
        <label style="font-size: 12px; color: var(--gray-600); display: block; margin-bottom: 4px;">Edit URL:</label>
        <input type="url" id="link-edit-input" placeholder="https://...">
        <div class="link-edit-popup-actions">
            <button class="btn btn-sm btn-secondary" onclick="closeLinkPopup()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="saveLinkEdit()">Save</button>
        </div>
    </div>

    <!-- ============================================
         PUBLIC SITE
         ============================================ -->
    <div id="public-site">
        <header class="header">
            <a href="#" class="logo">
                <span data-editable="siteName">Stand With Tennessee</span>
            </a>
            <nav class="nav">
                <a href="#mutualaid">Mutual Aid</a>
                <a href="#crowdfunding">Crowdfunding</a>
                <a href="#orgs">Organizations</a>
                <a href="#secure-messaging">Connect</a>
                <a href="#" class="public-btn" data-editable="donateUrl" data-editable-attr="href">Donate</a>
            </nav>
        </header>

        <section class="section section-hero" id="hero">
            <div class="content-wrapper">
                <h1 data-editable="heroTitle">Tennessee is under occupation by federal agents from ICE and CBP, and we need your support.</h1>
                <p data-editable="heroDescription">Across Tennessee, ICE continues to stop, harass, and detain people regardless of their citizenship status. Normal life in Tennessee has been interrupted, as schools have been forced to close or go virtual, as people live in fear of leaving their homes or going to work.</p>
                <div class="button-group">
                    <a href="#" class="public-btn" data-editable="featuredButton1Url" data-editable-attr="href">
                        <span data-editable="featuredButton1Text">Featured GoFundMe</span>
                    </a>
                    <a href="#mutualaid" class="public-btn">Mutual Aid</a>
                    <a href="#orgs" class="public-btn">Organizations</a>
                </div>
            </div>
        </section>

        <!-- Featured Content from API - displays content with images -->
        <section class="section section-light" id="featured" style="display: none;">
            <div class="content-wrapper" id="featured-content">
                <!-- Content dynamically loaded from API by renderFeaturedContent() -->
            </div>
        </section>

        <section class="section section-dark" id="mutualaid">
            <div class="content-wrapper">
                <h2 data-editable="mutualAidTitle">Mutual Aid & Materials</h2>
                <p data-editable="mutualAidDescription">These funds are administered by neighbors helping their neighbors. One of the most direct ways to help.</p>
                <div class="accordion" id="mutualaid-accordion"></div>
            </div>
        </section>

        <section class="section section-light" id="crowdfunding">
            <div class="content-wrapper">
                <h2 data-editable="crowdfundingTitle">Crowdfunding Campaigns</h2>
                <p data-editable="crowdfundingDescription">Active campaigns that need support. Updated regularly.</p>
                <div class="accordion" id="crowdfunding-accordion"></div>
            </div>
        </section>

        <section class="section" id="orgs">
            <div class="content-wrapper">
                <h2 data-editable="orgsTitle">Organizations On The Ground</h2>
                <p data-editable="orgsDescription">Organizations doing direct service, jail support, and legal defense work.</p>
                <div class="accordion" id="orgs-accordion"></div>
            </div>
        </section>

        <section class="section section-dark" id="secure-messaging">
            <div class="content-wrapper" style="text-align: center;">
                <h2 data-editable="secureMessagingTitle">Stay Connected Securely</h2>
                <p data-editable="secureMessagingDescription" style="margin: 0 auto 1.5rem auto;">In times of uncertainty, secure communication is essential. Join our community on Hyphae Network  a decentralized, privacy-focused messaging platform built on Matrix protocol.</p>

                <div class="secure-recommendations" style="margin: 2.5rem auto; max-width: 700px;">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; opacity: 0.9;">Switch to Secure Alternatives</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">

                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #ef4444; font-weight: bold;"></span>
                                <span style="opacity: 0.6; text-decoration: line-through;">Gmail</span>
                            </div>
                            <span style="opacity: 0.4;"></span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #22c55e; font-weight: bold;"></span>
                                <a href="https://protonmail.com" target="_blank" rel="noopener" style="color: var(--accent-color); font-weight: bold; text-decoration: none;">ProtonMail</a>
                            </div>
                            <span style="opacity: 0.5; font-size: 0.85rem; margin-left: 0.5rem;">encrypted email</span>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #ef4444; font-weight: bold;"></span>
                                <span style="opacity: 0.6; text-decoration: line-through;">Slack</span>
                            </div>
                            <span style="opacity: 0.4;"></span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #22c55e; font-weight: bold;"></span>
                                <a href="https://hyphae.social" target="_blank" rel="noopener" style="color: var(--accent-color); font-weight: bold; text-decoration: none;">Hyphae.social</a>
                            </div>
                            <span style="opacity: 0.5; font-size: 0.85rem; margin-left: 0.5rem;">team chat</span>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #ef4444; font-weight: bold;"></span>
                                <span style="opacity: 0.6; text-decoration: line-through;">iMessage</span>
                            </div>
                            <span style="opacity: 0.4;"></span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #22c55e; font-weight: bold;"></span>
                                <a href="https://signal.org" target="_blank" rel="noopener" style="color: var(--accent-color); font-weight: bold; text-decoration: none;">Signal</a>
                            </div>
                            <span style="opacity: 0.5; font-size: 0.85rem; margin-left: 0.5rem;">personal messaging</span>
                        </div>

                    </div>
                </div>

                <div class="messaging-features" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0; text-align: center;">
                    <div class="feature">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <strong>End-to-End Encrypted</strong>
                        <p style="font-size: 0.9rem; opacity: 0.9;">Your messages stay private</p>
                    </div>
                    <div class="feature">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <strong>Decentralized</strong>
                        <p style="font-size: 0.9rem; opacity: 0.9;">No single point of control</p>
                    </div>
                    <div class="feature">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <strong>Works Everywhere</strong>
                        <p style="font-size: 0.9rem; opacity: 0.9;">Use Element, FluffyChat, or any Matrix app</p>
                    </div>
                </div>

                <div class="button-group" style="justify-content: center;">
                    <a href="https://hyphae.social" target="_blank" rel="noopener" class="public-btn" style="background: var(--accent-color); border-color: var(--accent-color);" data-editable="secureMessagingButtonUrl" data-editable-attr="href">
                        <span data-editable="secureMessagingButtonText">Join the Network </span>
                    </a>
                </div>
                <p style="margin-top: 1.5rem; font-size: 0.85rem; opacity: 0.8;">One account works with ANY Matrix app. New to Matrix? Hyphae has a quick 2-minute setup guide.</p>
            </div>
        </section>

        <footer class="footer">
            <p data-editable="footerText">This directory is an independent project. We are not raising or distributing any funds.</p>
            <p>Questions? <a href="mailto:contact@standwithtennessee.org" data-editable="contactEmail" data-editable-attr="href,text">contact@standwithtennessee.org</a></p>
        </footer>
    </div>

    <!-- ============================================
         ADMIN DASHBOARD
         ============================================ -->
    <div id="admin-dashboard">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>Stand With Tennessee</h1>
                <span>Admin Dashboard</span>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Site Editor</div>
                <div class="nav-item" onclick="openContentEditor()" style="cursor: pointer; background: var(--orange); color: white;">
                    <span class="icon"></span>
                    Content Editor
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" data-section="dashboard">
                    <span class="icon"></span>
                    Dashboard
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Data Management</div>
                <div class="nav-item" data-section="organizations">
                    <span class="icon"></span>
                    Organizations
                </div>
                <div class="nav-item" data-section="campaigns">
                    <span class="icon"></span>
                    Campaigns
                </div>
                <div class="nav-item" data-section="submissions">
                    <span class="icon"></span>
                    Submissions
                    <span class="badge" id="submissions-badge">0</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Reference Data</div>
                <div class="nav-item" data-section="services">
                    <span class="icon"></span>
                    Service Types
                </div>
                <div class="nav-item" data-section="regions">
                    <span class="icon"></span>
                    Regions
                </div>
                <div class="nav-item" data-section="languages">
                    <span class="icon"></span>
                    Languages
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <div class="nav-item" data-section="events">
                    <span class="icon"></span>
                    Activity Stream
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--navy-light);">
                <div class="nav-item" onclick="openPreviewModal()">
                    <span class="icon"></span>
                    Preview Site
                </div>
                <div class="nav-item" onclick="exitAdmin()">
                    <span class="icon"></span>
                    Exit Admin
                </div>
            </div>
        </nav>

        <main class="main">
            <!-- Dashboard Section -->
            <section id="dashboard" class="admin-section active">
                <div class="topbar">
                    <h2>Dashboard</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="openContentEditor()" style="background: var(--orange);">
                            Open Content Editor
                        </button>
                    </div>
                </div>
                <div class="content">
                    <!-- Quick Actions Card -->
                    <div class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);">
                        <div class="card-body" style="padding: 24px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                                <div style="color: white;">
                                    <h3 style="font-size: 18px; margin-bottom: 4px;">Edit Your Site</h3>
                                    <p style="opacity: 0.8; font-size: 14px; margin: 0;">Use the Content Editor to manage all site content, settings, and see live preview</p>
                                </div>
                                <button class="btn" onclick="openContentEditor()" style="background: var(--orange); color: white; padding: 12px 24px; font-size: 15px;">
                                    Launch Content Editor
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">Organizations</div>
                            <div class="value" id="stat-orgs">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Verified</div>
                            <div class="value" id="stat-verified">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Active Campaigns</div>
                            <div class="value" id="stat-campaigns">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Pending Submissions</div>
                            <div class="value" id="stat-submissions">0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Recent Activity</h3>
                            <button class="btn btn-sm btn-secondary" onclick="showSection('events')">View All</button>
                        </div>
                        <div class="card-body" id="recent-events"></div>
                    </div>
                </div>
            </section>

            <!-- Organizations Section -->
            <section id="organizations" class="admin-section">
                <div class="topbar">
                    <h2>Organizations</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="openModal('org-modal')">+ Add Organization</button>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="card-header"><h3>All Organizations</h3></div>
                        <div class="filters-bar" style="padding: 16px 20px; border-bottom: 1px solid var(--gray-200);">
                            <input type="text" class="search-input" id="org-search" placeholder="Search organizations...">
                            <select class="filter-select" id="org-status-filter">
                                <option value="">All Statuses</option>
                                <option value="verified">Verified</option>
                                <option value="pending">Pending</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Services</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="organizations-table">
                                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Campaigns Section -->
            <section id="campaigns" class="admin-section">
                <div class="topbar">
                    <h2>Campaigns</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="openModal('campaign-modal')">+ Add Campaign</button>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="card-header"><h3>All Campaigns</h3></div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Platform</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="campaigns-table">
                                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Submissions Section -->
            <section id="submissions" class="admin-section">
                <div class="topbar">
                    <h2>Submissions Queue</h2>
                </div>
                <div class="content">
                    <div class="alert alert-warning" id="submissions-alert" style="display: none;">
                        <span class="alert-icon"></span>
                        <div class="alert-content">
                            <div class="alert-title" id="submissions-alert-title">submissions awaiting review</div>
                        </div>
                    </div>
                    <div id="submissions-list">
                        <div class="empty">No pending submissions</div>
                    </div>
                </div>
            </section>

            <!-- Service Types Section -->
            <section id="services" class="admin-section">
                <div class="topbar">
                    <h2>Service Types</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="openModal('service-modal')">+ Add Service Type</button>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="card-body" id="services-list">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Regions Section -->
            <section id="regions" class="admin-section">
                <div class="topbar">
                    <h2>Regions</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="openModal('region-modal')">+ Add Region</button>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Counties</th>
                                    </tr>
                                </thead>
                                <tbody id="regions-table">
                                    <tr><td colspan="3" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Languages Section -->
            <section id="languages" class="admin-section">
                <div class="topbar">
                    <h2>Languages</h2>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Native Name</th>
                                    </tr>
                                </thead>
                                <tbody id="languages-table">
                                    <tr><td colspan="3" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Activity Stream Section -->
            <section id="events" class="admin-section">
                <div class="topbar">
                    <h2>Activity Stream</h2>
                    <div class="topbar-actions">
                        <span style="font-size: 13px; color: var(--gray-500);" id="event-count">0 events</span>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="filters-bar" style="padding: 16px 20px; border-bottom: 1px solid var(--gray-200);">
                            <select class="filter-select" id="event-operator-filter" onchange="loadEvents()">
                                <option value="">All Operators</option>
                                <option value="INS">INS (Create)</option>
                                <option value="ALT">ALT (Update)</option>
                                <option value="CON">CON (Link)</option>
                                <option value="NUL">NUL (Archive)</option>
                            </select>
                            <select class="filter-select" id="event-frame-filter" onchange="loadEvents()">
                                <option value="">All Frames</option>
                                <option value="organizations">Organizations</option>
                                <option value="campaigns">Campaigns</option>
                                <option value="submissions">Submissions</option>
                                <option value="sections">Page Sections</option>
                                <option value="blocks">Content Blocks</option>
                                <option value="site_settings">Site Settings</option>
                                <option value="services">Service Types</option>
                                <option value="regions">Regions</option>
                                <option value="languages">Languages</option>
                            </select>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Timestamp</th>
                                        <th>Type</th>
                                        <th>Op</th>
                                        <th>Frame</th>
                                        <th>Record</th>
                                        <th>Actor</th>
                                    </tr>
                                </thead>
                                <tbody id="events-table">
                                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Site Config Section -->
            <section id="site-config" class="admin-section">
                <div class="topbar">
                    <h2>Front Page Content</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-secondary" onclick="exportSiteData()">Export Data</button>
                        <button class="btn btn-primary" onclick="saveSiteConfig()">Save Changes</button>
                    </div>
                </div>
                <div class="content">
                    <p style="color: var(--gray-500); margin-bottom: 20px;">Edit all text and links that appear on the public-facing front page. Changes are saved to your browser and applied immediately.</p>

                    <!-- Header Section -->
                    <div class="card">
                        <div class="card-header"><h3>Header</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Site Name</label>
                                    <input type="text" id="config-siteName" placeholder="Stand With Tennessee">
                                </div>
                                <div class="form-group">
                                    <label>Donate Button URL</label>
                                    <input type="text" id="config-donateUrl" placeholder="https://...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hero Section -->
                    <div class="card">
                        <div class="card-header"><h3>Hero Section</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Hero Title</label>
                                    <textarea id="config-heroTitle" placeholder="Main headline that visitors see first"></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Hero Description</label>
                                    <textarea id="config-heroDescription" placeholder="Supporting text below the headline"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Featured Button Text</label>
                                    <input type="text" id="config-featuredButton1Text" placeholder="e.g., Featured GoFundMe">
                                </div>
                                <div class="form-group">
                                    <label>Featured Button URL</label>
                                    <input type="text" id="config-featuredButton1Url" placeholder="https://...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mutual Aid Section -->
                    <div class="card">
                        <div class="card-header"><h3>Mutual Aid Section</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Section Title</label>
                                    <input type="text" id="config-mutualAidTitle" placeholder="Mutual Aid & Materials">
                                </div>
                                <div class="form-group full-width">
                                    <label>Section Description</label>
                                    <textarea id="config-mutualAidDescription" placeholder="Description text for this section"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Crowdfunding Section -->
                    <div class="card">
                        <div class="card-header"><h3>Crowdfunding Section</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Section Title</label>
                                    <input type="text" id="config-crowdfundingTitle" placeholder="Crowdfunding Campaigns">
                                </div>
                                <div class="form-group full-width">
                                    <label>Section Description</label>
                                    <textarea id="config-crowdfundingDescription" placeholder="Description text for this section"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Organizations Section -->
                    <div class="card">
                        <div class="card-header"><h3>Organizations Section</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Section Title</label>
                                    <input type="text" id="config-orgsTitle" placeholder="Organizations On The Ground">
                                </div>
                                <div class="form-group full-width">
                                    <label>Section Description</label>
                                    <textarea id="config-orgsDescription" placeholder="Description text for this section"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secure Messaging Section -->
                    <div class="card">
                        <div class="card-header"><h3>Secure Messaging Section</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Section Title</label>
                                    <input type="text" id="config-secureMessagingTitle" placeholder="Stay Connected Securely">
                                </div>
                                <div class="form-group full-width">
                                    <label>Section Description</label>
                                    <textarea id="config-secureMessagingDescription" placeholder="In times of uncertainty, secure communication is essential..."></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Quote Text</label>
                                    <textarea id="config-secureMessagingQuote" placeholder="Featured quote for the section"></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Quote Author</label>
                                    <input type="text" id="config-secureMessagingQuoteAuthor" placeholder=" Author Name, Source (Year)">
                                </div>
                                <div class="form-group">
                                    <label>Button Text</label>
                                    <input type="text" id="config-secureMessagingButtonText" placeholder="Join the Network ">
                                </div>
                                <div class="form-group">
                                    <label>Button URL</label>
                                    <input type="text" id="config-secureMessagingButtonUrl" placeholder="https://hyphae.social">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Section -->
                    <div class="card">
                        <div class="card-header"><h3>Footer</h3></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>Footer Text</label>
                                    <textarea id="config-footerText" placeholder="Disclaimer or informational text"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Contact Email</label>
                                    <input type="email" id="config-contactEmail" placeholder="contact@example.org">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Outward Content Section (Xano Integration) -->
            <section id="outward-content" class="admin-section">
                <div class="topbar">
                    <h2>Website Content</h2>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="openModal('content-modal')">+ Add Content</button>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div class="card-header"><h3>Published Content</h3></div>
                        <div class="filters-bar" style="padding: 16px 20px; border-bottom: 1px solid var(--gray-200);">
                            <input type="text" class="search-input" id="content-search" placeholder="Search content...">
                            <select class="filter-select" id="content-category-filter">
                                <option value="">All Categories</option>
                            </select>
                            <select class="filter-select" id="content-published-filter">
                                <option value="">All Status</option>
                                <option value="true">Published</option>
                                <option value="false">Draft</option>
                            </select>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Slug</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Published Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="content-table">
                                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ============================================
         MODALS
         ============================================ -->

    <!-- Login Modal -->
    <div class="login-backdrop" id="loginBackdrop"></div>
    <div class="login-modal" id="loginModal">
        <h3>Admin Access</h3>
        <input type="password" id="passwordInput" placeholder="Enter password">
        <button class="btn btn-primary" id="loginBtn" style="width: 100%;">Login</button>
        <p id="loginError" style="color: var(--red); margin-top: 0.5rem; display: none;">Invalid password</p>
    </div>

    <!-- Add Organization Modal -->
    <div id="org-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Organization</h3>
                <button class="modal-close" onclick="closeModal('org-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="org-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Organization Name <span class="required">*</span></label>
                            <input type="text" name="name" required placeholder="e.g., Nashville Legal Aid Society">
                        </div>
                        <div class="form-group">
                            <label>Organization Type <span class="required">*</span></label>
                            <select name="organization_type" required>
                                <option value="">Select type...</option>
                                <option value="nonprofit">Nonprofit</option>
                                <option value="mutual_aid">Mutual Aid</option>
                                <option value="faith_based">Faith Based</option>
                                <option value="legal_services">Legal Services</option>
                                <option value="healthcare">Healthcare</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Description <span class="required">*</span></label>
                            <textarea name="description" required placeholder="Brief description..."></textarea>
                        </div>
                        <div class="section-divider full-width">Contact Information</div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" name="website" placeholder="https://example.org">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" name="phone_primary" placeholder="(615) 555-0100">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" placeholder="contact@example.org">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" name="address_city" placeholder="Nashville">
                        </div>
                        <div class="section-divider full-width">Service Details</div>
                        <div class="form-group full-width">
                            <label>Service Types</label>
                            <div class="checkbox-group" id="org-services-checkboxes"></div>
                        </div>
                        <div class="section-divider full-width">Status</div>
                        <div class="form-group">
                            <label>Initial Status</label>
                            <select name="status">
                                <option value="draft">Draft</option>
                                <option value="verified">Verified</option>
                                <option value="pending">Pending Review</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('org-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitOrganization()">Create Organization</button>
            </div>
        </div>
    </div>

    <!-- Add Campaign Modal -->
    <div id="campaign-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Campaign</h3>
                <button class="modal-close" onclick="closeModal('campaign-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="campaign-form">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Campaign Title <span class="required">*</span></label>
                            <input type="text" name="title" required placeholder="e.g., Help the Garcia Family">
                        </div>
                        <div class="form-group">
                            <label>Platform <span class="required">*</span></label>
                            <select name="platform" required>
                                <option value="">Select platform...</option>
                                <option value="gofundme">GoFundMe</option>
                                <option value="givebutter">Givebutter</option>
                                <option value="venmo">Venmo</option>
                                <option value="cashapp">CashApp</option>
                                <option value="paypal">PayPal</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Campaign URL <span class="required">*</span></label>
                            <input type="url" name="external_url" required placeholder="https://gofundme.com/...">
                        </div>
                        <div class="form-group">
                            <label>Campaign Type</label>
                            <select name="campaign_type">
                                <option value="individual_family">Individual/Family</option>
                                <option value="community_fund">Community Fund</option>
                                <option value="legal_fund">Legal Defense Fund</option>
                                <option value="bond_fund">Bond Fund</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Goal Amount</label>
                            <input type="number" name="goal_amount" placeholder="5000">
                        </div>
                        <div class="form-group full-width">
                            <label>Description <span class="required">*</span></label>
                            <textarea name="description" required placeholder="Brief description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status">
                                <option value="active">Active</option>
                                <option value="goal_met">Goal Met</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('campaign-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitCampaign()">Add Campaign</button>
            </div>
        </div>
    </div>

    <!-- Add Service Type Modal -->
    <div id="service-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Add Service Type</h3>
                <button class="modal-close" onclick="closeModal('service-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="service-form">
                    <div class="form-grid single">
                        <div class="form-group">
                            <label>ID (slug) <span class="required">*</span></label>
                            <input type="text" name="id" required placeholder="e.g., legal-immigration">
                            <div class="hint">Lowercase, hyphens only</div>
                        </div>
                        <div class="form-group">
                            <label>Name <span class="required">*</span></label>
                            <input type="text" name="name" required placeholder="e.g., Immigration Legal Services">
                        </div>
                        <div class="form-group">
                            <label>Parent Category</label>
                            <select name="parent_id" id="service-parent-select">
                                <option value="">None (top-level)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('service-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitService()">Add Service Type</button>
            </div>
        </div>
    </div>

    <!-- Add Region Modal -->
    <div id="region-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Add Region</h3>
                <button class="modal-close" onclick="closeModal('region-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="region-form">
                    <div class="form-grid single">
                        <div class="form-group">
                            <label>ID (slug) <span class="required">*</span></label>
                            <input type="text" name="id" required placeholder="e.g., nashville-metro">
                        </div>
                        <div class="form-group">
                            <label>Name <span class="required">*</span></label>
                            <input type="text" name="name" required placeholder="e.g., Nashville Metro">
                        </div>
                        <div class="form-group">
                            <label>Type <span class="required">*</span></label>
                            <select name="type" required>
                                <option value="metro">Metro</option>
                                <option value="county">County</option>
                                <option value="multi_county">Multi-county</option>
                                <option value="statewide">Statewide</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Counties (comma-separated)</label>
                            <input type="text" name="counties" placeholder="Davidson, Williamson">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('region-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitRegion()">Add Region</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Content Modal (Xano) -->
    <div id="content-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="content-modal-title">Add Content</h3>
                <button class="modal-close" onclick="closeModal('content-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="content-form">
                    <input type="hidden" name="id" id="content-id">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Title <span class="required">*</span></label>
                            <input type="text" name="title" id="content-title" required placeholder="Enter title">
                        </div>
                        <div class="form-group">
                            <label>Slug <span class="required">*</span></label>
                            <input type="text" name="slug" id="content-slug" required placeholder="url-friendly-slug">
                            <div class="hint">URL-friendly identifier (lowercase, hyphens only)</div>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" name="category" id="content-category" placeholder="e.g., news, updates, resources">
                        </div>
                        <div class="form-group full-width">
                            <label>Summary</label>
                            <textarea name="summary" id="content-summary" rows="2" placeholder="Brief summary for previews"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>Content (HTML) <span class="required">*</span></label>
                            <textarea name="content_html" id="content-html" rows="10" required placeholder="Enter HTML content..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Featured Image URL</label>
                            <input type="text" name="featured_image" id="content-image" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>Tags (comma-separated)</label>
                            <input type="text" name="tags" id="content-tags" placeholder="tag1, tag2, tag3">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="is_published" id="content-published">
                                <span>Published</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('content-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitContent()">Save Content</button>
            </div>
        </div>
    </div>

    <!-- Preview Site Modal -->
    <div id="preview-modal" class="preview-modal-overlay">
        <div class="preview-header">
            <div class="preview-header-left">
                <h3>Site Preview</h3>
                <span class="preview-badge" id="preview-mode-badge">Preview Mode</span>
                <div class="preview-toggle-group">
                    <button class="preview-toggle-btn active" id="preview-btn-all" onclick="setPreviewMode('all')">All Content</button>
                    <button class="preview-toggle-btn" id="preview-btn-live" onclick="setPreviewMode('live')">Live Only</button>
                </div>
            </div>
            <button class="preview-close-btn" onclick="closePreviewModal()">&times;</button>
        </div>
        <div class="preview-iframe-container">
            <div class="preview-banner" id="preview-banner">
                PREVIEW MODE - Showing all content including drafts and unpublished items
            </div>
            <div id="preview-content" style="height: 100%; overflow-y: auto; padding-top: 40px;"></div>
        </div>
    </div>

    <!-- ============================================
         CONTENT EDITOR VIEW (integrated)
         ============================================ -->
    <div id="content-editor-view">
        <div class="ce-editor-container">
            <!-- Preview Panel (Left) -->
            <div class="ce-preview-panel">
                <div class="ce-preview-header">
                    <h2>
                        <span>Live Preview</span>
                    </h2>
                    <div class="ce-preview-controls">
                        <!-- Device Preview -->
                        <div class="sm-preview-devices">
                            <button class="sm-device-btn active" onclick="setPreviewDevice('desktop')" title="Desktop"></button>
                            <button class="sm-device-btn" onclick="setPreviewDevice('tablet')" title="Tablet"></button>
                            <button class="sm-device-btn" onclick="setPreviewDevice('mobile')" title="Mobile"></button>
                        </div>
                        <!-- Zoom Controls -->
                        <button onclick="setCePreviewScale(1)" class="active" data-scale="1">100%</button>
                        <button onclick="setCePreviewScale(0.75)" data-scale="0.75">75%</button>
                        <button onclick="setCePreviewScale(0.5)" data-scale="0.5">50%</button>
                        <button onclick="closeContentEditor()">Exit Editor</button>
                    </div>
                </div>
                <div class="ce-preview-frame" id="ce-preview-frame">
                    <div class="ce-preview-content ce-preview-site" id="ce-preview-content">
                        <!-- Preview content rendered here -->
                    </div>
                </div>
            </div>

            <!-- CMS Panel (Right) -->
            <div class="ce-cms-panel">
                <div class="ce-cms-header">
                    <h2>Content Manager</h2>
                    <button class="btn btn-primary btn-sm" onclick="ceSaveAllContent()">
                        Save All
                    </button>
                </div>

                <div class="ce-cms-tabs">
                    <button class="ce-cms-tab active" onclick="showCeCmsTab('content')">Content</button>
                    <button class="ce-cms-tab" onclick="showCeCmsTab('style')">Style</button>
                    <button class="ce-cms-tab" onclick="showCeCmsTab('blocks')">Blocks</button>
                    <button class="ce-cms-tab" onclick="showCeCmsTab('settings')">Settings</button>
                    <button class="ce-cms-tab" onclick="showCeCmsTab('activity')">Activity</button>
                </div>

                <div class="ce-cms-content">
                    <!-- Content Tab -->
                    <div id="ce-tab-content" class="ce-cms-section active">
                        <div class="ce-content-type-list" id="ce-content-types">
                            <!-- Content types rendered here -->
                        </div>

                        <div id="ce-content-table-area">
                            <!-- Selected content type table rendered here -->
                        </div>
                    </div>

                    <!-- Style Tab -->
                    <div id="ce-tab-style" class="ce-cms-section">
                        <div class="sm-panel">
                            <div class="sm-header">
                                <h3>Site Styles</h3>
                                <p>Customize colors, fonts, buttons & layout</p>
                                <div class="sm-save-indicator" id="sm-save-indicator">
                                    <span class="dot"></span>
                                    <span>All changes saved</span>
                                </div>
                            </div>
                            <div class="sm-content" id="sm-content">
                                <!-- Colors Section -->
                                <div class="sm-accordion open" data-section="colors">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Colors</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-section-label">Color Palette</div>
                                        <div class="sm-color-palette" id="sm-color-palette">
                                            <!-- Palette swatches rendered by JS -->
                                        </div>

                                        <div class="sm-divider"></div>

                                        <div class="sm-section-label">Brand Colors</div>
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Primary</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-primary" value="#1a1a1a" onchange="smUpdateColor('theme-primary', this.value)">
                                                    <input type="text" value="#1a1a1a" onchange="smUpdateColorFromText('theme-primary', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Secondary</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-secondary" value="#ffffff" onchange="smUpdateColor('theme-secondary', this.value)">
                                                    <input type="text" value="#ffffff" onchange="smUpdateColorFromText('theme-secondary', this.value)">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Accent</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-accent" value="#c8102e" onchange="smUpdateColor('theme-accent', this.value)">
                                                    <input type="text" value="#c8102e" onchange="smUpdateColorFromText('theme-accent', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Background</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-background" value="#ffffff" onchange="smUpdateColor('theme-background', this.value)">
                                                    <input type="text" value="#ffffff" onchange="smUpdateColorFromText('theme-background', this.value)">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Text</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-text" value="#333333" onchange="smUpdateColor('theme-text', this.value)">
                                                    <input type="text" value="#333333" onchange="smUpdateColorFromText('theme-text', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Border</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-border" value="#e5e5e5" onchange="smUpdateColor('theme-border', this.value)">
                                                    <input type="text" value="#e5e5e5" onchange="smUpdateColorFromText('theme-border', this.value)">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Link</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-link" value="#c8102e" onchange="smUpdateColor('theme-link', this.value)">
                                                    <input type="text" value="#c8102e" onchange="smUpdateColorFromText('theme-link', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Link Hover</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-theme-link-hover" value="#a00d24" onchange="smUpdateColor('theme-link-hover', this.value)">
                                                    <input type="text" value="#a00d24" onchange="smUpdateColorFromText('theme-link-hover', this.value)">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sm-divider"></div>

                                        <div class="sm-section-label">Theme Presets</div>
                                        <div class="sm-preset-grid">
                                            <div class="sm-preset-card active" onclick="smApplyPreset('default')">
                                                <div class="sm-preset-preview">
                                                    <div style="background: #1a1a1a"></div>
                                                    <div style="background: #ffffff"></div>
                                                    <div style="background: #c8102e"></div>
                                                </div>
                                                <div class="sm-preset-name">Default</div>
                                            </div>
                                            <div class="sm-preset-card" onclick="smApplyPreset('dark')">
                                                <div class="sm-preset-preview">
                                                    <div style="background: #ffffff"></div>
                                                    <div style="background: #1a1a1a"></div>
                                                    <div style="background: #ff6b35"></div>
                                                </div>
                                                <div class="sm-preset-name">Dark</div>
                                            </div>
                                            <div class="sm-preset-card" onclick="smApplyPreset('warm')">
                                                <div class="sm-preset-preview">
                                                    <div style="background: #2d3436"></div>
                                                    <div style="background: #ffeaa7"></div>
                                                    <div style="background: #e17055"></div>
                                                </div>
                                                <div class="sm-preset-name">Warm</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Typography Section -->
                                <div class="sm-accordion" data-section="typography">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Typography</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-group">
                                            <label>Heading Font</label>
                                            <select class="sm-select" id="sm-font-heading" onchange="smUpdateFont('heading', this.value)">
                                                <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif">System Default</option>
                                                <option value="'Inter', sans-serif">Inter</option>
                                                <option value="'Playfair Display', serif">Playfair Display</option>
                                                <option value="'Roboto', sans-serif">Roboto</option>
                                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                                <option value="'Montserrat', sans-serif">Montserrat</option>
                                                <option value="'Lato', sans-serif">Lato</option>
                                                <option value="'Poppins', sans-serif">Poppins</option>
                                                <option value="'Georgia', serif">Georgia</option>
                                                <option value="'Times New Roman', serif">Times New Roman</option>
                                            </select>
                                            <div class="sm-font-preview" id="sm-font-heading-preview">
                                                <div class="sample" style="font-weight: 700;">The quick brown fox</div>
                                                <div class="details">Preview of heading font</div>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Body Font</label>
                                            <select class="sm-select" id="sm-font-body" onchange="smUpdateFont('body', this.value)">
                                                <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif">System Default</option>
                                                <option value="'Inter', sans-serif">Inter</option>
                                                <option value="'Roboto', sans-serif">Roboto</option>
                                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                                <option value="'Lato', sans-serif">Lato</option>
                                                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                                                <option value="'Nunito', sans-serif">Nunito</option>
                                                <option value="'Georgia', serif">Georgia</option>
                                            </select>
                                        </div>

                                        <div class="sm-divider"></div>

                                        <div class="sm-form-group">
                                            <label>Base Font Size</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-text-base-size" min="12" max="24" value="16" onchange="smUpdateSize('text-base-size', this.value + 'px')">
                                                <span class="sm-range-value" id="sm-text-base-size-value">16px</span>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Type Scale</label>
                                            <select class="sm-select" id="sm-text-scale" onchange="smUpdateSize('text-scale-ratio', this.value)">
                                                <option value="1.125">Minor Second (1.125)</option>
                                                <option value="1.2">Minor Third (1.2)</option>
                                                <option value="1.25" selected>Major Third (1.25)</option>
                                                <option value="1.333">Perfect Fourth (1.333)</option>
                                                <option value="1.414">Augmented Fourth (1.414)</option>
                                                <option value="1.5">Perfect Fifth (1.5)</option>
                                            </select>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Line Height</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-line-height" min="1.2" max="2" step="0.1" value="1.6" onchange="smUpdateSize('line-height-normal', this.value)">
                                                <span class="sm-range-value" id="sm-line-height-value">1.6</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Buttons Section -->
                                <div class="sm-accordion" data-section="buttons">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Buttons</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-group">
                                            <label>Button Shape</label>
                                            <div class="sm-shape-selector">
                                                <div class="sm-shape-option active" onclick="smSetButtonShape('square', this)">
                                                    <div class="preview square"></div>
                                                    <div class="label">Square</div>
                                                </div>
                                                <div class="sm-shape-option" onclick="smSetButtonShape('rounded', this)">
                                                    <div class="preview rounded"></div>
                                                    <div class="label">Rounded</div>
                                                </div>
                                                <div class="sm-shape-option" onclick="smSetButtonShape('pill', this)">
                                                    <div class="preview pill"></div>
                                                    <div class="label">Pill</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sm-divider"></div>

                                        <div class="sm-section-label">Primary Button</div>
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Background</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-btn-primary-bg" value="#1a1a1a" onchange="smUpdateColor('btn-primary-bg', this.value)">
                                                    <input type="text" value="#1a1a1a" onchange="smUpdateColorFromText('btn-primary-bg', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Text</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-btn-primary-text" value="#ffffff" onchange="smUpdateColor('btn-primary-text', this.value)">
                                                    <input type="text" value="#ffffff" onchange="smUpdateColorFromText('btn-primary-text', this.value)">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Border Width</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-btn-border-width" min="0" max="4" value="2" onchange="smUpdateSize('btn-border-width', this.value + 'px')">
                                                <span class="sm-range-value" id="sm-btn-border-width-value">2px</span>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Padding</label>
                                            <div class="sm-form-row">
                                                <div class="sm-input-with-unit">
                                                    <input type="number" class="sm-input" id="sm-btn-padding-y" value="0.75" step="0.125" onchange="smUpdateSize('btn-padding-y', this.value + 'rem')">
                                                    <span class="unit">rem (V)</span>
                                                </div>
                                                <div class="sm-input-with-unit">
                                                    <input type="number" class="sm-input" id="sm-btn-padding-x" value="1.5" step="0.125" onchange="smUpdateSize('btn-padding-x', this.value + 'rem')">
                                                    <span class="unit">rem (H)</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Font Weight</label>
                                            <select class="sm-select" id="sm-btn-font-weight" onchange="smUpdateSize('btn-font-weight', this.value)">
                                                <option value="400">Normal (400)</option>
                                                <option value="500">Medium (500)</option>
                                                <option value="600" selected>Semibold (600)</option>
                                                <option value="700">Bold (700)</option>
                                            </select>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Text Transform</label>
                                            <select class="sm-select" id="sm-btn-text-transform" onchange="smUpdateSize('btn-text-transform', this.value)">
                                                <option value="none" selected>None</option>
                                                <option value="uppercase">UPPERCASE</option>
                                                <option value="capitalize">Capitalize</option>
                                                <option value="lowercase">lowercase</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Spacing Section -->
                                <div class="sm-accordion" data-section="spacing">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Spacing & Layout</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-group">
                                            <label>Content Max Width</label>
                                            <select class="sm-select" id="sm-content-width" onchange="smUpdateSize('content-max-width', this.value)">
                                                <option value="800px">Narrow (800px)</option>
                                                <option value="1000px">Medium (1000px)</option>
                                                <option value="1200px" selected>Wide (1200px)</option>
                                                <option value="1400px">Extra Wide (1400px)</option>
                                                <option value="100%">Full Width</option>
                                            </select>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Section Padding</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-section-padding" min="2" max="8" value="4" onchange="smUpdateSize('section-padding-y', this.value + 'rem')">
                                                <span class="sm-range-value" id="sm-section-padding-value">4rem</span>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Side Padding</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-side-padding" min="2" max="8" value="4" onchange="smUpdateSize('section-padding', this.value + 'vw')">
                                                <span class="sm-range-value" id="sm-side-padding-value">4vw</span>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Base Spacing Unit</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-space-unit" min="4" max="16" value="8" onchange="smUpdateSize('space-unit', this.value + 'px')">
                                                <span class="sm-range-value" id="sm-space-unit-value">8px</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Header Section -->
                                <div class="sm-accordion" data-section="header">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Header</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Background</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-header-bg" value="#ffffff" onchange="smUpdateColor('header-bg', this.value)">
                                                    <input type="text" value="#ffffff" onchange="smUpdateColorFromText('header-bg', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Text Color</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-header-text" value="#1a1a1a" onchange="smUpdateColor('header-text', this.value)">
                                                    <input type="text" value="#1a1a1a" onchange="smUpdateColorFromText('header-text', this.value)">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Header Height</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-header-height" min="48" max="120" value="72" onchange="smUpdateSize('header-height', this.value + 'px')">
                                                <span class="sm-range-value" id="sm-header-height-value">72px</span>
                                            </div>
                                        </div>

                                        <div class="sm-toggle">
                                            <span class="sm-toggle-label">Sticky Header</span>
                                            <div class="sm-toggle-switch active" id="sm-header-sticky" onclick="smToggleSwitch(this, 'header-position')"></div>
                                        </div>

                                        <div class="sm-toggle">
                                            <span class="sm-toggle-label">Show Border</span>
                                            <div class="sm-toggle-switch active" id="sm-header-border" onclick="smToggleSwitch(this, 'header-border')"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Footer Section -->
                                <div class="sm-accordion" data-section="footer">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Footer</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Background</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-footer-bg" value="#c8102e" onchange="smUpdateColor('footer-bg', this.value)">
                                                    <input type="text" value="#c8102e" onchange="smUpdateColorFromText('footer-bg', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Text Color</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-footer-text" value="#ffffff" onchange="smUpdateColor('footer-text', this.value)">
                                                    <input type="text" value="#ffffff" onchange="smUpdateColorFromText('footer-text', this.value)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Effects Section -->
                                <div class="sm-accordion" data-section="effects">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Effects</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-group">
                                            <label>Border Radius</label>
                                            <div class="sm-range-group">
                                                <input type="range" class="sm-range" id="sm-border-radius" min="0" max="24" value="8" onchange="smUpdateSize('border-radius-md', this.value + 'px')">
                                                <span class="sm-range-value" id="sm-border-radius-value">8px</span>
                                            </div>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Shadow Intensity</label>
                                            <select class="sm-select" id="sm-shadow-intensity" onchange="smUpdateShadow(this.value)">
                                                <option value="none">None</option>
                                                <option value="subtle">Subtle</option>
                                                <option value="medium" selected>Medium</option>
                                                <option value="strong">Strong</option>
                                            </select>
                                        </div>

                                        <div class="sm-form-group">
                                            <label>Transition Speed</label>
                                            <select class="sm-select" id="sm-transition-speed" onchange="smUpdateTransition(this.value)">
                                                <option value="0s">None</option>
                                                <option value="0.1s">Fast (0.1s)</option>
                                                <option value="0.2s" selected>Normal (0.2s)</option>
                                                <option value="0.3s">Slow (0.3s)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section Themes -->
                                <div class="sm-accordion" data-section="sections">
                                    <button class="sm-accordion-header" onclick="smToggleAccordion(this)">
                                        <span class="title"><span class="emoji"></span> Section Colors</span>
                                        <span class="icon"></span>
                                    </button>
                                    <div class="sm-accordion-body">
                                        <div class="sm-form-row">
                                            <div class="sm-form-group">
                                                <label>Light Section BG</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-section-light-bg" value="#f5f5f5" onchange="smUpdateColor('section-light-bg', this.value)">
                                                    <input type="text" value="#f5f5f5" onchange="smUpdateColorFromText('section-light-bg', this.value)">
                                                </div>
                                            </div>
                                            <div class="sm-form-group">
                                                <label>Dark Section BG</label>
                                                <div class="sm-color-input">
                                                    <input type="color" id="sm-section-dark-bg" value="#1a1a1a" onchange="smUpdateColor('section-dark-bg', this.value)">
                                                    <input type="text" value="#1a1a1a" onchange="smUpdateColorFromText('section-dark-bg', this.value)">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="sm-form-group">
                                            <label>Dark Section Text</label>
                                            <div class="sm-color-input">
                                                <input type="color" id="sm-section-dark-text" value="#ffffff" onchange="smUpdateColor('section-dark-text', this.value)">
                                                <input type="text" value="#ffffff" onchange="smUpdateColorFromText('section-dark-text', this.value)">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Blocks Tab -->
                    <div id="ce-tab-blocks" class="ce-cms-section">
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 12px; font-weight: 500; color: var(--gray-600);">Select Section:</label>
                            <select id="ce-block-section-select" onchange="ceLoadSectionBlocks(this.value)" style="width: 100%; margin-top: 6px; padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <option value="">Choose a section...</option>
                            </select>
                        </div>

                        <div id="ce-blocks-area">
                            <!-- Block list rendered here -->
                        </div>

                        <div class="ce-add-block-area" onclick="ceToggleAddBlockMenu()">
                            <span>+ Add Block</span>
                            <div class="ce-add-block-menu" id="ce-add-block-menu" style="display: none;">
                                <!-- Block type options -->
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="ce-tab-settings" class="ce-cms-section">
                        <div class="ce-section-editor">
                            <div class="ce-section-editor-header">
                                <h4>Site Settings</h4>
                            </div>
                            <div class="ce-section-editor-body">
                                <div class="ce-form-group">
                                    <label>Site Name</label>
                                    <input type="text" id="ce-setting-siteName" placeholder="Stand With Tennessee">
                                </div>
                                <div class="ce-form-group">
                                    <label>Hero Title</label>
                                    <textarea id="ce-setting-heroTitle" placeholder="Main headline..."></textarea>
                                </div>
                                <div class="ce-form-group">
                                    <label>Hero Description</label>
                                    <textarea id="ce-setting-heroDescription" placeholder="Site description..."></textarea>
                                </div>
                                <div class="ce-form-group">
                                    <label>Donate URL</label>
                                    <input type="url" id="ce-setting-donateUrl" placeholder="https://...">
                                </div>
                                <div class="ce-form-row">
                                    <div class="ce-form-group">
                                        <label>Featured Button Text</label>
                                        <input type="text" id="ce-setting-featuredButton1Text" placeholder="Featured GoFundMe">
                                    </div>
                                    <div class="ce-form-group">
                                        <label>Featured Button URL</label>
                                        <input type="url" id="ce-setting-featuredButton1Url" placeholder="https://...">
                                    </div>
                                </div>
                                <div class="ce-form-group">
                                    <label>Mutual Aid Section Title</label>
                                    <input type="text" id="ce-setting-mutualAidTitle" placeholder="Mutual Aid & Materials">
                                </div>
                                <div class="ce-form-group">
                                    <label>Mutual Aid Description</label>
                                    <textarea id="ce-setting-mutualAidDescription"></textarea>
                                </div>
                                <div class="ce-form-group">
                                    <label>Crowdfunding Section Title</label>
                                    <input type="text" id="ce-setting-crowdfundingTitle" placeholder="Crowdfunding Campaigns">
                                </div>
                                <div class="ce-form-group">
                                    <label>Crowdfunding Description</label>
                                    <textarea id="ce-setting-crowdfundingDescription"></textarea>
                                </div>
                                <div class="ce-form-group">
                                    <label>Organizations Section Title</label>
                                    <input type="text" id="ce-setting-orgsTitle" placeholder="Organizations On The Ground">
                                </div>
                                <div class="ce-form-group">
                                    <label>Organizations Description</label>
                                    <textarea id="ce-setting-orgsDescription"></textarea>
                                </div>
                                <div class="ce-form-group">
                                    <label>Secure Messaging Title</label>
                                    <input type="text" id="ce-setting-secureMessagingTitle">
                                </div>
                                <div class="ce-form-group">
                                    <label>Secure Messaging Description</label>
                                    <textarea id="ce-setting-secureMessagingDescription"></textarea>
                                </div>
                                <div class="ce-form-group">
                                    <label>Contact Email</label>
                                    <input type="email" id="ce-setting-contactEmail">
                                </div>
                                <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" onclick="ceSaveSettings()">
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div id="ce-tab-activity" class="ce-cms-section">
                        <div class="ce-section-editor">
                            <div class="ce-section-editor-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h4>Recent Activity</h4>
                                <span style="font-size: 12px; color: var(--gray-500);" id="ce-activity-count">0 events</span>
                            </div>
                            <div class="ce-section-editor-body" style="padding: 0;">
                                <div style="padding: 12px; border-bottom: 1px solid var(--gray-200);">
                                    <select id="ce-activity-filter" onchange="ceLoadActivityStream()" style="width: 100%; padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px;">
                                        <option value="">All Activity</option>
                                        <option value="organizations">Organizations</option>
                                        <option value="campaigns">Campaigns</option>
                                        <option value="sections">Page Sections</option>
                                        <option value="blocks">Content Blocks</option>
                                        <option value="site_settings">Site Settings</option>
                                    </select>
                                </div>
                                <div id="ce-activity-stream" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Activity items rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CE Edit Modal -->
    <div class="ce-modal-backdrop" id="ce-edit-modal">
        <div class="ce-modal">
            <div class="ce-modal-header">
                <h3 id="ce-edit-modal-title">Edit Item</h3>
                <button class="ce-modal-close" onclick="ceCloseEditModal()">&times;</button>
            </div>
            <div class="ce-modal-body" id="ce-edit-modal-body">
                <!-- Form rendered dynamically -->
            </div>
            <div class="ce-modal-footer">
                <button class="btn btn-secondary" onclick="ceCloseEditModal()">Cancel</button>
                <button class="btn btn-danger" id="ce-delete-btn" style="display: none;" onclick="ceDeleteCurrentItem()">Delete</button>
                <button class="btn btn-primary" onclick="ceSaveEditModal()">Save</button>
            </div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div class="ce-modal-backdrop" id="color-picker-modal">
        <div class="color-picker-modal">
            <div class="modal-header">
                <h3>Choose Color</h3>
                <button class="modal-close" onclick="closeColorPicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="color-picker-preview" id="color-picker-preview"></div>
                <input type="color" class="color-picker-native" id="color-picker-native" onchange="updateColorFromPicker(this.value)">
                <div class="color-picker-hex-input">
                    <input type="text" id="color-picker-hex" placeholder="#000000" oninput="updateColorFromHex(this.value)">
                </div>
                <div class="color-picker-presets">
                    <div class="color-picker-presets-label">Preset Colors</div>
                    <div class="color-picker-presets-grid" id="color-picker-presets">
                        <!-- Preset colors rendered by JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeColorPicker()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmColorPicker()">Apply</button>
            </div>
        </div>
    </div>

    <!-- CE Add Block Modal -->
    <div class="ce-modal-backdrop" id="ce-add-block-modal">
        <div class="ce-modal" style="max-width: 500px;">
            <div class="ce-modal-header">
                <h3>Add Block</h3>
                <button class="ce-modal-close" onclick="ceCloseAddBlockModal()">&times;</button>
            </div>
            <div class="ce-modal-body">
                <div class="ce-add-block-menu" style="display: grid;">
                    <div class="ce-add-block-option" onclick="ceAddBlock('text')">
                        <div class="ce-add-block-option-name">Text Block</div>
                        <div class="ce-add-block-option-desc">Rich text paragraph</div>
                    </div>
                    <div class="ce-add-block-option" onclick="ceAddBlock('heading')">
                        <div class="ce-add-block-option-name">Heading</div>
                        <div class="ce-add-block-option-desc">Section heading</div>
                    </div>
                    <div class="ce-add-block-option" onclick="ceAddBlock('accordion_item')">
                        <div class="ce-add-block-option-name">Accordion Item</div>
                        <div class="ce-add-block-option-desc">Collapsible content</div>
                    </div>
                    <div class="ce-add-block-option" onclick="ceAddBlock('link_list')">
                        <div class="ce-add-block-option-name">Link List</div>
                        <div class="ce-add-block-option-desc">List of links</div>
                    </div>
                    <div class="ce-add-block-option" onclick="ceAddBlock('button')">
                        <div class="ce-add-block-option-name">Button</div>
                        <div class="ce-add-block-option-desc">Call-to-action button</div>
                    </div>
                    <div class="ce-add-block-option" onclick="ceAddBlock('divider')">
                        <div class="ce-add-block-option-name">Divider</div>
                        <div class="ce-add-block-option-desc">Visual separator</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CE Toast notification -->
    <div class="ce-toast" id="ce-toast"></div>

    <script>
        // ============================================
        // LOCAL DATABASE (localStorage) - No Backend Required
        // ============================================

        // Webhook helper for external logging (optional)
        const Webhooks = {
            log(event, data = {}) {
                fetch('https://n8n.intelechia.com/webhook-test/5e1a5941-2016-49c7-b1f1-61a55940a83e', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event: event,
                        timestamp: new Date().toISOString(),
                        ...data
                    })
                }).catch(err => console.log('Webhook error:', err));
            }
        };

        // Content API for Xano - Handles all site data
        const ContentAPI = {
            baseUrl: 'https://xvkq-pq7i-idtl.n7d.xano.io/api:nrIL-Oi-',

            // Content articles
            async getContent() {
                try {
                    const res = await fetch(`${this.baseUrl}/swtContent`);
                    if (!res.ok) throw new Error('Failed to fetch content');
                    return await res.json();
                } catch (err) {
                    console.error('ContentAPI.getContent error:', err);
                    return [];
                }
            },

            async saveContent(content) {
                try {
                    const res = await fetch(`${this.baseUrl}/swtContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            created_at: new Date().toISOString(),
                            agent: 'web-client',
                            uuid: crypto.randomUUID(),
                            payload: content,
                            operator: 'content',
                            target: 'swtContent'
                        })
                    });
                    if (!res.ok) throw new Error('Failed to save content');
                    return await res.json();
                } catch (err) {
                    console.error('ContentAPI.saveContent error:', err);
                    throw err;
                }
            },

            // Site configuration (hero text, site name, etc.)
            async getSiteData() {
                try {
                    const res = await fetch(`${this.baseUrl}/swtSiteData`);
                    if (!res.ok) throw new Error('Failed to fetch site data');
                    const data = await res.json();
                    // API returns array, get first item or empty object
                    return Array.isArray(data) ? (data[0] || {}) : data;
                } catch (err) {
                    console.error('ContentAPI.getSiteData error:', err);
                    return {};
                }
            },

            async saveSiteData(siteData) {
                try {
                    const res = await fetch(`${this.baseUrl}/swtContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            created_at: new Date().toISOString(),
                            agent: 'web-client',
                            uuid: crypto.randomUUID(),
                            payload: siteData,
                            operator: 'siteData',
                            target: 'swtContent'
                        })
                    });
                    if (!res.ok) throw new Error('Failed to save site data');
                    return await res.json();
                } catch (err) {
                    console.error('ContentAPI.saveSiteData error:', err);
                    throw err;
                }
            },

            // Site theme (colors, typography, etc.)
            async getSiteTheme() {
                try {
                    const res = await fetch(`${this.baseUrl}/swtSiteTheme`);
                    if (!res.ok) throw new Error('Failed to fetch site theme');
                    const data = await res.json();
                    return Array.isArray(data) ? (data[0] || {}) : data;
                } catch (err) {
                    console.error('ContentAPI.getSiteTheme error:', err);
                    return {};
                }
            },

            async saveSiteTheme(theme) {
                try {
                    const res = await fetch(`${this.baseUrl}/swtContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            created_at: new Date().toISOString(),
                            agent: 'web-client',
                            uuid: crypto.randomUUID(),
                            payload: theme,
                            operator: 'siteTheme',
                            target: 'swtContent'
                        })
                    });
                    if (!res.ok) throw new Error('Failed to save site theme');
                    return await res.json();
                } catch (err) {
                    console.error('ContentAPI.saveSiteTheme error:', err);
                    throw err;
                }
            },

            // Event-sourced data (organizations, campaigns, etc.)
            async getSiteEvents() {
                try {
                    const res = await fetch(`${this.baseUrl}/swtSiteEvents`);
                    if (!res.ok) throw new Error('Failed to fetch site events');
                    const data = await res.json();
                    return Array.isArray(data) ? data : [];
                } catch (err) {
                    console.error('ContentAPI.getSiteEvents error:', err);
                    return [];
                }
            },

            async saveSiteEvent(event) {
                // Send a single event to the API
                try {
                    const res = await fetch(`${this.baseUrl}/swtContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            created_at: event.created_at,
                            agent: event.actor || 'web-client',
                            uuid: event.id,
                            payload: {
                                frame: event.frame,
                                record_id: event.record_id,
                                ordinal: event.ordinal,
                                event_type: event.event_type,
                                data: event.payload
                            },
                            operator: event.operator,
                            target: 'swtContent'
                        })
                    });
                    if (!res.ok) throw new Error('Failed to save site event');
                    return await res.json();
                } catch (err) {
                    console.error('ContentAPI.saveSiteEvent error:', err);
                    throw err;
                }
            },

            // Legacy methods for backwards compatibility
            async getAll() {
                return this.getContent();
            },

            async save(content) {
                return this.saveContent(content);
            }
        };

        // Helper function to compare values (handles arrays and objects)
        function valuesEqual(a, b) {
            // Handle null/undefined
            if (a === b) return true;
            if (a == null || b == null) return false;

            // Handle arrays
            if (Array.isArray(a) && Array.isArray(b)) {
                if (a.length !== b.length) return false;
                const sortedA = [...a].sort();
                const sortedB = [...b].sort();
                return sortedA.every((val, i) => val === sortedB[i]);
            }

            // Handle objects
            if (typeof a === 'object' && typeof b === 'object') {
                const keysA = Object.keys(a);
                const keysB = Object.keys(b);
                if (keysA.length !== keysB.length) return false;
                return keysA.every(key => valuesEqual(a[key], b[key]));
            }

            // Primitive comparison
            return a === b;
        }

        const DB = {
            events: JSON.parse(localStorage.getItem('swt_events') || '[]'),
            ordinal: parseInt(localStorage.getItem('swt_ordinal') || '0'),
            lastSyncedOrdinal: parseInt(localStorage.getItem('swt_lastSyncedOrdinal') || '0'), // Track last synced ordinal
            content: [], // Loaded from API
            siteData: JSON.parse(localStorage.getItem('siteData') || '{}'), // Pre-load from cache
            siteTheme: JSON.parse(localStorage.getItem('siteTheme') || '{}'), // Pre-load from cache
            isInitialized: false,
            _stateCache: {}, // Memoization cache for getAllCurrentStates

            // Initialize from API - call this on page load
            async initialize() {
                if (this.isInitialized) return;

                console.log('DB: Initializing from API...');
                try {
                    // Load all data from API in parallel
                    const [content, siteData, siteTheme, eventsData] = await Promise.all([
                        ContentAPI.getContent(),
                        ContentAPI.getSiteData(),
                        ContentAPI.getSiteTheme(),
                        ContentAPI.getSiteEvents()
                    ]);

                    // Set content
                    this.content = content || [];

                    // Set site data (merge with localStorage as fallback)
                    const localSiteData = JSON.parse(localStorage.getItem('siteData') || '{}');
                    this.siteData = Object.keys(siteData).length > 0 ? siteData : localSiteData;
                    if (Object.keys(siteData).length > 0) {
                        localStorage.setItem('siteData', JSON.stringify(siteData));
                    }

                    // Set site theme (merge with localStorage as fallback)
                    const localSiteTheme = JSON.parse(localStorage.getItem('siteTheme') || '{}');
                    this.siteTheme = Object.keys(siteTheme).length > 0 ? siteTheme : localSiteTheme;
                    if (Object.keys(siteTheme).length > 0) {
                        localStorage.setItem('siteTheme', JSON.stringify(siteTheme));
                    }

                    // Set events (use API data if available, otherwise use localStorage)
                    if (Array.isArray(eventsData) && eventsData.length > 0) {
                        // API returns { events, ordinal } structure
                        if (eventsData[0] && eventsData[0].events) {
                            this.events = eventsData[0].events;
                            this.ordinal = eventsData[0].ordinal || this.events.length;
                        } else {
                            this.events = eventsData;
                            this.ordinal = eventsData.length;
                        }
                        // Events from API are already synced, so update lastSyncedOrdinal
                        this.lastSyncedOrdinal = this.ordinal;
                        localStorage.setItem('swt_events', JSON.stringify(this.events));
                        localStorage.setItem('swt_ordinal', this.ordinal.toString());
                        localStorage.setItem('swt_lastSyncedOrdinal', this.lastSyncedOrdinal.toString());
                        this._invalidateCache(); // Clear memoization cache since events changed
                    }

                    this.isInitialized = true;
                    console.log('DB: Initialized successfully', {
                        content: this.content.length,
                        events: this.events.length,
                        siteData: Object.keys(this.siteData).length,
                        siteTheme: Object.keys(this.siteTheme).length
                    });
                } catch (err) {
                    console.error('DB: Error initializing from API', err);
                    // Fall back to localStorage
                    this.isInitialized = true;
                }
            },

            save() {
                localStorage.setItem('swt_events', JSON.stringify(this.events));
                localStorage.setItem('swt_ordinal', this.ordinal.toString());
                // Also sync to API (fire and forget)
                this.saveEventsToAPI();
            },

            async saveEventsToAPI() {
                try {
                    // Only send events that haven't been synced yet
                    const newEvents = this.events.filter(e => e.ordinal > this.lastSyncedOrdinal);
                    if (newEvents.length === 0) {
                        console.log('DB: No new events to sync');
                        return;
                    }

                    // Send each event individually (API expects one event per request)
                    for (const event of newEvents) {
                        console.log(`DB: Syncing event ${event.id} (ordinal ${event.ordinal})`);
                        await ContentAPI.saveSiteEvent(event);
                        // Update lastSyncedOrdinal after each successful sync
                        this.lastSyncedOrdinal = event.ordinal;
                        localStorage.setItem('swt_lastSyncedOrdinal', this.lastSyncedOrdinal.toString());
                    }
                } catch (err) {
                    console.error('DB: Error saving events to API', err);
                }
            },

            async saveContent() {
                await ContentAPI.saveContent(this.content);
            },

            async loadContent() {
                this.content = await ContentAPI.getContent();
                return this.content;
            },

            // Site Data methods
            getSiteData() {
                return this.siteData;
            },

            async setSiteData(data) {
                this.siteData = data;
                localStorage.setItem('siteData', JSON.stringify(data));
                try {
                    await ContentAPI.saveSiteData(data);
                    Webhooks.log('site_data_update', { access_type: 'content' });
                } catch (err) {
                    console.error('DB: Error saving site data to API', err);
                }
            },

            // Site Theme methods
            getSiteTheme() {
                return this.siteTheme;
            },

            async setSiteTheme(theme) {
                this.siteTheme = theme;
                localStorage.setItem('siteTheme', JSON.stringify(theme));
                try {
                    await ContentAPI.saveSiteTheme(theme);
                    Webhooks.log('site_theme_update', { access_type: 'style' });
                } catch (err) {
                    console.error('DB: Error saving site theme to API', err);
                }
            },

            generateId(prefix) {
                return `${prefix}_${Math.random().toString(36).substr(2, 8)}`;
            },

            createEvent(eventType, operator, frame, recordId, payload, actor = 'admin') {
                this.ordinal++;
                const event = {
                    id: this.generateId('evt'),
                    ordinal: this.ordinal,
                    created_at: new Date().toISOString(),
                    event_type: eventType,
                    operator: operator,
                    frame: frame,
                    record_id: recordId,
                    actor: actor,
                    payload: payload
                };
                this.events.push(event);
                this._invalidateCache(frame); // Clear memoization cache for this frame
                this.save();
                return event;
            },

            // INS - Instance/Create
            insRecord(frame, fields, recordId = null, actor = 'admin') {
                if (!recordId) {
                    const prefix = frame.endsWith('s') ? frame.slice(0, -1).slice(0, 3) : frame.slice(0, 3);
                    recordId = this.generateId(prefix);
                }
                const payload = { INS: { id: recordId, fields: fields } };
                return this.createEvent('given', 'INS', frame, recordId, payload, actor);
            },

            // ALT - Alter/Update
            altRecord(frame, recordId, field, oldValue, newValue, actor = 'admin') {
                const payload = { ALT: { field: field, old_value: oldValue, new_value: newValue } };
                return this.createEvent('given', 'ALT', frame, recordId, payload, actor);
            },

            // NUL - Archive/Delete
            nulRecord(frame, recordId, reason, actor = 'admin') {
                const currentState = this.getCurrentState(recordId, frame);
                const payload = { NUL: { reason: reason, snapshot: currentState } };
                return this.createEvent('meant', 'NUL', frame, recordId, payload, actor);
            },

            // Get events for a specific record
            getEventsForRecord(recordId, frame) {
                return this.events
                    .filter(e => e.record_id === recordId && e.frame === frame)
                    .sort((a, b) => a.ordinal - b.ordinal);
            },

            // Derive current state from events
            deriveState(events) {
                let state = {};
                for (const event of events) {
                    const op = event.operator;
                    const payload = event.payload;

                    if (op === 'INS') {
                        state = { ...payload.INS.fields };
                        state.id = payload.INS.id || event.record_id;
                        state._created_at = event.created_at;
                    } else if (op === 'ALT') {
                        state[payload.ALT.field] = payload.ALT.new_value;
                        state._updated_at = event.created_at;
                    } else if (op === 'NUL') {
                        return null; // Deleted
                    }
                }
                return state;
            },

            // Get current state for a single record
            getCurrentState(recordId, frame) {
                const events = this.getEventsForRecord(recordId, frame);
                if (events.length === 0) return null;
                return this.deriveState(events);
            },

            // Get all current states for a frame (with memoization)
            getAllCurrentStates(frame, filters = null) {
                // Check cache first (without filters - we filter after)
                if (!this._stateCache[frame]) {
                    const recordIds = [...new Set(
                        this.events
                            .filter(e => e.frame === frame && e.record_id)
                            .map(e => e.record_id)
                    )];

                    const allStates = [];
                    for (const recordId of recordIds) {
                        const state = this.getCurrentState(recordId, frame);
                        if (state) {
                            allStates.push(state);
                        }
                    }
                    this._stateCache[frame] = allStates;
                }

                // Apply filters if needed
                if (!filters) {
                    return this._stateCache[frame];
                }

                return this._stateCache[frame].filter(state => {
                    for (const [key, value] of Object.entries(filters)) {
                        if (state[key] !== value) return false;
                    }
                    return true;
                });
            },

            // Invalidate state cache (call when events change)
            _invalidateCache(frame = null) {
                if (frame) {
                    delete this._stateCache[frame];
                } else {
                    this._stateCache = {};
                }
            },

            // Get events with filters
            getEvents(frame = null, operator = null, limit = 100) {
                let filtered = [...this.events];
                if (frame) filtered = filtered.filter(e => e.frame === frame);
                if (operator) filtered = filtered.filter(e => e.operator === operator);
                return filtered.sort((a, b) => b.ordinal - a.ordinal).slice(0, limit);
            },

            // Get stats
            getStats() {
                const orgs = this.getAllCurrentStates('organizations');
                const campaigns = this.getAllCurrentStates('campaigns');
                const submissions = this.getAllCurrentStates('submissions');

                return {
                    total_organizations: orgs.length,
                    verified_organizations: orgs.filter(o => o.status === 'verified').length,
                    active_campaigns: campaigns.filter(c => c.status === 'active').length,
                    pending_submissions: submissions.filter(s => s.status === 'pending').length,
                    total_events: this.events.length
                };
            },

            // Content Management (for website content like posts/pages)
            getContent(filters = {}) {
                let results = [...this.content];
                if (filters.category) results = results.filter(c => c.category === filters.category);
                if (filters.is_published !== undefined) {
                    const published = filters.is_published === 'true' || filters.is_published === true;
                    results = results.filter(c => c.is_published === published);
                }
                return results.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
            },

            getContentById(id) {
                return this.content.find(c => c.id === id);
            },

            getContentBySlug(slug) {
                return this.content.find(c => c.slug === slug);
            },

            async createContent(data) {
                const id = this.content.length > 0 ? Math.max(...this.content.map(c => c.id)) + 1 : 1;
                const content = {
                    id,
                    ...data,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                if (content.is_published && !content.published_date) {
                    content.published_date = new Date().toISOString();
                }
                this.content.push(content);
                await this.saveContent();
                Webhooks.log('content_create', { access_type: 'content', data: content });
                return content;
            },

            async updateContent(id, data) {
                const index = this.content.findIndex(c => c.id === id);
                if (index === -1) throw new Error('Content not found');
                const updated = {
                    ...this.content[index],
                    ...data,
                    updated_at: new Date().toISOString()
                };
                if (updated.is_published && !updated.published_date) {
                    updated.published_date = new Date().toISOString();
                }
                this.content[index] = updated;
                await this.saveContent();
                Webhooks.log('content_update', { access_type: 'content', content_id: id, data: updated });
                return updated;
            },

            async deleteContent(id) {
                const index = this.content.findIndex(c => c.id === id);
                if (index === -1) throw new Error('Content not found');
                this.content.splice(index, 1);
                await this.saveContent();
                Webhooks.log('content_delete', { access_type: 'content', content_id: id });
                return { success: true };
            },

            getContentCategories() {
                const categories = [...new Set(this.content.map(c => c.category).filter(Boolean))];
                return { categories };
            }
        };

        // ============================================
        // SEED DATA (if empty)
        // ============================================

        function seedDatabase() {
            if (DB.events.length > 0) return;

            // Languages
            const languages = [
                { code: 'en', name: 'English', native_name: 'English' },
                { code: 'es', name: 'Spanish', native_name: 'Espaol' },
                { code: 'ar', name: 'Arabic', native_name: '' },
                { code: 'ku', name: 'Kurdish', native_name: 'Kurd' },
                { code: 'so', name: 'Somali', native_name: 'Soomaali' }
            ];
            languages.forEach(l => DB.insRecord('languages', l, l.code));

            // Regions
            const regions = [
                { name: 'Statewide', type: 'statewide', counties: [] },
                { name: 'Nashville Metro', type: 'metro', counties: ['Davidson', 'Williamson', 'Rutherford'] },
                { name: 'Memphis Metro', type: 'metro', counties: ['Shelby', 'Tipton'] },
                { name: 'East Tennessee', type: 'multi_county', counties: ['Knox', 'Hamilton'] }
            ];
            regions.forEach(r => DB.insRecord('regions', r, r.name.toLowerCase().replace(/\s+/g, '-')));

            // Service Types
            const services = [
                { name: 'Legal', parent_id: null },
                { name: 'Immigration Legal Services', parent_id: 'legal' },
                { name: 'Know Your Rights', parent_id: 'legal' },
                { name: 'Food', parent_id: null },
                { name: 'Food Pantry', parent_id: 'food' },
                { name: 'Hot Meals', parent_id: 'food' },
                { name: 'Housing', parent_id: null },
                { name: 'Rent Assistance', parent_id: 'housing' },
                { name: 'Emergency Shelter', parent_id: 'housing' }
            ];
            services.forEach(s => DB.insRecord('services', s, s.name.toLowerCase().replace(/\s+/g, '-')));

            // Sample Organizations
            const orgs = [
                { name: 'Conexin Amricas', organization_type: 'nonprofit', description: 'Comprehensive services for immigrants in Nashville', status: 'verified', service_types: ['legal', 'education'] },
                { name: 'Latino Memphis', organization_type: 'nonprofit', description: 'Supporting the Latino community in Memphis', status: 'verified', service_types: ['legal', 'food'] },
                { name: 'Bridge Refugee Services', organization_type: 'nonprofit', description: 'Refugee resettlement in East Tennessee', status: 'verified', service_types: ['resettlement'] },
                { name: 'Community Food Pantry', organization_type: 'mutual_aid', description: 'Weekly food distribution', status: 'pending', service_types: ['food-pantry'] }
            ];
            orgs.forEach(o => DB.insRecord('organizations', o));

            // Sample Campaigns
            const campaigns = [
                { title: 'Help Maria\'s Family', platform: 'gofundme', external_url: 'https://gofundme.com/example1', campaign_type: 'individual_family', status: 'active', description: 'Supporting a family facing deportation' },
                { title: 'Bond Fund for Memphis', platform: 'givebutter', external_url: 'https://givebutter.com/example2', campaign_type: 'bond_fund', status: 'active', description: 'Community bond fund' },
                { title: 'Emergency Legal Fund', platform: 'paypal', external_url: 'https://paypal.me/example3', campaign_type: 'legal_fund', status: 'goal_met', description: 'Legal defense fund' }
            ];
            campaigns.forEach(c => DB.insRecord('campaigns', c));

            // Sample Submissions
            const submissions = [
                { entity_type: 'organization', raw_data: { name: 'Casa de la Comunidad', type: 'Mutual Aid' }, submitter_email: 'maria@email.com', submitter_relation: 'I volunteer here', status: 'pending' },
                { entity_type: 'campaign', raw_data: { title: 'Help the Garcia Family', platform: 'GoFundMe' }, submitter_email: 'friend@email.com', submitter_relation: 'Family friend', status: 'pending' }
            ];
            submissions.forEach(s => DB.insRecord('submissions', s));

            console.log('Database seeded with sample data');
        }

        seedDatabase();

        // ============================================
        // LOGIN SYSTEM (Esc x3)
        // ============================================

        const PASSWORD_HASH = '156cbdc95b133c6cb10ffa9c0b62a576ab1c9bd7e5db21664d936a84c235dfcf';
        let isLoggedIn = false;

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showLoginModal() {
            document.getElementById('loginBackdrop').classList.add('active');
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('passwordInput').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginBackdrop').classList.remove('active');
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const password = document.getElementById('passwordInput').value;
            const hash = await sha256(password);
            const loginSuccess = hash === PASSWORD_HASH;

            if (loginSuccess) {
                isLoggedIn = true;

                // Only send webhook on successful login
                Webhooks.log('login_success', { access_type: 'logging' });

                hideLoginModal();
                showAdminDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('loginBtn').click();
        });

        document.getElementById('loginBackdrop').addEventListener('click', hideLoginModal);

        // ============================================
        // ADMIN DASHBOARD
        // ============================================

        function showAdminDashboard() {
            // Open content editor as the default admin view
            openContentEditor();
        }

        function showAdminDashboardClassic() {
            // Legacy: show the classic dashboard with sidebar
            document.getElementById('public-site').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('active');
            loadDashboard();
        }

        function exitAdmin() {
            document.getElementById('admin-dashboard').classList.remove('active');
            document.getElementById('content-editor-view').classList.remove('active');
            document.getElementById('public-site').classList.remove('hidden');
        }

        // Navigation
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                showSection(section);
            });
        });

        function showSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`)?.classList.add('active');

            loadSectionData(sectionId);
        }

        function loadSectionData(section) {
            switch (section) {
                case 'dashboard': loadDashboard(); break;
                case 'organizations': loadOrganizations(); break;
                case 'campaigns': loadCampaigns(); break;
                case 'submissions': loadSubmissions(); break;
                case 'services': loadServices(); break;
                case 'regions': loadRegions(); break;
                case 'languages': loadLanguages(); break;
                case 'events': loadEvents(); break;
                case 'site-config': loadSiteConfig(); break;
                case 'outward-content': loadOutwardContent(); break;
            }
        }

        // Dashboard - Uses localStorage
        function loadDashboard() {
            const stats = DB.getStats();
            document.getElementById('stat-orgs').textContent = stats.total_organizations;
            document.getElementById('stat-verified').textContent = stats.verified_organizations;
            document.getElementById('stat-campaigns').textContent = stats.active_campaigns;
            document.getElementById('stat-submissions').textContent = stats.pending_submissions;
            document.getElementById('submissions-badge').textContent = stats.pending_submissions;

            const events = DB.getEvents(null, null, 5);
            document.getElementById('recent-events').innerHTML = events.length === 0
                ? '<div class="empty">No events yet</div>'
                : events.map(e => `<p style="padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                    <strong>${e.operator}</strong> on ${e.frame} - ${formatDate(e.created_at)}</p>`).join('');
        }

        // Organizations - Uses localStorage
        function loadOrganizations() {
            const tbody = document.getElementById('organizations-table');
            const orgs = DB.getAllCurrentStates('organizations');

            if (orgs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">No organizations found</td></tr>';
                return;
            }

            tbody.innerHTML = orgs.map(org => `
                <tr>
                    <td><strong>${escapeHtml(org.name)}</strong></td>
                    <td>${escapeHtml(org.organization_type || '')}</td>
                    <td>${(org.service_types || []).slice(0, 3).join(', ')}</td>
                    <td><span class="status status-${org.status || 'draft'}"><span class="status-dot"></span>${org.status || 'draft'}</span></td>
                    <td><button class="btn btn-sm btn-secondary" onclick="deleteRecord('organizations', '${org.id}')">Archive</button></td>
                </tr>
            `).join('');

            // Populate service checkboxes in modal
            const services = DB.getAllCurrentStates('services').filter(s => !s.parent_id);
            document.getElementById('org-services-checkboxes').innerHTML = services.map(s =>
                `<label class="checkbox-item"><input type="checkbox" name="service_types" value="${s.id}"> ${s.name}</label>`
            ).join('');
        }

        function submitOrganization() {
            const form = document.getElementById('org-form');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (key === 'service_types') {
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            });

            const editId = form.dataset.editId;
            if (editId) {
                // Update existing record - only send ALT events for changed values
                const existing = DB.getCurrentState(editId, 'organizations');
                Object.entries(data).forEach(([key, value]) => {
                    if (!valuesEqual(existing[key], value)) {
                        DB.altRecord('organizations', editId, key, existing[key], value);
                    }
                });
                Webhooks.log('organization_update', { access_type: 'content', id: editId, data: data });
                delete form.dataset.editId;
                // Reset modal title
                document.querySelector('#org-modal .modal-header h3').textContent = 'Add Organization';
                document.querySelector('#org-modal .modal-footer .btn-primary').textContent = 'Create Organization';
            } else {
                // Create new record
                DB.insRecord('organizations', data);
                Webhooks.log('organization_create', { access_type: 'content', data: data });
            }

            closeModal('org-modal');
            form.reset();
            loadOrganizations();
            loadDashboard();
            // Re-render based on mode
            if (isEditMode) {
                renderPublicSiteEditMode();
                updatePanelLists();
            } else {
                renderPublicSite();
            }
        }

        // Campaigns - Uses localStorage
        function loadCampaigns() {
            const tbody = document.getElementById('campaigns-table');
            const campaigns = DB.getAllCurrentStates('campaigns');

            if (campaigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">No campaigns found</td></tr>';
                return;
            }

            tbody.innerHTML = campaigns.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.title)}</strong></td>
                    <td>${escapeHtml(c.platform || '')}</td>
                    <td>${escapeHtml(c.campaign_type || '')}</td>
                    <td><span class="status status-${c.status || 'active'}"><span class="status-dot"></span>${c.status || 'active'}</span></td>
                    <td><button class="btn btn-sm btn-secondary" onclick="deleteRecord('campaigns', '${c.id}')">Archive</button></td>
                </tr>
            `).join('');
        }

        function submitCampaign() {
            const form = document.getElementById('campaign-form');
            const data = Object.fromEntries(new FormData(form));
            if (data.goal_amount) data.goal_amount = parseFloat(data.goal_amount);

            const editId = form.dataset.editId;
            if (editId) {
                // Update existing record - only send ALT events for changed values
                const existing = DB.getCurrentState(editId, 'campaigns');
                Object.entries(data).forEach(([key, value]) => {
                    if (!valuesEqual(existing[key], value)) {
                        DB.altRecord('campaigns', editId, key, existing[key], value);
                    }
                });
                Webhooks.log('campaign_update', { access_type: 'content', id: editId, data: data });
                delete form.dataset.editId;
                // Reset modal title
                document.querySelector('#campaign-modal .modal-header h3').textContent = 'Add Campaign';
                document.querySelector('#campaign-modal .modal-footer .btn-primary').textContent = 'Add Campaign';
            } else {
                // Create new record
                DB.insRecord('campaigns', data);
                Webhooks.log('campaign_create', { access_type: 'content', data: data });
            }

            closeModal('campaign-modal');
            form.reset();
            loadCampaigns();
            loadDashboard();
            // Re-render based on mode
            if (isEditMode) {
                renderPublicSiteEditMode();
                updatePanelLists();
            } else {
                renderPublicSite();
            }
        }

        // Submissions - Uses localStorage
        function loadSubmissions() {
            const submissions = DB.getAllCurrentStates('submissions').filter(s => s.status === 'pending');
            renderSubmissions(submissions);
        }

        function renderSubmissions(submissions) {
            const container = document.getElementById('submissions-list');
            const alert = document.getElementById('submissions-alert');

            if (submissions.length > 0) {
                alert.style.display = 'flex';
                document.getElementById('submissions-alert-title').textContent =
                    `${submissions.length} submission${submissions.length > 1 ? 's' : ''} awaiting review`;
            } else {
                alert.style.display = 'none';
            }

            if (submissions.length === 0) {
                container.innerHTML = '<div class="empty">No pending submissions</div>';
                return;
            }

            container.innerHTML = submissions.map(sub => `
                <div class="review-item">
                    <div class="review-item-header">
                        <div>
                            <strong>${sub.entity_type === 'organization' ? 'New Organization' :
                                     sub.entity_type === 'campaign' ? 'New Campaign' : 'Correction'}</strong>
                            <span style="color: var(--gray-500); margin-left: 8px;">#${sub.id}</span>
                        </div>
                        <div class="review-item-meta">
                            ${sub.submitter_email ? `<span> ${escapeHtml(sub.submitter_email)}</span>` : ''}
                        </div>
                    </div>
                    <div class="review-item-body">
                        <dl class="review-item-data">
                            ${Object.entries(sub.raw_data || {}).map(([k, v]) =>
                                `<dt>${escapeHtml(k)}</dt><dd>${escapeHtml(String(v))}</dd>`
                            ).join('')}
                            ${sub.submitter_relation ? `<dt>Relation</dt><dd>"${escapeHtml(sub.submitter_relation)}"</dd>` : ''}
                        </dl>
                    </div>
                    <div class="review-item-actions">
                        <button class="btn btn-approve" onclick="reviewSubmission('${sub.id}', 'approve')"> Approve</button>
                        <button class="btn btn-reject" onclick="reviewSubmission('${sub.id}', 'reject')"> Reject</button>
                    </div>
                </div>
            `).join('');
        }

        function reviewSubmission(id, action) {
            const newStatus = action === 'approve' ? 'approved' : 'rejected';
            DB.altRecord('submissions', id, 'status', 'pending', newStatus);
            Webhooks.log('submission_review', { access_type: 'logging', submission_id: id, action: action });
            loadSubmissions();
            loadDashboard();
        }

        // Services - Uses localStorage
        function loadServices() {
            const services = DB.getAllCurrentStates('services');
            renderServices(services);
        }

        function renderServices(services) {
            const container = document.getElementById('services-list');

            if (!services || services.length === 0) {
                container.innerHTML = '<div class="empty">No service types found</div>';
                return;
            }

            const parents = services.filter(s => !s.parent_id);
            const children = services.filter(s => s.parent_id);

            let html = '';
            parents.forEach(parent => {
                html += `<div style="margin-bottom: 20px;">
                    <strong style="font-size: 16px;">${escapeHtml(parent.name)}</strong>
                    <div style="margin-left: 24px; margin-top: 8px; display: flex; flex-direction: column; gap: 6px;">`;

                children.filter(c => c.parent_id === parent.id).forEach(child => {
                    html += `<div style="padding: 8px 12px; background: var(--gray-50); border-radius: 6px;">
                        ${escapeHtml(child.name)}</div>`;
                });

                html += '</div></div>';
            });

            // Update parent select
            const select = document.getElementById('service-parent-select');
            select.innerHTML = '<option value="">None (top-level)</option>' +
                parents.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');

            container.innerHTML = html || '<div class="empty">No service types found</div>';
        }

        function submitService() {
            const form = document.getElementById('service-form');
            const data = Object.fromEntries(new FormData(form));
            if (!data.parent_id) delete data.parent_id;

            DB.insRecord('services', data, data.id);
            Webhooks.log('service_create', { access_type: 'content', data: data });

            closeModal('service-modal');
            form.reset();
            loadServices();
        }

        // Regions - Uses localStorage
        function loadRegions() {
            const regions = DB.getAllCurrentStates('regions');
            renderRegions(regions);
        }

        function renderRegions(regions) {
            const tbody = document.getElementById('regions-table');

            if (!regions || regions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">No regions found</td></tr>';
                return;
            }

            tbody.innerHTML = regions.map(r => `
                <tr>
                    <td><strong>${escapeHtml(r.name)}</strong></td>
                    <td>${escapeHtml(r.type)}</td>
                    <td>${(r.counties || []).join(', ')}</td>
                </tr>
            `).join('');
        }

        function submitRegion() {
            const form = document.getElementById('region-form');
            const data = Object.fromEntries(new FormData(form));
            data.counties = data.counties ? data.counties.split(',').map(c => c.trim()) : [];

            DB.insRecord('regions', data, data.id);
            Webhooks.log('region_create', { access_type: 'content', data: data });

            closeModal('region-modal');
            form.reset();
            loadRegions();
        }

        // Languages - Uses localStorage
        function loadLanguages() {
            const languages = DB.getAllCurrentStates('languages');
            renderLanguages(languages);
        }

        function renderLanguages(languages) {
            const tbody = document.getElementById('languages-table');

            if (!languages || languages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">No languages found</td></tr>';
                return;
            }

            tbody.innerHTML = languages.map(l => `
                <tr>
                    <td>${escapeHtml(l.code)}</td>
                    <td>${escapeHtml(l.name)}</td>
                    <td>${escapeHtml(l.native_name)}</td>
                </tr>
            `).join('');
        }

        // Events - Uses localStorage
        function loadEvents() {
            const frameFilter = document.getElementById('event-frame-filter').value;
            const operatorFilter = document.getElementById('event-operator-filter').value;
            const events = DB.getEvents(frameFilter || null, operatorFilter || null, 100);

            // Update event count
            const countEl = document.getElementById('event-count');
            if (countEl) {
                const totalEvents = DB.events.length;
                countEl.textContent = `${events.length} of ${totalEvents} events`;
            }

            renderEvents(events);
        }

        function renderEvents(events) {
            const tbody = document.getElementById('events-table');

            if (!events || events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">No events found. Activity will appear here as you make changes.</td></tr>';
                return;
            }

            const opColors = {
                'INS': '#10b981',
                'ALT': '#3b82f6',
                'NUL': '#ef4444',
                'CON': '#8b5cf6'
            };

            tbody.innerHTML = events.map(e => `
                <tr>
                    <td style="color: var(--gray-400);">${e.ordinal}</td>
                    <td>${formatDate(e.created_at)}</td>
                    <td><span style="font-size: 11px; padding: 2px 6px; background: ${e.event_type === 'given' ? '#dbeafe' : '#fef3c7'}; border-radius: 4px;">${e.event_type}</span></td>
                    <td><span style="color: ${opColors[e.operator] || '#6b7280'}; font-weight: 600;">${e.operator}</span></td>
                    <td>${e.frame}</td>
                    <td style="font-family: monospace; font-size: 12px;">${e.record_id || '-'}</td>
                    <td>${e.actor || '-'}</td>
                </tr>
            `).join('');
        }

        // ============================================
        // CONTENT MANAGEMENT (Xano API)
        // ============================================

        async function loadOutwardContent() {
            const tbody = document.getElementById('content-table');
            tbody.innerHTML = '<tr><td colspan="6" class="empty">Loading content...</td></tr>';

            await DB.loadContent();
            const content = DB.getContent();

            if (!content || content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No content found. Click "+ Add Content" to create your first post.</td></tr>';
                return;
            }

            tbody.innerHTML = content.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.title)}</strong></td>
                    <td><code>${escapeHtml(c.slug)}</code></td>
                    <td>${escapeHtml(c.category || '-')}</td>
                    <td><span class="status status-${c.is_published ? 'verified' : 'draft'}">
                        <span class="status-dot"></span>${c.is_published ? 'Published' : 'Draft'}</span></td>
                    <td>${c.published_date ? formatDate(c.published_date) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editContent(${c.id})">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteContentItem(${c.id})" style="margin-left: 4px;">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Load categories for filter
            loadContentCategories();
        }

        function loadContentCategories() {
            const { categories } = DB.getContentCategories();
            const select = document.getElementById('content-category-filter');
            select.innerHTML = '<option value="">All Categories</option>' +
                (categories || []).map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        }

        function editContent(id) {
            const item = DB.getContentById(id);
            if (!item) {
                alert('Content not found');
                return;
            }

            document.getElementById('content-modal-title').textContent = 'Edit Content';
            document.getElementById('content-id').value = item.id;
            document.getElementById('content-title').value = item.title || '';
            document.getElementById('content-slug').value = item.slug || '';
            document.getElementById('content-category').value = item.category || '';
            document.getElementById('content-summary').value = item.summary || '';
            document.getElementById('content-html').value = item.content_html || '';
            document.getElementById('content-image').value = item.featured_image || '';
            document.getElementById('content-tags').value = (item.tags || []).join(', ');
            document.getElementById('content-published').checked = item.is_published || false;

            openModal('content-modal');
        }

        async function submitContent() {
            const form = document.getElementById('content-form');
            const formData = new FormData(form);

            const data = {
                title: formData.get('title'),
                slug: formData.get('slug'),
                content_html: formData.get('content_html'),
                summary: formData.get('summary') || null,
                category: formData.get('category') || null,
                featured_image: formData.get('featured_image') || null,
                tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()).filter(t => t) : [],
                is_published: document.getElementById('content-published').checked
            };

            const id = document.getElementById('content-id').value;

            if (id) {
                await DB.updateContent(parseInt(id), data);
            } else {
                await DB.createContent(data);
            }

            closeModal('content-modal');
            form.reset();
            document.getElementById('content-id').value = '';
            document.getElementById('content-modal-title').textContent = 'Add Content';
            await loadOutwardContent();
        }

        async function deleteContentItem(id) {
            if (!confirm('Are you sure you want to delete this content?')) return;

            await DB.deleteContent(id);
            await loadOutwardContent();
        }

        // Auto-generate slug from title
        document.getElementById('content-title')?.addEventListener('input', (e) => {
            const slugInput = document.getElementById('content-slug');
            if (!document.getElementById('content-id').value) {
                slugInput.value = e.target.value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
        });

        // Site Config
        function loadSiteConfig() {
            // Use DB.getSiteData() which pulls from API/localStorage
            const siteData = DB.getSiteData() || JSON.parse(localStorage.getItem('siteData') || '{}');
            // Header
            document.getElementById('config-siteName').value = siteData.siteName || '';
            document.getElementById('config-donateUrl').value = siteData.donateUrl || '';
            // Hero
            document.getElementById('config-heroTitle').value = siteData.heroTitle || '';
            document.getElementById('config-heroDescription').value = siteData.heroDescription || '';
            document.getElementById('config-featuredButton1Text').value = siteData.featuredButton1Text || '';
            document.getElementById('config-featuredButton1Url').value = siteData.featuredButton1Url || '';
            // Mutual Aid
            document.getElementById('config-mutualAidTitle').value = siteData.mutualAidTitle || '';
            document.getElementById('config-mutualAidDescription').value = siteData.mutualAidDescription || '';
            // Crowdfunding
            document.getElementById('config-crowdfundingTitle').value = siteData.crowdfundingTitle || '';
            document.getElementById('config-crowdfundingDescription').value = siteData.crowdfundingDescription || '';
            // Organizations
            document.getElementById('config-orgsTitle').value = siteData.orgsTitle || '';
            document.getElementById('config-orgsDescription').value = siteData.orgsDescription || '';
            // Footer
            document.getElementById('config-footerText').value = siteData.footerText || '';
            document.getElementById('config-contactEmail').value = siteData.contactEmail || '';
        }

        async function saveSiteConfig() {
            const siteData = {
                // Header
                siteName: document.getElementById('config-siteName').value,
                donateUrl: document.getElementById('config-donateUrl').value,
                // Hero
                heroTitle: document.getElementById('config-heroTitle').value,
                heroDescription: document.getElementById('config-heroDescription').value,
                featuredButton1Text: document.getElementById('config-featuredButton1Text').value,
                featuredButton1Url: document.getElementById('config-featuredButton1Url').value,
                // Mutual Aid
                mutualAidTitle: document.getElementById('config-mutualAidTitle').value,
                mutualAidDescription: document.getElementById('config-mutualAidDescription').value,
                // Crowdfunding
                crowdfundingTitle: document.getElementById('config-crowdfundingTitle').value,
                crowdfundingDescription: document.getElementById('config-crowdfundingDescription').value,
                // Organizations
                orgsTitle: document.getElementById('config-orgsTitle').value,
                orgsDescription: document.getElementById('config-orgsDescription').value,
                // Footer
                footerText: document.getElementById('config-footerText').value,
                contactEmail: document.getElementById('config-contactEmail').value
            };

            // Save to API and localStorage via DB
            await DB.setSiteData(siteData);

            // Apply to page
            Object.keys(siteData).forEach(key => {
                const el = document.querySelector(`[data-editable="${key}"]`);
                if (el && siteData[key]) {
                    const attrName = el.getAttribute('data-editable-attr');
                    if (attrName) {
                        // Handle multiple attributes (e.g., "href,text")
                        const attrs = attrName.split(',');
                        attrs.forEach(attr => {
                            if (attr === 'text') {
                                el.textContent = siteData[key];
                            } else if (attr === 'href' && key === 'contactEmail') {
                                el.setAttribute('href', 'mailto:' + siteData[key]);
                            } else {
                                el.setAttribute(attr, siteData[key]);
                            }
                        });
                    } else {
                        el.textContent = siteData[key];
                    }
                }
            });

            alert('Site configuration saved to API!');
        }

        function exportSiteData() {
            const data = {
                events: DB.events,
                ordinal: DB.ordinal,
                content: DB.content,
                siteData: DB.getSiteData(),
                siteTheme: DB.getSiteTheme()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'swt-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // SITE PREVIEW - Admin Preview Functionality
        // ============================================

        let currentPreviewMode = 'all'; // 'all' or 'live'

        function openPreviewModal() {
            document.getElementById('preview-modal').classList.add('active');
            renderPreview();
        }

        function closePreviewModal() {
            document.getElementById('preview-modal').classList.remove('active');
        }

        function setPreviewMode(mode) {
            currentPreviewMode = mode;

            // Update toggle buttons
            document.getElementById('preview-btn-all').classList.toggle('active', mode === 'all');
            document.getElementById('preview-btn-live').classList.toggle('active', mode === 'live');

            // Update badge and banner
            const badge = document.getElementById('preview-mode-badge');
            const banner = document.getElementById('preview-banner');

            if (mode === 'all') {
                badge.textContent = 'Preview Mode';
                badge.style.background = 'var(--orange)';
                banner.style.display = 'block';
                banner.textContent = 'PREVIEW MODE - Showing all content including drafts and unpublished items';
            } else {
                badge.textContent = 'Live View';
                badge.style.background = 'var(--green)';
                banner.style.display = 'block';
                banner.style.background = 'var(--green)';
                banner.textContent = 'LIVE VIEW - Showing only published content (what visitors see)';
            }

            renderPreview();
        }

        function renderPreview() {
            const container = document.getElementById('preview-content');
            const showAll = currentPreviewMode === 'all';

            const allOrgs = DB.getAllCurrentStates('organizations');
            const allCampaigns = DB.getAllCurrentStates('campaigns');

            let orgs, campaigns;
            if (showAll) {
                orgs = allOrgs;
                campaigns = allCampaigns;
            } else {
                orgs = allOrgs.filter(o => o.status === 'verified');
                campaigns = allCampaigns.filter(c => c.status === 'active');
            }

            // Get site config from API via DB
            const siteData = DB.getSiteData() || {};

            // Build preview HTML - using API data with empty fallbacks (no hardcoded content)
            const heroTitle = siteData.heroTitle || '';
            const heroDescription = siteData.heroDescription || '';
            const featuredButtonText = siteData.featuredButton1Text || 'Learn More';
            const featuredButtonUrl = siteData.featuredButton1Url || '#';

            // Group organizations by type
            const orgsByType = {};
            orgs.forEach(o => {
                const type = o.organization_type || 'other';
                if (!orgsByType[type]) orgsByType[type] = [];
                orgsByType[type].push(o);
            });

            // Group campaigns by type
            const campaignsByType = {};
            campaigns.forEach(c => {
                const type = c.campaign_type || 'other';
                if (!campaignsByType[type]) campaignsByType[type] = [];
                campaignsByType[type].push(c);
            });

            // Mutual aid organizations
            const mutualAidOrgs = orgs.filter(o =>
                o.organization_type === 'mutual_aid' ||
                (o.service_types || []).some(s => s.includes('mutual') || s.includes('food'))
            );

            // Render preview HTML
            container.innerHTML = `
                <div style="font-family: var(--font-body); line-height: var(--line-height-normal);">
                    <!-- Header -->
                    <header style="position: sticky; top: 0; background: var(--header-bg); padding: 1rem var(--section-padding); display: flex; justify-content: space-between; align-items: center; border-bottom: var(--header-border); z-index: 10;">
                        <a href="#" style="font-size: 1.5rem; font-weight: bold; color: var(--header-text); text-decoration: none;">
                            ${escapeHtml(siteData.siteName || 'Stand With Tennessee')}
                        </a>
                        <nav style="display: flex; gap: 2rem; align-items: center;">
                            <a href="#preview-mutualaid" style="color: var(--header-text); text-decoration: none; font-weight: 500;">Mutual Aid</a>
                            <a href="#preview-crowdfunding" style="color: var(--header-text); text-decoration: none; font-weight: 500;">Crowdfunding</a>
                            <a href="#preview-orgs" style="color: var(--header-text); text-decoration: none; font-weight: 500;">Organizations</a>
                        </nav>
                    </header>

                    <!-- Hero Section -->
                    <section style="padding: 80px var(--section-padding); min-height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: var(--theme-background);">
                        <h1 style="font-size: 2.5rem; margin-bottom: 1.5rem; max-width: 900px; font-family: var(--font-heading);">${escapeHtml(heroTitle)}</h1>
                        <p style="margin-bottom: 1rem; max-width: 800px; color: var(--theme-text);">${escapeHtml(heroDescription)}</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin-top: 2rem;">
                            <a href="${escapeHtml(featuredButtonUrl)}" class="public-btn">
                                ${escapeHtml(featuredButtonText)}
                            </a>
                            <a href="#preview-mutualaid" class="public-btn">Mutual Aid</a>
                            <a href="#preview-orgs" class="public-btn">Organizations</a>
                        </div>
                    </section>

                    <!-- Mutual Aid Section -->
                    <section id="preview-mutualaid" style="padding: var(--section-padding-y) var(--section-padding); background: var(--section-dark-bg); color: var(--section-dark-text);">
                        <div style="max-width: var(--content-max-width); margin: 0 auto;">
                            <h2 style="font-size: 2rem; margin-bottom: 1rem; font-family: var(--font-heading);">${escapeHtml(siteData.mutualAidTitle || 'Mutual Aid & Materials')}</h2>
                            <p style="margin-bottom: 1rem; max-width: 800px;">${escapeHtml(siteData.mutualAidDescription || 'These funds are administered by neighbors helping their neighbors. One of the most direct ways to help.')}</p>
                            <div style="border-top: 1px solid currentColor;">
                                ${mutualAidOrgs.length > 0 ? `
                                    <div style="border-bottom: 1px solid currentColor;">
                                        <div style="padding: 1.5rem 0; display: flex; justify-content: space-between; cursor: pointer; font-size: 1.25rem; font-weight: 600;">
                                            <span>Mutual Aid Organizations (${mutualAidOrgs.length})</span>
                                        </div>
                                        <ul style="list-style: disc; margin-left: 1.5rem; padding-bottom: 1.5rem;">
                                            ${mutualAidOrgs.map(o => `
                                                <li style="margin-bottom: 0.75rem;">
                                                    <strong>${escapeHtml(o.name)}</strong>${renderStatusBadge(o.status, showAll)}: ${escapeHtml(o.description || '')}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : '<p style="padding: 1rem 0;">Check back soon for mutual aid resources.</p>'}
                            </div>
                        </div>
                    </section>

                    <!-- Crowdfunding Section -->
                    <section id="preview-crowdfunding" style="padding: var(--section-padding-y) var(--section-padding); background: var(--section-light-bg);">
                        <div style="max-width: var(--content-max-width); margin: 0 auto;">
                            <h2 style="font-size: 2rem; margin-bottom: 1rem; font-family: var(--font-heading);">${escapeHtml(siteData.crowdfundingTitle || 'Crowdfunding Campaigns')}</h2>
                            <p style="margin-bottom: 1rem; max-width: 800px;">${escapeHtml(siteData.crowdfundingDescription || 'Active campaigns that need support. Updated regularly.')}</p>
                            <div style="border-top: 1px solid currentColor;">
                                ${Object.entries(campaignsByType).length > 0 ? Object.entries(campaignsByType).map(([type, campList]) => `
                                    <div style="border-bottom: 1px solid currentColor;">
                                        <div style="padding: 1.5rem 0; display: flex; justify-content: space-between; cursor: pointer; font-size: 1.25rem; font-weight: 600;">
                                            <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (${campList.length})</span>
                                        </div>
                                        <ul style="list-style: disc; margin-left: 1.5rem; padding-bottom: 1.5rem;">
                                            ${campList.map(c => `
                                                <li style="margin-bottom: 0.75rem;">
                                                    <a href="${escapeHtml(c.external_url || '#')}" target="_blank" style="color: inherit; font-weight: 600;">${escapeHtml(c.title)}</a>${renderStatusBadge(c.status, showAll, 'campaign')}: ${escapeHtml(c.description || '')}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                `).join('') : '<p style="padding: 1rem 0;">No active campaigns.</p>'}
                            </div>
                        </div>
                    </section>

                    <!-- Organizations Section -->
                    <section id="preview-orgs" style="padding: var(--section-padding-y) var(--section-padding); background: var(--theme-background);">
                        <div style="max-width: var(--content-max-width); margin: 0 auto;">
                            <h2 style="font-size: 2rem; margin-bottom: 1rem; font-family: var(--font-heading);">${escapeHtml(siteData.orgsTitle || 'Organizations On The Ground')}</h2>
                            <p style="margin-bottom: 1rem; max-width: 800px;">${escapeHtml(siteData.orgsDescription || 'Organizations doing direct service, jail support, and legal defense work.')}</p>
                            <div style="border-top: 1px solid currentColor;">
                                ${Object.entries(orgsByType).length > 0 ? Object.entries(orgsByType).map(([type, orgList]) => `
                                    <div style="border-bottom: 1px solid currentColor;">
                                        <div style="padding: 1.5rem 0; display: flex; justify-content: space-between; cursor: pointer; font-size: 1.25rem; font-weight: 600;">
                                            <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (${orgList.length})</span>
                                        </div>
                                        <ul style="list-style: disc; margin-left: 1.5rem; padding-bottom: 1.5rem;">
                                            ${orgList.map(o => `
                                                <li style="margin-bottom: 0.75rem;">
                                                    <strong>${escapeHtml(o.name)}</strong>${renderStatusBadge(o.status, showAll)}: ${escapeHtml(o.description || '')}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                `).join('') : '<p style="padding: 1rem 0;">No organizations available yet.</p>'}
                            </div>
                        </div>
                    </section>

                    <!-- Footer -->
                    <footer style="background: var(--footer-bg); color: var(--footer-text); padding: var(--footer-padding); text-align: center;">
                        <p>${escapeHtml(siteData.footerText || 'This directory is an independent project. We are not raising or distributing any funds.')}</p>
                        <p style="margin-top: 0.5rem;">Questions? <a href="mailto:${escapeHtml(siteData.contactEmail || 'contact@standwithtennessee.org')}" style="color: inherit;">${escapeHtml(siteData.contactEmail || 'contact@standwithtennessee.org')}</a></p>
                    </footer>
                </div>
            `;
        }

        function renderStatusBadge(status, showAll, type = 'org') {
            if (!showAll) return ''; // Don't show badges in live view

            const isLive = (type === 'campaign')
                ? status === 'active'
                : status === 'verified';

            if (isLive) return ''; // Don't badge live items

            const colors = {
                draft: { bg: '#fef3c7', text: '#92400e' },
                pending: { bg: '#dbeafe', text: '#1e40af' },
                goal_met: { bg: '#d1fae5', text: '#065f46' },
                closed: { bg: '#fee2e2', text: '#991b1b' }
            };

            const color = colors[status] || { bg: '#e5e7eb', text: '#374151' };

            return ` <span style="display: inline-block; background: ${color.bg}; color: ${color.text}; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 4px; vertical-align: middle;">${status.toUpperCase()}</span>`;
        }

        // Close preview modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('preview-modal').classList.contains('active')) {
                closePreviewModal();
                e.stopPropagation();
            }
        });

        // Delete record - Uses localStorage
        function deleteRecord(frame, recordId) {
            if (!confirm('Are you sure you want to archive this record?')) return;

            DB.nulRecord(frame, recordId, 'archived');
            Webhooks.log('record_delete', { access_type: 'logging', frame: frame, record_id: recordId });

            loadSectionData(frame);
            loadDashboard();
            renderPublicSite();
        }

        // ============================================
        // MODALS
        // ============================================

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');

            // Reset edit state when closing modals
            if (modalId === 'org-modal') {
                const form = document.getElementById('org-form');
                delete form.dataset.editId;
                form.reset();
                document.querySelector('#org-modal .modal-header h3').textContent = 'Add Organization';
                document.querySelector('#org-modal .modal-footer .btn-primary').textContent = 'Create Organization';
            } else if (modalId === 'campaign-modal') {
                const form = document.getElementById('campaign-form');
                delete form.dataset.editId;
                form.reset();
                document.querySelector('#campaign-modal .modal-header h3').textContent = 'Add Campaign';
                document.querySelector('#campaign-modal .modal-footer .btn-primary').textContent = 'Add Campaign';
            }
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    const modalId = overlay.id;
                    closeModal(modalId);
                }
            });
        });

        document.querySelectorAll('.checkbox-item input').forEach(cb => {
            cb.addEventListener('change', () => {
                cb.closest('.checkbox-item').classList.toggle('selected', cb.checked);
            });
        });

        // ============================================
        // PUBLIC SITE RENDERING - Uses API data via DB
        // ============================================

        function renderPublicSite() {
            const orgs = DB.getAllCurrentStates('organizations').filter(o => o.status === 'verified');
            const campaigns = DB.getAllCurrentStates('campaigns').filter(c => c.status === 'active');

            // Render organizations to public site
            const orgsByType = {};
            orgs.forEach(o => {
                const type = o.organization_type || 'other';
                if (!orgsByType[type]) orgsByType[type] = [];
                orgsByType[type].push(o);
            });

            const orgsAccordion = document.getElementById('orgs-accordion');
            orgsAccordion.innerHTML = Object.entries(orgsByType).map(([type, orgList]) => `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-content-inner">
                            <ul>
                                ${orgList.map(o => `<li><strong>${escapeHtml(o.name)}</strong>: ${escapeHtml(o.description || '')}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('') || '<p>No organizations available yet.</p>';

            // Render campaigns
            const campaignsByType = {};
            campaigns.forEach(c => {
                const type = c.campaign_type || 'other';
                if (!campaignsByType[type]) campaignsByType[type] = [];
                campaignsByType[type].push(c);
            });

            const cfAccordion = document.getElementById('crowdfunding-accordion');
            cfAccordion.innerHTML = Object.entries(campaignsByType).map(([type, campList]) => `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-content-inner">
                            <ul>
                                ${campList.map(c => `<li><a href="${escapeHtml(c.external_url || '#')}" target="_blank">${escapeHtml(c.title)}</a>: ${escapeHtml(c.description || '')}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('') || '<p>No active campaigns.</p>';

            // Mutual Aid
            const mutualAidOrgs = orgs.filter(o => o.organization_type === 'mutual_aid' || (o.service_types || []).some(s => s.includes('mutual') || s.includes('food')));
            const maAccordion = document.getElementById('mutualaid-accordion');
            maAccordion.innerHTML = mutualAidOrgs.length > 0 ? `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Mutual Aid Organizations</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-content-inner">
                            <ul>
                                ${mutualAidOrgs.map(o => `<li><strong>${escapeHtml(o.name)}</strong>: ${escapeHtml(o.description || '')}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            ` : '<p>Check back soon for mutual aid resources.</p>';

            // Re-attach accordion handlers
            initAccordions();

            // Render featured content from API (articles with featured images)
            renderFeaturedContent();

            // Apply site config from API via DB.getSiteData()
            const siteData = DB.getSiteData() || {};
            Object.keys(siteData).forEach(key => {
                const el = document.querySelector(`[data-editable="${key}"]`);
                if (el && siteData[key]) {
                    const attrName = el.getAttribute('data-editable-attr');
                    if (attrName) {
                        // Handle multiple attributes (e.g., "href,text")
                        const attrs = attrName.split(',');
                        attrs.forEach(attr => {
                            if (attr === 'text') {
                                el.textContent = siteData[key];
                            } else if (attr === 'href' && key === 'contactEmail') {
                                el.setAttribute('href', 'mailto:' + siteData[key]);
                            } else {
                                el.setAttribute(attr, siteData[key]);
                            }
                        });
                    } else {
                        el.textContent = siteData[key];
                    }
                }
            });
        }

        // Render featured content with images from API
        function renderFeaturedContent() {
            const featuredSection = document.getElementById('featured');
            const featuredContainer = document.getElementById('featured-content');
            if (!featuredContainer || !featuredSection) return;

            // Get published content with featured images
            const publishedContent = DB.getContent({ is_published: true })
                .filter(c => c.featured_image)
                .slice(0, 6); // Show up to 6 featured items

            if (publishedContent.length === 0) {
                featuredContainer.innerHTML = '';
                featuredSection.style.display = 'none';
                return;
            }

            featuredSection.style.display = 'block';
            featuredContainer.innerHTML = `
                <h2 style="font-size: 2rem; margin-bottom: 1.5rem;">Featured Content</h2>
                <div class="featured-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                    ${publishedContent.map(item => `
                        <article class="featured-card" style="background: var(--theme-surface, #f5f5f5); border-radius: var(--border-radius-md, 8px); overflow: hidden; box-shadow: var(--shadow-md);">
                            <div class="featured-image" style="aspect-ratio: 16/9; overflow: hidden;">
                                <img src="${escapeHtml(item.featured_image)}" alt="${escapeHtml(item.title)}"
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.parentElement.style.display='none'">
                            </div>
                            <div class="featured-content-inner" style="padding: 1rem;">
                                <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem;">${escapeHtml(item.title)}</h3>
                                ${item.summary ? `<p style="color: var(--theme-text-muted, #666); font-size: 0.9rem; margin-bottom: 0.75rem;">${escapeHtml(item.summary)}</p>` : ''}
                                ${item.category ? `<span style="display: inline-block; padding: 2px 8px; background: var(--theme-accent, #c8102e); color: white; font-size: 0.75rem; border-radius: 4px;">${escapeHtml(item.category)}</span>` : ''}
                            </div>
                        </article>
                    `).join('')}
                </div>
            `;
        }

        function initAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.onclick = () => {
                    const item = header.parentElement;
                    const content = item.querySelector('.accordion-content');
                    const isActive = item.classList.contains('active');

                    document.querySelectorAll('.accordion-item').forEach(i => {
                        i.classList.remove('active');
                        const c = i.querySelector('.accordion-content');
                        if (c) c.style.maxHeight = null;
                    });

                    if (!isActive) {
                        item.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                };
            });
        }

        // ============================================
        // UTILITIES
        // ============================================

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // ============================================
        // WYSIWYG EDIT MODE
        // ============================================

        let isEditMode = false;
        let currentLinkElement = null;
        let unsavedChanges = {};

        function enterEditMode() {
            isEditMode = true;
            document.body.classList.add('edit-mode');
            document.getElementById('edit-toolbar').classList.add('active');

            // Hide the old admin dashboard if open
            document.getElementById('admin-dashboard').classList.remove('active');
            document.getElementById('public-site').classList.remove('hidden');

            // Enable contenteditable on text elements
            enableEditableElements();

            // Re-render to show all items (including drafts) with edit buttons
            renderPublicSiteEditMode();

            // Update panel lists
            updatePanelLists();

            updateEditStatus('Click any highlighted text to edit');
        }

        function exitEditMode() {
            if (Object.keys(unsavedChanges).length > 0) {
                if (!confirm('You have unsaved changes. Exit anyway?')) {
                    return;
                }
            }

            isEditMode = false;
            document.body.classList.remove('edit-mode');
            document.body.classList.remove('panel-open');
            document.getElementById('edit-toolbar').classList.remove('active');
            document.getElementById('edit-panel').classList.remove('active');

            // Disable contenteditable
            document.querySelectorAll('[data-editable]').forEach(el => {
                el.contentEditable = 'false';
                el.removeEventListener('blur', handleTextBlur);
                el.removeEventListener('focus', handleTextFocus);
            });

            // Re-render public site normally (only verified/active items)
            renderPublicSite();
            unsavedChanges = {};
        }

        function enableEditableElements() {
            document.querySelectorAll('[data-editable]').forEach(el => {
                const hasAttr = el.getAttribute('data-editable-attr');

                if (hasAttr && hasAttr.includes('href')) {
                    // For links, use click handler
                    el.addEventListener('click', handleLinkClick);
                } else {
                    // For text, use contenteditable
                    el.contentEditable = 'true';
                    el.addEventListener('focus', handleTextFocus);
                    el.addEventListener('blur', handleTextBlur);
                }
            });
        }

        function handleTextFocus(e) {
            updateEditStatus('Editing: ' + e.target.getAttribute('data-editable'));
        }

        function handleTextBlur(e) {
            const key = e.target.getAttribute('data-editable');
            const newValue = e.target.textContent.trim();

            // Store the change
            unsavedChanges[key] = newValue;
            updateEditStatus('Changes pending - click Save to apply');
        }

        function handleLinkClick(e) {
            if (!isEditMode) return;

            e.preventDefault();
            e.stopPropagation();

            currentLinkElement = e.currentTarget;
            const key = currentLinkElement.getAttribute('data-editable');
            const currentUrl = currentLinkElement.getAttribute('href') || '';

            const popup = document.getElementById('link-edit-popup');
            const input = document.getElementById('link-edit-input');

            // Position popup near the element
            const rect = currentLinkElement.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY + 8) + 'px';
            popup.style.left = Math.max(16, rect.left) + 'px';

            input.value = currentUrl.replace('mailto:', '');
            popup.classList.add('active');
            input.focus();
        }

        function closeLinkPopup() {
            document.getElementById('link-edit-popup').classList.remove('active');
            currentLinkElement = null;
        }

        function saveLinkEdit() {
            if (!currentLinkElement) return;

            const key = currentLinkElement.getAttribute('data-editable');
            const newValue = document.getElementById('link-edit-input').value;

            unsavedChanges[key] = newValue;

            // Update the display
            const attrName = currentLinkElement.getAttribute('data-editable-attr');
            if (attrName) {
                const attrs = attrName.split(',');
                attrs.forEach(attr => {
                    if (attr === 'text') {
                        currentLinkElement.textContent = newValue;
                    } else if (attr === 'href' && key === 'contactEmail') {
                        currentLinkElement.setAttribute('href', 'mailto:' + newValue);
                    } else {
                        currentLinkElement.setAttribute(attr, newValue);
                    }
                });
            }

            closeLinkPopup();
            updateEditStatus('Link updated - click Save to apply');
        }

        function saveAllChanges() {
            if (Object.keys(unsavedChanges).length === 0) {
                updateEditStatus('No changes to save');
                return;
            }

            // Load existing site data
            const siteData = JSON.parse(localStorage.getItem('siteData') || '{}');

            // Merge changes
            Object.assign(siteData, unsavedChanges);

            // Save to localStorage
            localStorage.setItem('siteData', JSON.stringify(siteData));

            // Clear unsaved changes
            unsavedChanges = {};

            updateEditStatus('All changes saved!');

            // Re-apply to the page
            renderPublicSiteEditMode();

            setTimeout(() => {
                updateEditStatus('Click any text to edit');
            }, 2000);
        }

        function updateEditStatus(message) {
            document.getElementById('edit-status').textContent = message;
        }

        function toggleEditPanel() {
            const panel = document.getElementById('edit-panel');
            const isOpen = panel.classList.contains('active');

            if (isOpen) {
                panel.classList.remove('active');
                document.body.classList.remove('panel-open');
                document.getElementById('panel-toggle-text').textContent = 'Open Panel';
            } else {
                panel.classList.add('active');
                document.body.classList.add('panel-open');
                document.getElementById('panel-toggle-text').textContent = 'Close Panel';
                updatePanelLists();
            }
        }

        function showPanelSection(section) {
            document.querySelectorAll('.edit-panel-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.edit-panel-section').forEach(sec => sec.classList.remove('active'));

            document.querySelector(`[onclick="showPanelSection('${section}')"]`).classList.add('active');
            document.getElementById('panel-' + section).classList.add('active');
        }

        function updatePanelLists() {
            const orgs = DB.getAllCurrentStates('organizations');
            const campaigns = DB.getAllCurrentStates('campaigns');

            // All items list
            document.getElementById('panel-orgs-list').innerHTML = orgs.map(o => `
                <div style="padding: 8px 12px; background: var(--gray-50); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 13px; font-weight: 500;">${escapeHtml(o.name)}</div>
                        <div style="font-size: 11px; color: var(--gray-500);">${o.status}</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="editOrganization('${o.id}')">Edit</button>
                </div>
            `).join('') || '<p style="color: var(--gray-500); font-size: 13px;">No organizations yet</p>';

            document.getElementById('panel-campaigns-list').innerHTML = campaigns.map(c => `
                <div style="padding: 8px 12px; background: var(--gray-50); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 13px; font-weight: 500;">${escapeHtml(c.title)}</div>
                        <div style="font-size: 11px; color: var(--gray-500);">${c.status}</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="editCampaign('${c.id}')">Edit</button>
                </div>
            `).join('') || '<p style="color: var(--gray-500); font-size: 13px;">No campaigns yet</p>';

            // Drafts list
            const draftOrgs = orgs.filter(o => o.status !== 'verified');
            const draftCampaigns = campaigns.filter(c => c.status !== 'active');

            document.getElementById('panel-drafts-list').innerHTML = [
                ...draftOrgs.map(o => `
                    <div style="padding: 8px 12px; background: #fef3c7; border-radius: 6px; margin-bottom: 8px;">
                        <div style="font-size: 13px; font-weight: 500;">${escapeHtml(o.name)}</div>
                        <div style="font-size: 11px; color: var(--gray-600);">Organization - ${o.status}</div>
                    </div>
                `),
                ...draftCampaigns.map(c => `
                    <div style="padding: 8px 12px; background: #fef3c7; border-radius: 6px; margin-bottom: 8px;">
                        <div style="font-size: 13px; font-weight: 500;">${escapeHtml(c.title)}</div>
                        <div style="font-size: 11px; color: var(--gray-600);">Campaign - ${c.status}</div>
                    </div>
                `)
            ].join('') || '<p style="color: var(--gray-500); font-size: 13px;">No draft items</p>';
        }

        function renderPublicSiteEditMode() {
            // In edit mode, show ALL items (including drafts) with edit buttons
            const orgs = DB.getAllCurrentStates('organizations');
            const campaigns = DB.getAllCurrentStates('campaigns');

            // Render organizations to public site
            const orgsByType = {};
            orgs.forEach(o => {
                const type = o.organization_type || 'other';
                if (!orgsByType[type]) orgsByType[type] = [];
                orgsByType[type].push(o);
            });

            const orgsAccordion = document.getElementById('orgs-accordion');
            orgsAccordion.innerHTML = Object.entries(orgsByType).map(([type, orgList]) => `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-content-inner">
                            <ul>
                                ${orgList.map(o => `
                                    <li class="editable-item" style="position: relative; padding-right: 80px;">
                                        <strong>${escapeHtml(o.name)}</strong>${o.status !== 'verified' ? `<span class="edit-badge">${o.status}</span>` : ''}: ${escapeHtml(o.description || '')}
                                        <button class="item-edit-btn" onclick="editOrganization('${o.id}')">Edit</button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('') || '<p>No organizations available yet.</p>';

            // Add "Add Organization" button
            orgsAccordion.innerHTML += '<button class="add-item-btn" onclick="openModal(\'org-modal\')">+ Add Organization</button>';

            // Render campaigns
            const campaignsByType = {};
            campaigns.forEach(c => {
                const type = c.campaign_type || 'other';
                if (!campaignsByType[type]) campaignsByType[type] = [];
                campaignsByType[type].push(c);
            });

            const cfAccordion = document.getElementById('crowdfunding-accordion');
            cfAccordion.innerHTML = Object.entries(campaignsByType).map(([type, campList]) => `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-content-inner">
                            <ul>
                                ${campList.map(c => `
                                    <li class="editable-item" style="position: relative; padding-right: 80px;">
                                        <a href="${escapeHtml(c.external_url || '#')}" target="_blank">${escapeHtml(c.title)}</a>${c.status !== 'active' ? `<span class="edit-badge">${c.status}</span>` : ''}: ${escapeHtml(c.description || '')}
                                        <button class="item-edit-btn" onclick="editCampaign('${c.id}')">Edit</button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('') || '<p>No campaigns yet.</p>';

            // Add "Add Campaign" button
            cfAccordion.innerHTML += '<button class="add-item-btn" onclick="openModal(\'campaign-modal\')">+ Add Campaign</button>';

            // Mutual Aid
            const mutualAidOrgs = orgs.filter(o => o.organization_type === 'mutual_aid' || (o.service_types || []).some(s => s.includes('mutual') || s.includes('food')));
            const maAccordion = document.getElementById('mutualaid-accordion');
            maAccordion.innerHTML = mutualAidOrgs.length > 0 ? `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Mutual Aid Organizations</span>
                        <span class="accordion-icon">+</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-content-inner">
                            <ul>
                                ${mutualAidOrgs.map(o => `
                                    <li class="editable-item" style="position: relative; padding-right: 80px;">
                                        <strong>${escapeHtml(o.name)}</strong>${o.status !== 'verified' ? `<span class="edit-badge">${o.status}</span>` : ''}: ${escapeHtml(o.description || '')}
                                        <button class="item-edit-btn" onclick="editOrganization('${o.id}')">Edit</button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            ` : '<p>Check back soon for mutual aid resources.</p>';

            // Re-attach accordion handlers
            initAccordions();

            // Apply site config
            const siteData = JSON.parse(localStorage.getItem('siteData') || '{}');
            Object.keys(siteData).forEach(key => {
                const el = document.querySelector(`[data-editable="${key}"]`);
                if (el && siteData[key]) {
                    const attrName = el.getAttribute('data-editable-attr');
                    if (attrName) {
                        const attrs = attrName.split(',');
                        attrs.forEach(attr => {
                            if (attr === 'text') {
                                el.textContent = siteData[key];
                            } else if (attr === 'href' && key === 'contactEmail') {
                                el.setAttribute('href', 'mailto:' + siteData[key]);
                            } else {
                                el.setAttribute(attr, siteData[key]);
                            }
                        });
                    } else {
                        el.textContent = siteData[key];
                    }
                }
            });

            // Re-enable editable elements
            enableEditableElements();
        }

        // Edit functions for organizations and campaigns
        function editOrganization(id) {
            const org = DB.getCurrentState(id, 'organizations');
            if (!org) return;

            // Populate the form
            const form = document.getElementById('org-form');
            form.querySelector('[name="name"]').value = org.name || '';
            form.querySelector('[name="organization_type"]').value = org.organization_type || '';
            form.querySelector('[name="description"]').value = org.description || '';
            form.querySelector('[name="website"]').value = org.website || '';
            form.querySelector('[name="phone_primary"]').value = org.phone_primary || '';
            form.querySelector('[name="email"]').value = org.email || '';
            form.querySelector('[name="address_city"]').value = org.address_city || '';
            form.querySelector('[name="status"]').value = org.status || 'draft';

            // Store the ID for updating
            form.dataset.editId = id;

            // Update modal title
            document.querySelector('#org-modal .modal-header h3').textContent = 'Edit Organization';
            document.querySelector('#org-modal .modal-footer .btn-primary').textContent = 'Save Changes';

            openModal('org-modal');
        }

        function editCampaign(id) {
            const campaign = DB.getCurrentState(id, 'campaigns');
            if (!campaign) return;

            // Populate the form
            const form = document.getElementById('campaign-form');
            form.querySelector('[name="title"]').value = campaign.title || '';
            form.querySelector('[name="platform"]').value = campaign.platform || '';
            form.querySelector('[name="external_url"]').value = campaign.external_url || '';
            form.querySelector('[name="campaign_type"]').value = campaign.campaign_type || 'individual_family';
            form.querySelector('[name="goal_amount"]').value = campaign.goal_amount || '';
            form.querySelector('[name="description"]').value = campaign.description || '';
            form.querySelector('[name="status"]').value = campaign.status || 'active';

            // Store the ID for updating
            form.dataset.editId = id;

            // Update modal title
            document.querySelector('#campaign-modal .modal-header h3').textContent = 'Edit Campaign';
            document.querySelector('#campaign-modal .modal-footer .btn-primary').textContent = 'Save Changes';

            openModal('campaign-modal');
        }

        // Open data manager (old admin dashboard)
        function openDataManager() {
            // Just enter the old admin dashboard mode
            document.getElementById('admin-dashboard').classList.add('active');
            document.getElementById('public-site').classList.add('hidden');
            document.getElementById('edit-toolbar').classList.remove('active');
            document.body.classList.remove('edit-mode');

            loadDashboard();
            loadAllSections();
        }

        // Update the triple-Escape to enter edit mode instead of login
        let escapeCount = 0;
        let escapeTimer = null;

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Handle link popup close
                if (document.getElementById('link-edit-popup').classList.contains('active')) {
                    closeLinkPopup();
                    return;
                }

                // Triple-escape for edit mode
                escapeCount++;
                clearTimeout(escapeTimer);
                escapeTimer = setTimeout(() => { escapeCount = 0; }, 500);

                if (escapeCount >= 3) {
                    escapeCount = 0;
                    if (!isEditMode) {
                        // Show login first
                        document.getElementById('loginBackdrop').classList.add('active');
                        document.getElementById('loginModal').classList.add('active');
                        document.getElementById('passwordInput').focus();
                    } else {
                        exitEditMode();
                    }
                }
            }
        });

        // Update login handler to enter edit mode instead of admin dashboard
        const originalLoginHandler = document.getElementById('loginBtn').onclick;
        document.getElementById('loginBtn').onclick = async function() {
            const password = document.getElementById('passwordInput').value;
            const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(password));
            const hashHex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');

            if (hashHex === '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918') {
                document.getElementById('loginBackdrop').classList.remove('active');
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('passwordInput').value = '';
                document.getElementById('loginError').style.display = 'none';

                Webhooks.log('edit_mode_enter', { access_type: 'logging' });

                // Enter WYSIWYG edit mode instead of admin dashboard
                enterEditMode();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        };

        // ============================================
        // INIT
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // INSTANT RENDER: Use cached localStorage data immediately
            // DB is already pre-loaded with localStorage data (events, siteData, siteTheme)

            // Apply cached theme immediately if available
            const cachedTheme = DB.getSiteTheme();
            if (cachedTheme && Object.keys(cachedTheme).length > 0) {
                if (typeof smCurrentTheme !== 'undefined' && typeof smApplyThemeToDOM === 'function') {
                    Object.assign(smCurrentTheme, cachedTheme);
                    smApplyThemeToDOM();
                }
            }

            // Render immediately with cached data (no blocking)
            renderPublicSite();
            console.log('Site rendered instantly from cache');

            // BACKGROUND UPDATE: Fetch fresh data from API without blocking
            DB.initialize().then(() => {
                // Re-apply theme if API returned updated data
                const loadedTheme = DB.getSiteTheme();
                if (loadedTheme && Object.keys(loadedTheme).length > 0) {
                    if (typeof smCurrentTheme !== 'undefined' && typeof smApplyThemeToDOM === 'function') {
                        Object.assign(smCurrentTheme, loadedTheme);
                        smApplyThemeToDOM();
                    }
                }

                // Re-render with fresh API data
                renderPublicSite();
                console.log('Site updated with fresh API data');
            }).catch(err => {
                console.warn('Background API update failed, using cached data:', err);
            });
        });

        // ============================================
        // CONTENT EDITOR (integrated from content-editor.html)
        // ============================================

        // Content Editor Types Configuration
        const ceContentTypes = {
            organizations: {
                name: 'Organizations',
                description: 'Nonprofits, mutual aid groups, legal services',
                icon: '',
                fields: [
                    { name: 'name', label: 'Name', type: 'text', required: true },
                    { name: 'organization_type', label: 'Type', type: 'select', options: ['nonprofit', 'mutual_aid', 'legal', 'community_group', 'other'] },
                    { name: 'description', label: 'Description', type: 'textarea' },
                    { name: 'website', label: 'Website', type: 'url' },
                    { name: 'phone_primary', label: 'Phone', type: 'text' },
                    { name: 'email', label: 'Email', type: 'email' },
                    { name: 'address_city', label: 'City', type: 'text' },
                    { name: 'status', label: 'Status', type: 'select', options: ['draft', 'pending', 'verified'] }
                ],
                tableColumns: ['name', 'organization_type', 'status']
            },
            campaigns: {
                name: 'Campaigns',
                description: 'Crowdfunding campaigns',
                icon: '',
                fields: [
                    { name: 'title', label: 'Title', type: 'text', required: true },
                    { name: 'platform', label: 'Platform', type: 'select', options: ['gofundme', 'givebutter', 'venmo', 'cashapp', 'other'] },
                    { name: 'external_url', label: 'Campaign URL', type: 'url' },
                    { name: 'campaign_type', label: 'Type', type: 'select', options: ['individual_family', 'community', 'legal_fund', 'mutual_aid'] },
                    { name: 'goal_amount', label: 'Goal Amount', type: 'number' },
                    { name: 'description', label: 'Description', type: 'textarea' },
                    { name: 'status', label: 'Status', type: 'select', options: ['draft', 'active', 'completed', 'archived'] }
                ],
                tableColumns: ['title', 'platform', 'status']
            },
            sections: {
                name: 'Page Sections',
                description: 'Main page sections',
                icon: '',
                fields: [
                    { name: 'name', label: 'Section Name', type: 'text', required: true },
                    { name: 'section_type', label: 'Type', type: 'select', options: ['hero', 'accordion', 'content', 'cta'] },
                    { name: 'order', label: 'Order', type: 'number' },
                    { name: 'background', label: 'Background', type: 'select', options: ['light', 'dark', 'white'] },
                    { name: 'is_published', label: 'Published', type: 'checkbox' }
                ],
                tableColumns: ['name', 'section_type', 'order']
            },
            blocks: {
                name: 'Content Blocks',
                description: 'Individual content blocks within sections',
                icon: '',
                fields: [
                    { name: 'title', label: 'Title', type: 'text' },
                    { name: 'block_type', label: 'Block Type', type: 'select', options: ['text', 'heading', 'accordion_item', 'link_list', 'button', 'divider'] },
                    { name: 'content', label: 'Content', type: 'richtext' },
                    { name: 'section_id', label: 'Section', type: 'relation', relation: 'sections' },
                    { name: 'order', label: 'Order', type: 'number' },
                    { name: 'url', label: 'URL (for buttons/links)', type: 'url' }
                ],
                tableColumns: ['title', 'block_type', 'order']
            }
        };

        // Content Editor State
        let ceSelectedContentType = null;
        let ceSelectedItem = null;
        let ceSelectedSection = null;
        let cePreviewScale = 1;

        // Open Content Editor
        function openContentEditor() {
            document.getElementById('content-editor-view').classList.add('active');
            document.getElementById('admin-dashboard').classList.remove('active');
            document.getElementById('public-site').classList.add('hidden');
            document.body.classList.remove('edit-mode');
            document.getElementById('edit-toolbar').classList.remove('active');

            ceRenderContentTypes();
            ceLoadSettings();
            ceRenderPreview();
            ceInitSectionSelect();
        }

        // Close Content Editor
        function closeContentEditor() {
            document.getElementById('content-editor-view').classList.remove('active');
            document.getElementById('public-site').classList.remove('hidden');
            renderPublicSite();
        }

        // CMS Tab Navigation
        function showCeCmsTab(tabId) {
            document.querySelectorAll('.ce-cms-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.ce-cms-section').forEach(s => s.classList.remove('active'));

            document.querySelector(`[onclick="showCeCmsTab('${tabId}')"]`).classList.add('active');
            document.getElementById('ce-tab-' + tabId).classList.add('active');
        }

        // Content Types Rendering
        function ceRenderContentTypes() {
            const container = document.getElementById('ce-content-types');
            container.innerHTML = Object.entries(ceContentTypes).map(([key, type]) => {
                const count = DB.getAllCurrentStates(key).length;
                return `
                    <div class="ce-content-type-card ${ceSelectedContentType === key ? 'active' : ''}"
                         onclick="ceSelectContentType('${key}')">
                        <div class="ce-content-type-header">
                            <span class="ce-content-type-name">${type.icon} ${type.name}</span>
                            <span class="ce-content-type-count">${count}</span>
                        </div>
                        <div class="ce-content-type-desc">${type.description}</div>
                    </div>
                `;
            }).join('');
        }

        function ceSelectContentType(typeKey) {
            ceSelectedContentType = typeKey;
            ceRenderContentTypes();
            ceRenderContentTable(typeKey);
        }

        function ceRenderContentTable(typeKey) {
            const type = ceContentTypes[typeKey];
            const items = DB.getAllCurrentStates(typeKey);
            const container = document.getElementById('ce-content-table-area');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="ce-empty-state">
                        <div class="ce-empty-state-icon">${type.icon}</div>
                        <h3>No ${type.name} yet</h3>
                        <p>Create your first ${type.name.toLowerCase().slice(0, -1)}</p>
                        <button class="btn btn-primary" onclick="ceOpenAddModal('${typeKey}')">
                            + Add ${type.name.slice(0, -1)}
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="ce-data-table-container">
                    <div class="ce-data-table-header">
                        <span class="ce-data-table-title">${type.name}</span>
                        <button class="btn btn-primary btn-sm" onclick="ceOpenAddModal('${typeKey}')">
                            + Add
                        </button>
                    </div>
                    <table class="ce-data-table">
                        <thead>
                            <tr>
                                ${type.tableColumns.map(col => `<th>${col.replace(/_/g, ' ')}</th>`).join('')}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    ${type.tableColumns.map(col => {
                                        const value = item[col] || '';
                                        if (col === 'status') {
                                            return `<td><span class="ce-status-badge ${value}">${value}</span></td>`;
                                        }
                                        return `<td>${escapeHtml(String(value).substring(0, 50))}</td>`;
                                    }).join('')}
                                    <td>
                                        <div class="ce-table-actions">
                                            <button class="ce-table-btn edit" onclick="ceOpenEditModal('${typeKey}', '${item.id}')">Edit</button>
                                            <button class="ce-table-btn delete" onclick="ceConfirmDelete('${typeKey}', '${item.id}')">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Modal Handling
        function ceOpenAddModal(typeKey) {
            ceSelectedContentType = typeKey;
            ceSelectedItem = null;
            const type = ceContentTypes[typeKey];

            document.getElementById('ce-edit-modal-title').textContent = `Add ${type.name.slice(0, -1)}`;
            document.getElementById('ce-delete-btn').style.display = 'none';
            ceRenderModalForm(typeKey, {});
            document.getElementById('ce-edit-modal').classList.add('active');
        }

        function ceOpenEditModal(typeKey, itemId) {
            ceSelectedContentType = typeKey;
            ceSelectedItem = DB.getCurrentState(itemId, typeKey);
            const type = ceContentTypes[typeKey];

            document.getElementById('ce-edit-modal-title').textContent = `Edit ${type.name.slice(0, -1)}`;
            document.getElementById('ce-delete-btn').style.display = 'block';
            ceRenderModalForm(typeKey, ceSelectedItem);
            document.getElementById('ce-edit-modal').classList.add('active');
        }

        function ceCloseEditModal() {
            document.getElementById('ce-edit-modal').classList.remove('active');
            ceSelectedItem = null;
        }

        function ceRenderModalForm(typeKey, item) {
            const type = ceContentTypes[typeKey];
            const container = document.getElementById('ce-edit-modal-body');

            container.innerHTML = type.fields.map(field => {
                const value = item[field.name] || '';

                if (field.type === 'textarea') {
                    return `
                        <div class="ce-form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <textarea name="${field.name}">${escapeHtml(value)}</textarea>
                        </div>
                    `;
                } else if (field.type === 'select') {
                    return `
                        <div class="ce-form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <select name="${field.name}">
                                <option value="">Select...</option>
                                ${field.options.map(opt =>
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt.replace(/_/g, ' ')}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else if (field.type === 'richtext') {
                    return `
                        <div class="ce-form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <div class="ce-rich-text-editor">
                                <div class="ce-rich-text-toolbar">
                                    <button type="button" class="ce-rich-text-btn" onclick="ceExecRichCmd('bold')"><b>B</b></button>
                                    <button type="button" class="ce-rich-text-btn" onclick="ceExecRichCmd('italic')"><i>I</i></button>
                                    <button type="button" class="ce-rich-text-btn" onclick="ceExecRichCmd('underline')"><u>U</u></button>
                                    <button type="button" class="ce-rich-text-btn" onclick="ceExecRichCmd('insertUnorderedList')"> List</button>
                                    <button type="button" class="ce-rich-text-btn" onclick="ceExecRichCmd('insertOrderedList')">1. List</button>
                                    <button type="button" class="ce-rich-text-btn" onclick="ceInsertLink()">Link</button>
                                </div>
                                <div class="ce-rich-text-content" contenteditable="true" data-field="${field.name}">${value}</div>
                            </div>
                        </div>
                    `;
                } else if (field.type === 'checkbox') {
                    return `
                        <div class="ce-form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="${field.name}" ${value ? 'checked' : ''}>
                                ${field.label}
                            </label>
                        </div>
                    `;
                } else if (field.type === 'relation') {
                    const relatedItems = DB.getAllCurrentStates(field.relation);
                    return `
                        <div class="ce-form-group">
                            <label>${field.label}</label>
                            <select name="${field.name}">
                                <option value="">Select...</option>
                                ${relatedItems.map(ri =>
                                    `<option value="${ri.id}" ${value === ri.id ? 'selected' : ''}>${ri.name || ri.title || ri.id}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    return `
                        <div class="ce-form-group">
                            <label>${field.label}${field.required ? ' *' : ''}</label>
                            <input type="${field.type || 'text'}" name="${field.name}" value="${escapeHtml(String(value))}">
                        </div>
                    `;
                }
            }).join('');
        }

        function ceSaveEditModal() {
            const type = ceContentTypes[ceSelectedContentType];
            const formData = {};

            type.fields.forEach(field => {
                if (field.type === 'richtext') {
                    const el = document.querySelector(`#ce-edit-modal-body [data-field="${field.name}"]`);
                    formData[field.name] = el ? el.innerHTML : '';
                } else if (field.type === 'checkbox') {
                    formData[field.name] = document.querySelector(`#ce-edit-modal-body [name="${field.name}"]`).checked;
                } else {
                    formData[field.name] = document.querySelector(`#ce-edit-modal-body [name="${field.name}"]`).value;
                }
            });

            // Validate required fields
            for (const field of type.fields) {
                if (field.required && !formData[field.name]) {
                    ceShowToast(`${field.label} is required`, 'error');
                    return;
                }
            }

            if (ceSelectedItem) {
                // Update existing - only send ALT events for changed values
                const existing = DB.getCurrentState(ceSelectedItem.id, ceSelectedContentType);
                const changedFields = [];
                Object.entries(formData).forEach(([key, value]) => {
                    if (!valuesEqual(existing[key], value)) {
                        DB.altRecord(ceSelectedContentType, ceSelectedItem.id, key, existing[key], value);
                        changedFields.push(key);
                    }
                });
                // Log to webhook
                Webhooks.log('content_update', {
                    access_type: 'content',
                    frame: ceSelectedContentType,
                    record_id: ceSelectedItem.id,
                    fields: changedFields
                });
                ceShowToast('Updated successfully', 'success');
            } else {
                // Create new
                const event = DB.insRecord(ceSelectedContentType, formData);
                // Log to webhook
                Webhooks.log('content_create', {
                    access_type: 'content',
                    frame: ceSelectedContentType,
                    record_id: event.record_id,
                    data: formData
                });
                ceShowToast('Created successfully', 'success');
            }

            ceCloseEditModal();
            ceRenderContentTypes();
            ceRenderContentTable(ceSelectedContentType);
            ceRenderPreview();
        }

        function ceDeleteCurrentItem() {
            if (!ceSelectedItem) return;

            if (confirm('Are you sure you want to delete this item?')) {
                DB.nulRecord(ceSelectedContentType, ceSelectedItem.id, 'deleted by user');
                // Log to webhook
                Webhooks.log('content_delete', {
                    access_type: 'content',
                    frame: ceSelectedContentType,
                    record_id: ceSelectedItem.id
                });
                ceShowToast('Deleted successfully', 'success');
                ceCloseEditModal();
                ceRenderContentTypes();
                ceRenderContentTable(ceSelectedContentType);
                ceRenderPreview();
            }
        }

        function ceConfirmDelete(typeKey, itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                DB.nulRecord(typeKey, itemId, 'deleted by user');
                // Log to webhook
                Webhooks.log('content_delete', {
                    access_type: 'content',
                    frame: typeKey,
                    record_id: itemId
                });
                ceShowToast('Deleted successfully', 'success');
                ceRenderContentTypes();
                ceRenderContentTable(typeKey);
                ceRenderPreview();
            }
        }

        // Rich Text Editor
        function ceExecRichCmd(command) {
            document.execCommand(command, false, null);
        }

        function ceInsertLink() {
            const url = prompt('Enter URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
        }

        // Blocks Management
        function ceInitSectionSelect() {
            const select = document.getElementById('ce-block-section-select');
            const sections = DB.getAllCurrentStates('sections');

            // Add default sections if none exist
            if (sections.length === 0) {
                const defaultSections = [
                    { name: 'Hero', section_type: 'hero', order: 1, background: 'white' },
                    { name: 'Mutual Aid', section_type: 'accordion', order: 2, background: 'dark' },
                    { name: 'Crowdfunding', section_type: 'accordion', order: 3, background: 'light' },
                    { name: 'Organizations', section_type: 'accordion', order: 4, background: 'white' },
                    { name: 'Secure Messaging', section_type: 'content', order: 5, background: 'dark' }
                ];

                defaultSections.forEach(s => DB.insRecord('sections', s));
            }

            const allSections = DB.getAllCurrentStates('sections').sort((a, b) => (a.order || 0) - (b.order || 0));

            select.innerHTML = '<option value="">Choose a section...</option>' +
                allSections.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        function ceLoadSectionBlocks(sectionId) {
            ceSelectedSection = sectionId;
            const container = document.getElementById('ce-blocks-area');

            if (!sectionId) {
                container.innerHTML = '<div class="ce-empty-state"><p>Select a section to manage its blocks</p></div>';
                return;
            }

            const blocks = DB.getAllCurrentStates('blocks').filter(b => b.section_id === sectionId)
                .sort((a, b) => (a.order || 0) - (b.order || 0));

            if (blocks.length === 0) {
                container.innerHTML = `
                    <div class="ce-empty-state">
                        <h3>No blocks in this section</h3>
                        <p>Add blocks to build this section</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="ce-block-list" id="ce-block-list">
                    ${blocks.map((block, index) => `
                        <div class="ce-block-item" draggable="true" data-block-id="${block.id}" data-order="${block.order || index}">
                            <div class="ce-block-header">
                                <span class="ce-block-drag-handle"></span>
                                <span class="ce-block-type-icon">${ceGetBlockIcon(block.block_type)}</span>
                                <span class="ce-block-type-name">${block.title || block.block_type}</span>
                                <div class="ce-block-actions">
                                    <button class="ce-table-btn edit" onclick="ceOpenEditModal('blocks', '${block.id}')">Edit</button>
                                    <button class="ce-table-btn delete" onclick="ceConfirmDelete('blocks', '${block.id}')"></button>
                                </div>
                            </div>
                            <div class="ce-block-content">
                                ${ceRenderBlockPreview(block)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            ceInitBlockDragDrop();
        }

        function ceGetBlockIcon(type) {
            const icons = {
                text: '',
                heading: 'H',
                accordion_item: '',
                link_list: '',
                button: '',
                divider: ''
            };
            return icons[type] || '';
        }

        function ceRenderBlockPreview(block) {
            switch (block.block_type) {
                case 'text':
                    return `<div style="font-size: 12px; color: var(--gray-600); max-height: 60px; overflow: hidden;">${block.content || '<em>No content</em>'}</div>`;
                case 'heading':
                    return `<div style="font-weight: 600;">${block.title || 'Heading'}</div>`;
                case 'button':
                    return `<div style="font-size: 12px;"><span style="background: var(--gray-200); padding: 4px 8px; border-radius: 4px;">${block.title || 'Button'}</span>  ${block.url || '#'}</div>`;
                case 'accordion_item':
                    return `<div style="font-size: 12px; color: var(--gray-600);">${block.title || 'Accordion Item'}</div>`;
                case 'divider':
                    return '<hr style="border: none; border-top: 1px solid var(--gray-200);">';
                default:
                    return `<div style="font-size: 12px; color: var(--gray-500);">${block.block_type}</div>`;
            }
        }

        function ceToggleAddBlockMenu() {
            if (!ceSelectedSection) {
                ceShowToast('Please select a section first', 'error');
                return;
            }
            document.getElementById('ce-add-block-modal').classList.add('active');
        }

        function ceCloseAddBlockModal() {
            document.getElementById('ce-add-block-modal').classList.remove('active');
        }

        function ceAddBlock(blockType) {
            if (!ceSelectedSection) {
                ceShowToast('Please select a section first', 'error');
                return;
            }

            const existingBlocks = DB.getAllCurrentStates('blocks').filter(b => b.section_id === ceSelectedSection);
            const maxOrder = Math.max(0, ...existingBlocks.map(b => b.order || 0));

            const newBlock = {
                block_type: blockType,
                section_id: ceSelectedSection,
                order: maxOrder + 1,
                title: '',
                content: ''
            };

            DB.insRecord('blocks', newBlock);
            ceCloseAddBlockModal();
            ceLoadSectionBlocks(ceSelectedSection);
            ceRenderPreview();
            ceShowToast('Block added', 'success');
        }

        // Drag and Drop for Blocks
        function ceInitBlockDragDrop() {
            const blockList = document.getElementById('ce-block-list');
            if (!blockList) return;

            const blocks = blockList.querySelectorAll('.ce-block-item');
            let draggedEl = null;

            blocks.forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    draggedEl = block;
                    block.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                block.addEventListener('dragend', () => {
                    block.classList.remove('dragging');
                    blocks.forEach(b => b.classList.remove('drag-over'));

                    // Update order in DB
                    const newOrder = Array.from(blockList.children).map((el, i) => ({
                        id: el.dataset.blockId,
                        order: i + 1
                    }));

                    newOrder.forEach(({ id, order }) => {
                        const current = DB.getCurrentState(id, 'blocks');
                        if (current && current.order !== order) {
                            DB.altRecord('blocks', id, 'order', current.order, order);
                        }
                    });

                    ceRenderPreview();
                });

                block.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    if (block !== draggedEl) {
                        block.classList.add('drag-over');
                        const rect = block.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;

                        if (e.clientY < midY) {
                            blockList.insertBefore(draggedEl, block);
                        } else {
                            blockList.insertBefore(draggedEl, block.nextSibling);
                        }
                    }
                });

                block.addEventListener('dragleave', () => {
                    block.classList.remove('drag-over');
                });
            });
        }

        // Settings
        const ceSettingsDefaults = {
            siteName: 'Stand With Tennessee',
            heroTitle: 'Tennessee is under occupation by federal agents from ICE and CBP, and we need your support.',
            heroDescription: 'Across Tennessee, ICE continues to stop, harass, and detain people regardless of their citizenship status.',
            donateUrl: '#',
            featuredButton1Text: 'Featured GoFundMe',
            featuredButton1Url: '#',
            mutualAidTitle: 'Mutual Aid & Materials',
            mutualAidDescription: 'These funds are administered by neighbors helping their neighbors.',
            crowdfundingTitle: 'Crowdfunding Campaigns',
            crowdfundingDescription: 'Active campaigns that need support. Updated regularly.',
            orgsTitle: 'Organizations On The Ground',
            orgsDescription: 'Organizations doing direct service, jail support, and legal defense work.',
            secureMessagingTitle: 'Stay Connected Securely',
            secureMessagingDescription: 'In times of uncertainty, secure communication is essential.',
            contactEmail: 'contact@standwithtennessee.org'
        };

        // Get current settings from form inputs (for live preview)
        function ceGetCurrentSettingsFromForm() {
            const settings = { ...ceSettingsDefaults };
            const settingInputs = document.querySelectorAll('[id^="ce-setting-"]');
            settingInputs.forEach(input => {
                const key = input.id.replace('ce-setting-', '');
                settings[key] = input.value;
            });
            return settings;
        }

        function ceLoadSettings() {
            // Load from API via DB.getSiteData()
            const siteData = DB.getSiteData() || {};
            const merged = { ...ceSettingsDefaults, ...siteData };

            Object.keys(merged).forEach(key => {
                const el = document.getElementById('ce-setting-' + key);
                if (el) {
                    el.value = merged[key];
                    // Add live preview on input change
                    el.addEventListener('input', () => {
                        ceRenderPreview(true);
                    });
                }
            });
        }

        async function ceSaveSettings() {
            const oldSiteData = DB.getSiteData() || {};
            const newSiteData = {};
            const settingInputs = document.querySelectorAll('[id^="ce-setting-"]');
            const changedFields = [];

            settingInputs.forEach(input => {
                const key = input.id.replace('ce-setting-', '');
                newSiteData[key] = input.value;

                // Track changes for activity stream
                if (oldSiteData[key] !== newSiteData[key]) {
                    changedFields.push({
                        field: key,
                        oldValue: oldSiteData[key] || '',
                        newValue: newSiteData[key]
                    });
                }
            });

            // Log each change to activity stream
            if (changedFields.length > 0) {
                changedFields.forEach(change => {
                    DB.altRecord('site_settings', 'site_config', change.field, change.oldValue, change.newValue, 'admin');
                });
                Webhooks.log('site_settings_update', {
                    access_type: 'content',
                    changes: changedFields.length,
                    fields: changedFields.map(c => c.field)
                });
            }

            // Save to API via DB.setSiteData()
            await DB.setSiteData(newSiteData);
            ceShowToast(`Settings saved to API (${changedFields.length} changes)`, 'success');
            ceRenderPreview();
        }

        function ceSaveAllContent() {
            // Log save action to activity stream
            DB.createEvent('given', 'ALT', 'site_settings', 'bulk_save', {
                ALT: { field: 'all_content', old_value: '', new_value: 'saved' }
            }, 'admin');
            Webhooks.log('content_bulk_save', { access_type: 'content' });
            ceShowToast('All content saved to activity stream', 'success');
        }

        // Preview Rendering
        function setCePreviewScale(scale) {
            cePreviewScale = scale;
            const content = document.getElementById('ce-preview-content');
            content.style.transform = `scale(${scale})`;
            content.style.width = `${100 / scale}%`;

            document.querySelectorAll('.ce-preview-controls button[data-scale]').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.dataset.scale) === scale);
            });
        }

        // Device preview mode
        let cePreviewDevice = 'desktop';

        function setPreviewDevice(device) {
            cePreviewDevice = device;
            const frame = document.getElementById('ce-preview-frame');
            const content = document.getElementById('ce-preview-content');

            // Update button states
            document.querySelectorAll('.sm-device-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Set preview width based on device
            let maxWidth, padding;
            switch (device) {
                case 'mobile':
                    maxWidth = '375px';
                    padding = '20px';
                    break;
                case 'tablet':
                    maxWidth = '768px';
                    padding = '20px';
                    break;
                case 'desktop':
                default:
                    maxWidth = '100%';
                    padding = '0';
                    break;
            }

            // Apply device simulation
            frame.style.display = 'flex';
            frame.style.justifyContent = 'center';
            frame.style.padding = padding;
            frame.style.background = device === 'desktop' ? 'white' : 'var(--gray-200)';

            content.style.maxWidth = maxWidth;
            content.style.width = '100%';
            content.style.background = 'white';
            content.style.boxShadow = device === 'desktop' ? 'none' : '0 0 20px rgba(0,0,0,0.1)';
            content.style.borderRadius = device === 'desktop' ? '0' : '8px';
            content.style.overflow = 'hidden';

            // Reset scale for device preview
            if (device !== 'desktop') {
                setCePreviewScale(1);
            }
        }

        function ceRenderPreview(useLiveFormValues = false) {
            const container = document.getElementById('ce-preview-content');
            // Use form values for live preview, DB.getSiteData() for saved state from API
            const siteData = useLiveFormValues ? ceGetCurrentSettingsFromForm() : (DB.getSiteData() || {});
            const orgs = DB.getAllCurrentStates('organizations').filter(o => o.status === 'verified');
            const campaigns = DB.getAllCurrentStates('campaigns').filter(c => c.status === 'active');

            // Group by type
            const orgsByType = {};
            orgs.forEach(o => {
                const type = o.organization_type || 'other';
                if (!orgsByType[type]) orgsByType[type] = [];
                orgsByType[type].push(o);
            });

            const campaignsByType = {};
            campaigns.forEach(c => {
                const type = c.campaign_type || 'other';
                if (!campaignsByType[type]) campaignsByType[type] = [];
                campaignsByType[type].push(c);
            });

            const mutualAidOrgs = orgs.filter(o => o.organization_type === 'mutual_aid');

            container.innerHTML = `
                <!-- Header/Navigation -->
                <header class="preview-header" data-block-id="header">
                    <a href="#" class="logo">${escapeHtml(siteData.siteName || 'Stand With Tennessee')}</a>
                    <nav class="nav">
                        <a href="#mutualaid">Mutual Aid</a>
                        <a href="#crowdfunding">Crowdfunding</a>
                        <a href="#orgs">Organizations</a>
                        <a href="#secure-messaging">Connect</a>
                        <a href="${escapeHtml(siteData.donateUrl || '#')}" class="public-btn">Donate</a>
                    </nav>
                </header>

                <!-- Hero Section -->
                <section class="section section-hero" data-block-id="hero" style="padding-top: 80px;">
                    <div class="content-wrapper">
                        <h1>${escapeHtml(siteData.heroTitle || 'Tennessee is under occupation...')}</h1>
                        <p>${escapeHtml(siteData.heroDescription || 'Site description...')}</p>
                        <div class="button-group">
                            <a href="${escapeHtml(siteData.featuredButton1Url || '#')}" class="public-btn">${escapeHtml(siteData.featuredButton1Text || 'Featured GoFundMe')}</a>
                            <a href="#mutualaid" class="public-btn">Mutual Aid</a>
                            <a href="#orgs" class="public-btn">Organizations</a>
                        </div>
                    </div>
                </section>

                <!-- Mutual Aid Section -->
                <section class="section section-dark" data-block-id="mutualaid">
                    <div class="content-wrapper">
                        <h2>${escapeHtml(siteData.mutualAidTitle || 'Mutual Aid & Materials')}</h2>
                        <p>${escapeHtml(siteData.mutualAidDescription || '')}</p>
                        <div class="accordion">
                            ${mutualAidOrgs.length > 0 ? `
                                <div class="accordion-item">
                                    <div class="accordion-header">
                                        <span>Mutual Aid Organizations</span>
                                        <span>+</span>
                                    </div>
                                    <div class="accordion-content">
                                        <ul>
                                            ${mutualAidOrgs.map(o => `
                                                <li><strong>${escapeHtml(o.name)}</strong>: ${escapeHtml(o.description || '')}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            ` : '<p style="opacity: 0.7;">No mutual aid organizations yet.</p>'}
                        </div>
                    </div>
                </section>

                <!-- Crowdfunding Section -->
                <section class="section section-light" data-block-id="crowdfunding">
                    <div class="content-wrapper">
                        <h2>${escapeHtml(siteData.crowdfundingTitle || 'Crowdfunding Campaigns')}</h2>
                        <p>${escapeHtml(siteData.crowdfundingDescription || '')}</p>
                        <div class="accordion">
                            ${Object.entries(campaignsByType).map(([type, camps]) => `
                                <div class="accordion-item">
                                    <div class="accordion-header">
                                        <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                        <span>+</span>
                                    </div>
                                    <div class="accordion-content">
                                        <ul>
                                            ${camps.map(c => `
                                                <li><a href="${escapeHtml(c.external_url || '#')}" target="_blank">${escapeHtml(c.title)}</a>: ${escapeHtml(c.description || '')}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `).join('') || '<p>No campaigns yet.</p>'}
                        </div>
                    </div>
                </section>

                <!-- Organizations Section -->
                <section class="section" data-block-id="orgs">
                    <div class="content-wrapper">
                        <h2>${escapeHtml(siteData.orgsTitle || 'Organizations On The Ground')}</h2>
                        <p>${escapeHtml(siteData.orgsDescription || '')}</p>
                        <div class="accordion">
                            ${Object.entries(orgsByType).map(([type, orgList]) => `
                                <div class="accordion-item">
                                    <div class="accordion-header">
                                        <span>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                        <span>+</span>
                                    </div>
                                    <div class="accordion-content">
                                        <ul>
                                            ${orgList.map(o => `
                                                <li><strong>${escapeHtml(o.name)}</strong>: ${escapeHtml(o.description || '')}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `).join('') || '<p>No organizations yet.</p>'}
                        </div>
                    </div>
                </section>

                <!-- Secure Messaging Section -->
                <section class="section section-dark" data-block-id="secure-messaging" style="text-align: center;">
                    <div class="content-wrapper">
                        <h2>${escapeHtml(siteData.secureMessagingTitle || 'Stay Connected Securely')}</h2>
                        <p style="margin: 0 auto;">${escapeHtml(siteData.secureMessagingDescription || '')}</p>
                    </div>
                </section>

                <!-- Footer -->
                <footer style="background: var(--footer-bg); color: var(--footer-text); padding: var(--footer-padding); text-align: center;">
                    <p>Contact: <a href="mailto:${escapeHtml(siteData.contactEmail || '')}" style="color: inherit;">${escapeHtml(siteData.contactEmail || 'contact@example.org')}</a></p>
                </footer>
            `;

            // Add click handlers for preview blocks
            container.querySelectorAll('[data-block-id]').forEach(block => {
                block.addEventListener('click', () => {
                    container.querySelectorAll('[data-block-id]').forEach(b => b.classList.remove('selected'));
                    block.classList.add('selected');
                });
            });
        }

        // Toast Notification
        function ceShowToast(message, type = 'info') {
            const toast = document.getElementById('ce-toast');
            toast.textContent = message;
            toast.className = 'ce-toast active ' + type;

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // Activity Stream for Content Editor
        function ceLoadActivityStream() {
            const filter = document.getElementById('ce-activity-filter')?.value || '';
            const events = DB.getEvents(filter || null, null, 50);
            const container = document.getElementById('ce-activity-stream');
            const countEl = document.getElementById('ce-activity-count');

            if (countEl) {
                countEl.textContent = `${events.length} events`;
            }

            if (!container) return;

            if (events.length === 0) {
                container.innerHTML = `
                    <div style="padding: 24px; text-align: center; color: var(--gray-500);">
                        <p>No activity yet</p>
                        <p style="font-size: 12px;">Changes made in the editor will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.map(event => {
                const opColors = {
                    'INS': '#10b981',
                    'ALT': '#3b82f6',
                    'NUL': '#ef4444',
                    'CON': '#8b5cf6'
                };
                const opLabels = {
                    'INS': 'Created',
                    'ALT': 'Updated',
                    'NUL': 'Archived',
                    'CON': 'Linked'
                };
                const frameLabels = {
                    'organizations': 'Organization',
                    'campaigns': 'Campaign',
                    'sections': 'Section',
                    'blocks': 'Block',
                    'site_settings': 'Settings',
                    'services': 'Service',
                    'regions': 'Region',
                    'languages': 'Language',
                    'submissions': 'Submission'
                };

                const timeAgo = getTimeAgo(event.created_at);
                const opColor = opColors[event.operator] || '#6b7280';
                const opLabel = opLabels[event.operator] || event.operator;
                const frameLabel = frameLabels[event.frame] || event.frame;

                let detail = '';
                if (event.payload?.ALT) {
                    detail = `<span style="color: var(--gray-500);">${event.payload.ALT.field}</span>`;
                } else if (event.payload?.INS?.fields?.name) {
                    detail = `<span style="color: var(--gray-600);">${escapeHtml(event.payload.INS.fields.name)}</span>`;
                } else if (event.payload?.INS?.fields?.title) {
                    detail = `<span style="color: var(--gray-600);">${escapeHtml(event.payload.INS.fields.title)}</span>`;
                }

                return `
                    <div style="padding: 12px 16px; border-bottom: 1px solid var(--gray-100); display: flex; gap: 12px; align-items: flex-start;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${opColor}; margin-top: 6px; flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 500; color: var(--gray-800);">
                                ${opLabel} ${frameLabel}
                            </div>
                            ${detail ? `<div style="font-size: 12px; margin-top: 2px;">${detail}</div>` : ''}
                            <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">
                                ${timeAgo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper function for time ago
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        // Update showCeCmsTab to load activity when tab is shown
        const originalShowCeCmsTab = showCeCmsTab;
        showCeCmsTab = function(tabId) {
            document.querySelectorAll('.ce-cms-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.ce-cms-section').forEach(s => s.classList.remove('active'));

            document.querySelector(`[onclick="showCeCmsTab('${tabId}')"]`)?.classList.add('active');
            document.getElementById('ce-tab-' + tabId)?.classList.add('active');

            // Load activity stream when tab is shown
            if (tabId === 'activity') {
                ceLoadActivityStream();
            }
            // Load style manager when style tab is shown
            if (tabId === 'style') {
                smLoadTheme();
            }
        };

        // ============================================
        // STYLE MANAGER - Theme System
        // ============================================

        // Default theme values
        const smDefaultTheme = {
            // Colors
            'theme-primary': '#1a1a1a',
            'theme-secondary': '#ffffff',
            'theme-accent': '#c8102e',
            'theme-background': '#ffffff',
            'theme-surface': '#f5f5f5',
            'theme-text': '#333333',
            'theme-text-muted': '#666666',
            'theme-border': '#e5e5e5',
            'theme-link': '#c8102e',
            'theme-link-hover': '#a00d24',
            // Palette - sensible defaults
            'palette-1': '#1a1a1a',   // Black - primary text
            'palette-2': '#ffffff',   // White - backgrounds
            'palette-3': '#c8102e',   // Red - accent/CTA
            'palette-4': '#2563eb',   // Blue - links
            'palette-5': '#16a34a',   // Green - success
            // Typography
            'font-heading': "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            'font-body': "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            'text-base-size': '16px',
            'text-scale-ratio': '1.25',
            'line-height-normal': '1.6',
            // Buttons
            'btn-border-radius': '0px',
            'btn-border-width': '2px',
            'btn-padding-x': '1.5rem',
            'btn-padding-y': '0.75rem',
            'btn-font-weight': '600',
            'btn-text-transform': 'none',
            'btn-primary-bg': '#1a1a1a',
            'btn-primary-text': '#ffffff',
            'btn-primary-border': '#1a1a1a',
            // Spacing
            'space-unit': '8px',
            'section-padding': '4vw',
            'section-padding-y': '4rem',
            'content-max-width': '1200px',
            // Header
            'header-bg': '#ffffff',
            'header-text': '#1a1a1a',
            'header-height': '72px',
            'header-position': 'fixed',
            'header-border': '1px solid var(--theme-border)',
            // Footer
            'footer-bg': '#c8102e',
            'footer-text': '#ffffff',
            // Effects
            'border-radius-sm': '4px',
            'border-radius-md': '8px',
            'border-radius-lg': '12px',
            'shadow-md': '0 4px 6px rgba(0,0,0,0.1)',
            'transition-normal': '0.2s ease',
            // Sections
            'section-light-bg': '#f5f5f5',
            'section-dark-bg': '#1a1a1a',
            'section-dark-text': '#ffffff'
        };

        // Theme presets
        const smThemePresets = {
            default: {
                'theme-primary': '#1a1a1a',
                'theme-secondary': '#ffffff',
                'theme-accent': '#c8102e',
                'theme-background': '#ffffff',
                'theme-text': '#333333',
                'btn-primary-bg': '#1a1a1a',
                'btn-primary-text': '#ffffff',
                'footer-bg': '#c8102e',
                'section-dark-bg': '#1a1a1a'
            },
            dark: {
                'theme-primary': '#ffffff',
                'theme-secondary': '#1a1a1a',
                'theme-accent': '#ff6b35',
                'theme-background': '#1a1a1a',
                'theme-text': '#e5e5e5',
                'btn-primary-bg': '#ffffff',
                'btn-primary-text': '#1a1a1a',
                'footer-bg': '#ff6b35',
                'section-dark-bg': '#0d0d0d',
                'section-light-bg': '#2a2a2a'
            },
            warm: {
                'theme-primary': '#2d3436',
                'theme-secondary': '#ffeaa7',
                'theme-accent': '#e17055',
                'theme-background': '#ffeaa7',
                'theme-text': '#2d3436',
                'btn-primary-bg': '#2d3436',
                'btn-primary-text': '#ffeaa7',
                'footer-bg': '#e17055',
                'section-dark-bg': '#2d3436',
                'section-light-bg': '#fff3cd'
            }
        };

        // Current theme state
        let smCurrentTheme = { ...smDefaultTheme };
        let smUnsavedChanges = false;

        // Load theme from API via DB.getSiteTheme()
        function smLoadTheme() {
            const savedTheme = DB.getSiteTheme();
            if (savedTheme && Object.keys(savedTheme).length > 0) {
                try {
                    smCurrentTheme = { ...smDefaultTheme, ...savedTheme };
                } catch (e) {
                    console.error('Error loading theme:', e);
                    smCurrentTheme = { ...smDefaultTheme };
                }
            }
            smApplyThemeToDOM();
            smUpdateFormValues();
            smRenderColorPalette();
            smUnsavedChanges = false;
            smUpdateSaveIndicator();
        }

        // Apply theme to DOM via CSS custom properties
        function smApplyThemeToDOM() {
            const root = document.documentElement;
            Object.entries(smCurrentTheme).forEach(([key, value]) => {
                root.style.setProperty(`--${key}`, value);
            });
            // Also apply to preview iframe if it exists
            const previewContent = document.getElementById('ce-preview-content');
            if (previewContent) {
                Object.entries(smCurrentTheme).forEach(([key, value]) => {
                    previewContent.style.setProperty(`--${key}`, value);
                });
            }
        }

        // Update form values to match current theme
        function smUpdateFormValues() {
            // Colors
            const colorInputs = [
                'theme-primary', 'theme-secondary', 'theme-accent', 'theme-background',
                'theme-text', 'theme-border', 'theme-link', 'theme-link-hover',
                'btn-primary-bg', 'btn-primary-text', 'header-bg', 'header-text',
                'footer-bg', 'footer-text', 'section-light-bg', 'section-dark-bg', 'section-dark-text'
            ];
            colorInputs.forEach(key => {
                const colorInput = document.getElementById(`sm-${key}`);
                const textInput = colorInput?.nextElementSibling;
                if (colorInput && smCurrentTheme[key]) {
                    colorInput.value = smCurrentTheme[key];
                    if (textInput) textInput.value = smCurrentTheme[key];
                }
            });

            // Fonts
            const fontHeading = document.getElementById('sm-font-heading');
            const fontBody = document.getElementById('sm-font-body');
            if (fontHeading) fontHeading.value = smCurrentTheme['font-heading'] || smDefaultTheme['font-heading'];
            if (fontBody) fontBody.value = smCurrentTheme['font-body'] || smDefaultTheme['font-body'];

            // Typography
            const baseSizeInput = document.getElementById('sm-text-base-size');
            const baseSizeValue = document.getElementById('sm-text-base-size-value');
            if (baseSizeInput) {
                const size = parseInt(smCurrentTheme['text-base-size']) || 16;
                baseSizeInput.value = size;
                if (baseSizeValue) baseSizeValue.textContent = size + 'px';
            }

            const lineHeightInput = document.getElementById('sm-line-height');
            const lineHeightValue = document.getElementById('sm-line-height-value');
            if (lineHeightInput) {
                const lh = parseFloat(smCurrentTheme['line-height-normal']) || 1.6;
                lineHeightInput.value = lh;
                if (lineHeightValue) lineHeightValue.textContent = lh;
            }

            // Button shape
            const btnRadius = parseInt(smCurrentTheme['btn-border-radius']) || 0;
            document.querySelectorAll('.sm-shape-option').forEach(opt => {
                opt.classList.remove('active');
                if (btnRadius === 0 && opt.querySelector('.square')) opt.classList.add('active');
                else if (btnRadius > 0 && btnRadius < 20 && opt.querySelector('.rounded')) opt.classList.add('active');
                else if (btnRadius >= 20 && opt.querySelector('.pill')) opt.classList.add('active');
            });

            // Range sliders
            smUpdateRangeDisplay('btn-border-width', 'px');
            smUpdateRangeDisplay('header-height', 'px');
            smUpdateRangeDisplay('section-padding', 'rem');
            smUpdateRangeDisplay('space-unit', 'px');
            smUpdateRangeDisplay('border-radius', 'px');
        }

        // Update range display value
        function smUpdateRangeDisplay(key, unit) {
            const input = document.getElementById(`sm-${key}`);
            const display = document.getElementById(`sm-${key}-value`);
            if (input && display) {
                const value = parseFloat(smCurrentTheme[key]) || parseFloat(input.value);
                display.textContent = value + unit;
            }
        }

        // Render color palette swatches
        function smRenderColorPalette() {
            const container = document.getElementById('sm-color-palette');
            if (!container) return;

            const paletteColors = [
                smCurrentTheme['palette-1'] || '#1a1a1a',
                smCurrentTheme['palette-2'] || '#ffffff',
                smCurrentTheme['palette-3'] || '#c8102e',
                smCurrentTheme['palette-4'] || '#2563eb',
                smCurrentTheme['palette-5'] || '#16a34a'
            ];

            container.innerHTML = paletteColors.map((color, i) => `
                <div class="sm-color-swatch" style="background: ${color}"
                     onclick="smEditPaletteColor(${i})" data-color="${color}">
                    <button class="edit-btn" onclick="event.stopPropagation(); smEditPaletteColor(${i})"></button>
                </div>
            `).join('') + `
                <div class="sm-color-swatch" style="background: var(--gray-100); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--gray-400);"
                     onclick="smAddPaletteColor()">+</div>
            `;
        }

        // Color Picker State
        let colorPickerCallback = null;
        let colorPickerCurrentColor = '#000000';

        // Preset colors for the color picker
        const colorPickerPresets = [
            // Row 1: Grays
            '#000000', '#434343', '#666666', '#999999', '#b7b7b7', '#cccccc', '#d9d9d9', '#ffffff',
            // Row 2: Warm colors
            '#980000', '#ff0000', '#ff9900', '#ffff00', '#00ff00', '#00ffff', '#4a86e8', '#0000ff',
            // Row 3: Cool/accent colors
            '#9900ff', '#ff00ff', '#e6b8af', '#f4cccc', '#fce5cd', '#fff2cc', '#d9ead3', '#d0e0e3',
            // Row 4: Muted/earth tones
            '#c9daf8', '#cfe2f3', '#d9d2e9', '#ead1dc', '#dd7e6b', '#ea9999', '#f9cb9c', '#ffe599'
        ];

        // Open color picker modal
        function openColorPicker(currentColor, callback) {
            colorPickerCallback = callback;
            colorPickerCurrentColor = currentColor || '#000000';

            // Set initial values
            document.getElementById('color-picker-preview').style.background = colorPickerCurrentColor;
            document.getElementById('color-picker-native').value = colorPickerCurrentColor;
            document.getElementById('color-picker-hex').value = colorPickerCurrentColor.toUpperCase();

            // Render preset colors
            const presetsContainer = document.getElementById('color-picker-presets');
            presetsContainer.innerHTML = colorPickerPresets.map(color => `
                <div class="color-preset" style="background: ${color}"
                     onclick="selectColorPreset('${color}')" title="${color}"></div>
            `).join('');

            // Show modal
            document.getElementById('color-picker-modal').classList.add('active');
        }

        // Close color picker modal
        function closeColorPicker() {
            document.getElementById('color-picker-modal').classList.remove('active');
            colorPickerCallback = null;
        }

        // Update from native color picker
        function updateColorFromPicker(color) {
            colorPickerCurrentColor = color;
            document.getElementById('color-picker-preview').style.background = color;
            document.getElementById('color-picker-hex').value = color.toUpperCase();
        }

        // Update from hex input
        function updateColorFromHex(value) {
            let hex = value.trim();
            if (!hex.startsWith('#')) hex = '#' + hex;
            if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                colorPickerCurrentColor = hex;
                document.getElementById('color-picker-preview').style.background = hex;
                document.getElementById('color-picker-native').value = hex;
            }
        }

        // Select preset color
        function selectColorPreset(color) {
            colorPickerCurrentColor = color;
            document.getElementById('color-picker-preview').style.background = color;
            document.getElementById('color-picker-native').value = color;
            document.getElementById('color-picker-hex').value = color.toUpperCase();
        }

        // Confirm color selection
        function confirmColorPicker() {
            if (colorPickerCallback) {
                colorPickerCallback(colorPickerCurrentColor);
            }
            closeColorPicker();
        }

        // Edit palette color (using color picker modal)
        function smEditPaletteColor(index) {
            const key = `palette-${index + 1}`;
            const currentColor = smCurrentTheme[key] || '#000000';

            openColorPicker(currentColor, (newColor) => {
                if (newColor && /^#[0-9A-Fa-f]{6}$/i.test(newColor)) {
                    smUpdateThemeValue(key, newColor.toLowerCase());
                    smRenderColorPalette();
                }
            });
        }

        // Add palette color (up to 10)
        function smAddPaletteColor() {
            for (let i = 1; i <= 10; i++) {
                if (!smCurrentTheme[`palette-${i}`]) {
                    // Open color picker for new color
                    openColorPicker('#666666', (newColor) => {
                        if (newColor) {
                            smCurrentTheme[`palette-${i}`] = newColor.toLowerCase();
                            smRenderColorPalette();
                        }
                    });
                    break;
                }
            }
        }

        // Update a single theme value
        function smUpdateThemeValue(key, value, skipActivityStream = false) {
            const oldValue = smCurrentTheme[key];
            if (oldValue === value) return;

            smCurrentTheme[key] = value;
            document.documentElement.style.setProperty(`--${key}`, value);

            // Apply to preview
            const previewContent = document.getElementById('ce-preview-content');
            if (previewContent) {
                previewContent.style.setProperty(`--${key}`, value);
            }

            // Log to activity stream
            if (!skipActivityStream) {
                DB.altRecord('site_theme', 'theme_config', key, oldValue || '', value, 'admin');
                Webhooks.log('theme_update', {
                    access_type: 'style',
                    field: key,
                    old_value: oldValue,
                    new_value: value
                });
            }

            // Mark as unsaved and save
            smUnsavedChanges = true;
            smUpdateSaveIndicator();
            smSaveTheme();

            // Re-render preview
            ceRenderPreview();
        }

        // Save theme to localStorage and API
        async function smSaveTheme() {
            // Save to API and localStorage via DB
            await DB.setSiteTheme(smCurrentTheme);
            smUnsavedChanges = false;
            smUpdateSaveIndicator();
        }

        // Update save indicator
        function smUpdateSaveIndicator() {
            const indicator = document.getElementById('sm-save-indicator');
            if (indicator) {
                if (smUnsavedChanges) {
                    indicator.classList.add('unsaved');
                    indicator.querySelector('span:last-child').textContent = 'Unsaved changes';
                } else {
                    indicator.classList.remove('unsaved');
                    indicator.querySelector('span:last-child').textContent = 'All changes saved';
                }
            }
        }

        // Toggle accordion
        function smToggleAccordion(header) {
            const accordion = header.closest('.sm-accordion');
            accordion.classList.toggle('open');
        }

        // Update color from color picker
        function smUpdateColor(key, value) {
            smUpdateThemeValue(key, value);
            // Sync text input
            const colorInput = document.getElementById(`sm-${key}`);
            if (colorInput) {
                const textInput = colorInput.nextElementSibling;
                if (textInput) textInput.value = value;
            }
        }

        // Update color from text input
        function smUpdateColorFromText(key, value) {
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                smUpdateThemeValue(key, value);
                // Sync color picker
                const textInput = event.target;
                const colorInput = textInput.previousElementSibling;
                if (colorInput) colorInput.value = value;
            }
        }

        // Update font
        function smUpdateFont(type, value) {
            smUpdateThemeValue(`font-${type}`, value);
            // Update preview
            if (type === 'heading') {
                const preview = document.getElementById('sm-font-heading-preview');
                if (preview) {
                    preview.querySelector('.sample').style.fontFamily = value;
                }
            }
        }

        // Update size/numeric value
        function smUpdateSize(key, value) {
            smUpdateThemeValue(key, value);
            // Update display
            const display = document.getElementById(`sm-${key}-value`);
            if (display) display.textContent = value;
        }

        // Set button shape
        function smSetButtonShape(shape, element) {
            document.querySelectorAll('.sm-shape-option').forEach(opt => opt.classList.remove('active'));
            element.classList.add('active');

            let radius;
            switch (shape) {
                case 'square': radius = '0px'; break;
                case 'rounded': radius = '6px'; break;
                case 'pill': radius = '9999px'; break;
                default: radius = '0px';
            }
            smUpdateThemeValue('btn-border-radius', radius);
        }

        // Toggle switch
        function smToggleSwitch(element, key) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');

            if (key === 'header-position') {
                smUpdateThemeValue('header-position', isActive ? 'fixed' : 'static');
            } else if (key === 'header-border') {
                smUpdateThemeValue('header-border', isActive ? '1px solid var(--theme-border)' : 'none');
            }
        }

        // Apply theme preset
        function smApplyPreset(presetName) {
            const preset = smThemePresets[presetName];
            if (!preset) return;

            // Update preset card UI
            document.querySelectorAll('.sm-preset-card').forEach(card => card.classList.remove('active'));
            event.target.closest('.sm-preset-card').classList.add('active');

            // Apply preset values (log as single bulk change)
            const changes = [];
            Object.entries(preset).forEach(([key, value]) => {
                if (smCurrentTheme[key] !== value) {
                    changes.push({ field: key, oldValue: smCurrentTheme[key], newValue: value });
                    smCurrentTheme[key] = value;
                    document.documentElement.style.setProperty(`--${key}`, value);
                }
            });

            // Log preset application to activity stream
            if (changes.length > 0) {
                DB.altRecord('site_theme', 'theme_config', 'preset', '', presetName, 'admin');
                Webhooks.log('theme_preset_applied', {
                    access_type: 'style',
                    preset: presetName,
                    changes: changes.length
                });
            }

            smApplyThemeToDOM();
            smUpdateFormValues();
            smSaveTheme();
            ceRenderPreview();
            ceShowToast(`Applied "${presetName}" theme preset`, 'success');
        }

        // Update shadow intensity
        function smUpdateShadow(intensity) {
            let shadows = {
                none: { sm: 'none', md: 'none', lg: 'none' },
                subtle: { sm: '0 1px 2px rgba(0,0,0,0.03)', md: '0 2px 4px rgba(0,0,0,0.05)', lg: '0 4px 8px rgba(0,0,0,0.08)' },
                medium: { sm: '0 1px 2px rgba(0,0,0,0.05)', md: '0 4px 6px rgba(0,0,0,0.1)', lg: '0 10px 15px rgba(0,0,0,0.1)' },
                strong: { sm: '0 2px 4px rgba(0,0,0,0.1)', md: '0 6px 12px rgba(0,0,0,0.15)', lg: '0 15px 30px rgba(0,0,0,0.2)' }
            };
            const s = shadows[intensity] || shadows.medium;
            smUpdateThemeValue('shadow-sm', s.sm);
            smUpdateThemeValue('shadow-md', s.md);
            smUpdateThemeValue('shadow-lg', s.lg);
        }

        // Update transition speed
        function smUpdateTransition(speed) {
            smUpdateThemeValue('transition-fast', speed === '0s' ? '0s' : `calc(${speed} * 0.75) ease`);
            smUpdateThemeValue('transition-normal', `${speed} ease`);
            smUpdateThemeValue('transition-slow', speed === '0s' ? '0s' : `calc(${speed} * 1.5) ease`);
        }

        // Initialize Style Manager on page load
        // Note: Main theme load from API happens in the primary DOMContentLoaded handler
        // This handles quick initial load from localStorage cache while API loads
        document.addEventListener('DOMContentLoaded', function() {
            // Quick load from localStorage first (API data will override in main init)
            const savedTheme = localStorage.getItem('siteTheme');
            if (savedTheme) {
                try {
                    smCurrentTheme = { ...smDefaultTheme, ...JSON.parse(savedTheme) };
                    smApplyThemeToDOM();
                } catch (e) {
                    console.error('Error loading theme on init:', e);
                }
            }
        });

    </script>
</body>
</html>
